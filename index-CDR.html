
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Drop Report</title>
    
    <!-- PWA and Mobile App Manifest -->
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1d4ed8/ffffff?text=J-CDR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashDrop">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhc2ggRHJvcCBSZXBvcnQiLAogICJzaG9ydF9uYW1lIjogIkNhc2hEcm9wIiwKICAiaWQiOiAiLz9zb3VyY2U9cHdhIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzaW1wbGUgYXBwIGZvciByZXBvcnRpbmcgZGFpbHkgY2FzaCBkcm9wcy4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZDRlZDgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzFkNGVkOC9mZmZmZmY/dGV4dD1DRFIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi8xZDRlZDgvZmZmZmZmP3RleHQ9Q0RSIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel (with defer for faster initial paint) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>

    <!-- Firebase SDKs (module scripts are deferred by default) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence,
            getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, limit, getDocs, startAfter
        };
    </script>
    
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

    <style>
        body {
            background-color: #f1f5f9; /* slate-100 */
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

        /******************************************************************************
         * CONFIGURATION
         *****************************************************************************/
        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };
        const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/23884137/uuoijzq/';
        const DEFAULT_EXCHANGE_RATE = 4000;
        const REPORTS_PER_PAGE = 25;

        /******************************************************************************
         * CONTEXT & PROVIDERS
         *****************************************************************************/
        const AppContext = createContext();
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const app = window.firebase.initializeApp(firebaseConfig);
                const firebaseAuth = window.firebase.getAuth(app);
                const firestoreDb = window.firebase.getFirestore(app);
                setAuth(firebaseAuth);
                setDb(firestoreDb);

                const unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = window.firebase.doc(firestoreDb, 'employees', firebaseUser.uid);
                        const userDoc = await window.firebase.getDoc(userDocRef);
                        if (userDoc.exists()) {
                            setUser(firebaseUser);
                            setUserData({ uid: firebaseUser.uid, ...userDoc.data() });
                            setAuthError(null);
                        } else {
                            console.error(`User document not found for UID: ${firebaseUser.uid}`);
                            await window.firebase.signOut(firebaseAuth);
                            setAuthError({
                                type: 'missing_profile',
                                message: `Your employee profile was not found. Please contact an administrator.`
                            });
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const login = async (email, password, rememberMe) => {
                const persistence = rememberMe 
                    ? window.firebase.browserLocalPersistence 
                    : window.firebase.browserSessionPersistence;
                await window.firebase.setPersistence(auth, persistence);
                return window.firebase.signInWithEmailAndPassword(auth, email, password);
            };

            const logout = () => window.firebase.signOut(auth);

            const value = { user, userData, login, logout, db, loading, authError, setAuthError };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };

        const AppProvider = ({ children }) => {
            const { db } = useAuth();
            const [shops, setShops] = useState([]);
            const [reports, setReports] = useState([]);
            const [isShopsLoading, setIsShopsLoading] = useState(true);
            const [lastVisible, setLastVisible] = useState(null);
            const [hasMore, setHasMore] = useState(true);
            const [isFetchingMore, setIsFetchingMore] = useState(false);

            // Initial data load
            useEffect(() => {
                if (!db) return;
                
                const reportsRef = window.firebase.collection(db, "cashDrops");
                const q = window.firebase.query(reportsRef, window.firebase.orderBy("createdAt", "desc"), window.firebase.limit(REPORTS_PER_PAGE));

                const unsubReports = window.firebase.onSnapshot(q, (snapshot) => {
                    const newReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setReports(newReports);
                    setLastVisible(snapshot.docs[snapshot.docs.length - 1]);
                    setHasMore(newReports.length === REPORTS_PER_PAGE);
                }, (err) => console.error("Error fetching reports:", err));
                
                const unsubShops = window.firebase.onSnapshot(window.firebase.collection(db, "shops"), (snapshot) => {
                    setShops(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsShopsLoading(false);
                }, (err) => {
                    console.error("Error fetching shops:", err);
                    setIsShopsLoading(false);
                });

                return () => {
                    unsubReports();
                    unsubShops();
                };
            }, [db]);

            const loadMoreReports = async () => {
                if (!db || !lastVisible || !hasMore) return;
                setIsFetchingMore(true);

                const reportsRef = window.firebase.collection(db, "cashDrops");
                const q = window.firebase.query(
                    reportsRef, 
                    window.firebase.orderBy("createdAt", "desc"), 
                    window.firebase.startAfter(lastVisible),
                    window.firebase.limit(REPORTS_PER_PAGE)
                );

                try {
                    const documentSnapshots = await window.firebase.getDocs(q);
                    const newReports = documentSnapshots.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    setReports(prevReports => [...prevReports, ...newReports]);
                    setLastVisible(documentSnapshots.docs[documentSnapshots.docs.length - 1]);
                    setHasMore(newReports.length === REPORTS_PER_PAGE);
                } catch (error) {
                    console.error("Error loading more reports:", error);
                } finally {
                    setIsFetchingMore(false);
                }
            };

            const value = { shops, reports, isShopsLoading, appSettings: { exchangeRate: DEFAULT_EXCHANGE_RATE }, loadMoreReports, hasMore, isFetchingMore };
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };
        
        const useAppContext = () => useContext(AppContext);
        const useAuth = () => useContext(AuthContext);

        /******************************************************************************
         * UTILITY FUNCTIONS
         *****************************************************************************/
        const formatCurrency = (value, currency) => {
            const number = parseFloat(String(value).replace(/,/g, '')) || 0;
            const formattedNumber = number.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            if (currency === 'KHR') return `${formattedNumber} ៛`;
            if (currency === 'USD') return `${formattedNumber} $`;
            return formattedNumber;
        };
        
        const formatDateDDMMYY = (date) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2);
            return `${day}-${month}-${year}`;
        };

        /******************************************************************************
         * REUSABLE UI COMPONENTS
         *****************************************************************************/
        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            const icons = {
                loader: <svg className={`${className} animate-spin`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                note: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>,
                trash: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                logout: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V9" /></svg>,
                eye: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                'eye-off': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>,
                install: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
                export: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
            };
            return icons[name] || null;
        });

        const FormInput = React.memo(({ label, name, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input id={name} name={name} {...props} className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-100" />
            </div>
        ));

        const FormSelect = React.memo(({ label, name, options, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <select id={name} name={name} {...props} className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                </select>
            </div>
        ));
        
        const Modal = ({ children, onClose, isOpen }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 transition-opacity" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        };

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-screen">
                <Icon name="loader" className="w-12 h-12 text-blue-600" />
            </div>
        );

        const SubmitConfirmationModal = ({ onConfirm, onClose, isSubmitting }) => (
            <Modal isOpen={true} onClose={onClose}>
                <div className="p-6">
                    <h3 className="text-lg font-bold text-gray-900">បញ្ជាក់ការបញ្ជូនរបាយការណ៍</h3>
                    <p className="mt-2 text-sm text-gray-600">សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន ត្រឹមត្រូវហើយ?</p>
                </div>
                <div className="bg-gray-50 px-6 py-3 flex justify-end items-center gap-3">
                    <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">បោះបង់</button>
                    <button onClick={onConfirm} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                        {isSubmitting && <Icon name="loader" className="w-4 h-4" />}
                        បាទ​/ចាស៎
                    </button>
                </div>
            </Modal>
        );
        
        const DeleteConfirmationModal = ({ onConfirm, onClose, isSubmitting, isOpen }) => (
            <Modal isOpen={isOpen} onClose={onClose}>
                <div className="p-6">
                    <h3 className="text-lg font-bold text-gray-900">Confirm Deletion</h3>
                    <p className="mt-2 text-sm text-gray-600">Are you sure you want to delete this report? This action cannot be undone.</p>
                </div>
                <div className="bg-gray-50 px-6 py-3 flex justify-end items-center gap-3">
                    <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">Cancel</button>
                    <button onClick={onConfirm} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 disabled:opacity-50 flex items-center gap-2">
                        {isSubmitting && <Icon name="loader" className="w-4 h-4" />}
                        Delete
                    </button>
                </div>
            </Modal>
        );
        
        const CustomDateRangeModal = ({ isOpen, onClose, onApply }) => {
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const handleApply = () => {
                onApply({ startDate, endDate });
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="p-6">
                        <h3 className="text-lg font-bold text-gray-900">Select Custom Date Range</h3>
                        <div className="mt-4 space-y-4">
                            <FormInput label="Start Date" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
                            <FormInput label="End Date" type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                    </div>
                    <div className="bg-gray-50 px-6 py-3 flex justify-end items-center gap-3">
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button onClick={handleApply} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">Apply</button>
                    </div>
                </Modal>
            );
        };
        
        const CurrencyInputGroup = React.memo(({ title, khrName, usdName, khrValue, usdValue, onChange }) => (
            <div>
                <h3 className="text-md font-semibold text-slate-600">{title}</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                    <FormInput label="KHR (៛)" name={khrName} value={khrValue} onChange={onChange} placeholder="0.00" />
                    <FormInput label="USD ($)" name={usdName} value={usdValue} onChange={onChange} placeholder="0.00" />
                </div>
            </div>
        ));

        const EditReportModal = ({ isOpen, onClose, onSave, report, isSubmitting, shops }) => {
            const [formData, setFormData] = useState(report);
            const formRef = useRef(null);
            
            useEffect(() => {
                setFormData({
                    ...report,
                    cashUsd: String(report.cashUsd || ''),
                    cashKhr: String(report.cashKhr || ''),
                    bankUsd: String(report.bankUsd || ''),
                    bankKhr: String(report.bankKhr || ''),
                    note: report.note || '',
                });
            }, [report]);

            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleCurrencyChange = useCallback((e) => {
                const { name, value } = e.target;
                
                if (!value) {
                    setFormData(prev => ({ ...prev, [name]: '' }));
                    return;
                }

                const cleanedValue = value.replace(/[^0-9.]/g, '');
                const parts = cleanedValue.split('.');
                const integerPart = parts[0];
                const decimalPart = parts[1];
                const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                let formattedValue = formattedInteger;
                if (decimalPart !== undefined) {
                    formattedValue += '.' + decimalPart;
                } else if (value.endsWith('.')) {
                    formattedValue += '.';
                }
                
                setFormData(prev => ({ ...prev, [name]: formattedValue }));
            }, []);

            const handleSave = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const triggerSubmit = () => {
                formRef.current.requestSubmit();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="p-6 border-b sticky top-0 bg-white z-10">
                        <h3 className="text-lg font-bold text-gray-900">Edit Report</h3>
                    </div>
                    <div className="flex-grow overflow-y-auto">
                        <form ref={formRef} onSubmit={handleSave} className="p-6 space-y-4">
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                            <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormInput label="Staff" name="staff" value={formData.staff} disabled />
                            <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                            <CurrencyInputGroup title="By Cash" khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleCurrencyChange} />
                            <CurrencyInputGroup title="By Bank" khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleCurrencyChange} />
                            <FormInput label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="Add an optional note..."/>
                        </form>
                    </div>
                    <div className="bg-gray-50 px-6 py-3 flex justify-end items-center gap-3 border-t sticky bottom-0">
                        <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="button" onClick={triggerSubmit} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                            {isSubmitting && <Icon name="loader" className="w-4 h-4" />}
                            Save Changes
                        </button>
                    </div>
                </Modal>
            );
        };

        /******************************************************************************
         * PAGES
         *****************************************************************************/
        const LoginPage = () => {
            const { login, authError, setAuthError } = useAuth();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);

            useEffect(() => {
                if (authError) {
                    setError(authError);
                    setAuthError(null);
                }
            }, [authError, setAuthError]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    await login(email, password, rememberMe);
                } catch (err) {
                    setError({ type: 'login_failed', message: 'Failed to log in. Please check your email and password.' });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex justify-center items-center min-h-screen w-full p-4">
                    <div className="w-full max-w-md">
                        <div className="p-8 space-y-6 bg-white rounded-xl shadow-lg">
                            <div className="text-center">
                                <h2 className="text-2xl font-bold text-slate-800">JLW Cash Drop</h2>
                                <p className="mt-2 text-sm text-slate-600">This application is for Internal Cashier Use ONLY!</p>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-6 !mt-8">
                                <FormInput label="Email" name="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                                <div className="relative">
                                    <FormInput label="Password" name="password" type={showPassword ? 'text' : 'password'} value={password} onChange={e => setPassword(e.target.value)} required />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                                        {showPassword ? <Icon name="eye-off" /> : <Icon name="eye" />}
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center">
                                        <input id="remember-me" name="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"/>
                                        <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">Remember me</label>
                                    </div>
                                </div>
                                {error && <p className="text-red-500 text-sm text-center">{error.message}</p>}
                                <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50">
                                    {loading ? <Icon name="loader" /> : 'Log In'}
                                </button>
                            </form>
                        </div>
                        {error?.type === 'missing_profile' && (
                            <div className="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow">
                                <h3 className="font-bold">Administrator Tip: Missing Employee Profile</h3>
                                <p className="text-sm mt-2">Go to your Firestore database and create a document in the <strong>`employees`</strong> collection. The Document ID must match the user's Authentication UID.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CashDropPage = () => {
            const { userData } = useAuth();
            const { isShopsLoading } = useAppContext();

            if (isShopsLoading || !userData) return <LoadingSpinner />;

            return (
                <div className="space-y-8">
                    <NewCashDropForm />
                    {userData?.role !== 'Cashier' && <ReportsDashboard />}
                </div>
            );
        };

        /******************************************************************************
         * PAGE COMPONENTS
         *****************************************************************************/
        const NewCashDropForm = () => {
            const { shops, appSettings } = useAppContext();
            const { db, userData } = useAuth();
            
            const getInitialState = useCallback(() => {
                const defaultShop = (userData?.role === 'Admin' || userData?.role === 'Management') 
                    ? (shops[0]?.name || '') 
                    : (shops.find(s => userData?.shopIds?.includes(s.id))?.name || '');
                return {
                    date: new Date().toISOString().split('T')[0], shop: defaultShop, staff: userData?.name || '',
                    shift: 'Morning', cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', note: '',
                }
            }, [shops, userData]);

            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);

            useEffect(() => { setFormData(getInitialState()) }, [shops, userData, getInitialState]);
            
            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);
            
            const handleCurrencyChange = useCallback((e) => {
                const { name, value } = e.target;
                
                if (!value) {
                    setFormData(prev => ({ ...prev, [name]: '' }));
                    return;
                }

                const cleanedValue = value.replace(/[^0-9.]/g, '');
                const parts = cleanedValue.split('.');
                const integerPart = parts[0];
                const decimalPart = parts[1];
                const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                let formattedValue = formattedInteger;
                if (decimalPart !== undefined) {
                    formattedValue += '.' + decimalPart;
                } else if (value.endsWith('.')) {
                    formattedValue += '.';
                }
                
                setFormData(prev => ({ ...prev, [name]: formattedValue }));
            }, []);

            const grandTotal = useMemo(() => {
                const { cashUsd, cashKhr, bankUsd, bankKhr } = formData;
                const exchangeRate = appSettings.exchangeRate || 4000;
                const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                return (clean(cashUsd) + clean(bankUsd)) * exchangeRate + clean(cashKhr) + clean(bankKhr);
            }, [formData, appSettings.exchangeRate]);

            const handleConfirmSubmit = useCallback(async () => {
                setIsSubmitting(true);
                const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                const reportData = {
                    ...formData,
                    cashUsd: clean(formData.cashUsd), cashKhr: clean(formData.cashKhr),
                    bankUsd: clean(formData.bankUsd), bankKhr: clean(formData.bankKhr),
                    grandTotalKhr: grandTotal,
                    createdAt: window.firebase.Timestamp.fromDate(new Date()),
                    submittedBy: userData.uid
                };

                try {
                    // 1. Save to Firebase
                    await window.firebase.addDoc(window.firebase.collection(db, "cashDrops"), reportData);
                    
                    // 2. Send to Zapier with formatted currency
                    const zapierPayload = {
                        report: {
                            date: reportData.date,
                            shop: reportData.shop,
                            staff: reportData.staff,
                            shift: reportData.shift,
                            cashUsd: formatCurrency(reportData.cashUsd, 'USD'),
                            cashKhr: formatCurrency(reportData.cashKhr, 'KHR'),
                            bankUsd: formatCurrency(reportData.bankUsd, 'USD'),
                            bankKhr: formatCurrency(reportData.bankKhr, 'KHR'),
                            note: reportData.note,
                            grandTotalKhr: formatCurrency(reportData.grandTotalKhr, 'KHR'),
                            submittedByName: userData.name,
                            submittedAt: new Date().toISOString()
                        }
                    };

                    try {
                        await fetch(ZAPIER_WEBHOOK_URL, {
                            method: 'POST',
                            mode: 'no-cors', // To prevent CORS errors
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(zapierPayload),
                        });
                    } catch (zapierError) {
                        console.error('Error sending data to Zapier:', zapierError);
                    }

                    // 3. Reset form
                    setFormData(getInitialState());

                } catch (error) {
                    console.error("Error submitting cash drop:", error);
                } finally {
                    setIsSubmitting(false);
                    setIsConfirming(false);
                }
            }, [formData, grandTotal, userData, db, getInitialState]);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData?.role === 'Admin' || userData?.role === 'Management') return shops;
                return shops.filter(s => userData?.shopIds?.includes(s.id));
            }, [shops, userData]);

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg space-y-6">
                            <h2 className="text-xl font-bold text-slate-800">New Cash Drop Form</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                                <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormInput label="Staff" name="staff" value={formData.staff} disabled className="bg-gray-100"/>
                                <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                            </div>
                            <div className="space-y-4 pt-4 border-t">
                                <CurrencyInputGroup title="By Cash" khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleCurrencyChange} />
                                <CurrencyInputGroup title="By Bank" khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleCurrencyChange} />
                            </div>
                            <FormInput label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="Add an optional note..."/>
                        </div>
                        <SummaryCard formData={formData} grandTotal={grandTotal} isSubmitting={isSubmitting} />
                    </form>
                    {isConfirming && <SubmitConfirmationModal onClose={() => setIsConfirming(false)} onConfirm={handleConfirmSubmit} isSubmitting={isSubmitting} />}
                </>
            );
        };
        
        const SummaryCard = React.memo(({ formData, grandTotal, isSubmitting }) => (
             <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-4 lg:sticky top-24">
                <h3 className="text-xl font-bold text-slate-800">Summary</h3>
                <div className="space-y-3 text-md">
                    <div className="flex justify-between items-center"><span className="text-slate-600">Cash KHR :</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.cashKhr, 'KHR')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-600">Cash USD :</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.cashUsd, 'USD')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-600">Bank KHR :</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.bankKhr, 'KHR')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-600">Bank USD :</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.bankUsd, 'USD')}</span></div>
                </div>
                <div className="border-t border-slate-200 !my-4"></div>
                <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-lg">Grand Total :</span>
                    <span className="font-extrabold text-red-600 text-2xl">{formatCurrency(grandTotal, 'KHR')}</span>
                </div>
                <button type="submit" disabled={isSubmitting} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center !mt-6 disabled:bg-blue-300 disabled:cursor-not-allowed">
                    {isSubmitting ? <Icon name="loader" /> : 'Submit Report'}
                </button>
            </div>
        ));

        /******************************************************************************
         * REPORTS DASHBOARD & SUB-COMPONENTS
         *****************************************************************************/
        const ReportsDashboard = () => {
            const { reports, shops, appSettings, loadMoreReports, hasMore, isFetchingMore } = useAppContext();
            const { db } = useAuth();
            const [filters, setFilters] = useState({ shop: '', dueTime: 'Daily', startDate: '', endDate: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isCustomDateModalOpen, setIsCustomDateModalOpen] = useState(false);

            const [reportToEdit, setReportToEdit] = useState(null);
            const [reportToDelete, setReportToDelete] = useState(null);

            const handleEditClick = (report) => setReportToEdit(report);
            const handleDeleteClick = (report) => setReportToDelete(report);

            // Create a color map for shops to highlight rows
            const shopColorMap = useMemo(() => {
                if (!shops) return {};
                const colors = [
                    { base: 'bg-blue-50', hover: 'hover:bg-blue-100' },
                    { base: 'bg-green-50', hover: 'hover:bg-green-100' },
                    { base: 'bg-yellow-50', hover: 'hover:bg-yellow-100' },
                    { base: 'bg-pink-50', hover: 'hover:bg-pink-100' },
                    { base: 'bg-indigo-50', hover: 'hover:bg-indigo-100' },
                    { base: 'bg-teal-50', hover: 'hover:bg-teal-100' },
                ];
                const map = {};
                shops.forEach((shop, index) => {
                    map[shop.name] = colors[index % colors.length];
                });
                return map;
            }, [shops]);

            const handleConfirmDelete = async () => {
                if (!reportToDelete) return;
                setIsSubmitting(true);
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(db, "cashDrops", reportToDelete.id));
                    setReportToDelete(null);
                } catch (error) {
                    console.error("Error deleting report:", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleSaveEdit = async (editedData) => {
                if (!reportToEdit) return;
                setIsSubmitting(true);
                try {
                    const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                    const grandTotal = (clean(editedData.cashUsd) + clean(editedData.bankUsd)) * appSettings.exchangeRate + clean(editedData.cashKhr) + clean(editedData.bankKhr);

                    const reportRef = window.firebase.doc(db, "cashDrops", reportToEdit.id);
                    await window.firebase.updateDoc(reportRef, {
                        ...editedData,
                        cashUsd: clean(editedData.cashUsd),
                        cashKhr: clean(editedData.cashKhr),
                        bankUsd: clean(editedData.bankUsd),
                        bankKhr: clean(editedData.bankKhr),
                        grandTotalKhr: grandTotal,
                    });
                    setReportToEdit(null);
                } catch (error) {
                    console.error("Error updating report:", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const filteredAndAggregatedData = useMemo(() => {
                if (!reports) return null;

                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(startOfDay);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const startOfYear = new Date(now.getFullYear(), 0, 1);

                let filtered = reports;

                if (filters.dueTime === 'Daily') {
                    if (filters.startDate && filters.endDate) {
                        const start = new Date(filters.startDate);
                        const end = new Date(filters.endDate);
                        end.setHours(23, 59, 59, 999);
                        filtered = reports.filter(r => {
                            const reportDate = r.createdAt?.toDate();
                            return reportDate >= start && reportDate <= end;
                        });
                    } else {
                        // Daily view without custom dates shows all loaded reports
                    }
                } else if (filters.dueTime === 'Monthly') {
                    filtered = reports.filter(r => r.createdAt?.toDate() >= startOfMonth);
                } else if (filters.dueTime === 'Yearly') {
                    filtered = reports.filter(r => r.createdAt?.toDate() >= startOfYear);
                } else if (filters.dueTime === 'Custom' && filters.startDate && filters.endDate) {
                    const start = new Date(filters.startDate);
                    const end = new Date(filters.endDate);
                    end.setHours(23, 59, 59, 999);
                    filtered = reports.filter(r => {
                        const reportDate = r.createdAt?.toDate();
                        return reportDate >= start && reportDate <= end;
                    });
                }

                if (filters.shop) {
                    filtered = filtered.filter(r => r.shop === filters.shop);
                }
                
                if (filters.dueTime === 'Daily' || filters.dueTime === 'Custom') {
                    return { type: 'detailed', data: filtered };
                }

                const aggregationKeyFormat = {
                    'Monthly': (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    'Yearly': (date) => `${date.getFullYear()}`
                };

                const getPeriodLabel = {
                    'Monthly': (date) => date.toLocaleString('default', { month: 'short', year: 'numeric' }),
                    'Yearly': (date) => date.getFullYear().toString()
                };

                const aggregated = filtered.reduce((acc, report) => {
                    const period = aggregationKeyFormat[filters.dueTime](report.createdAt.toDate());
                    const key = `${period}|${report.shop}`;
                    
                    if (!acc[key]) {
                        acc[key] = {
                            period: getPeriodLabel[filters.dueTime](report.createdAt.toDate()),
                            shop: report.shop,
                            cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0
                        };
                    }
                    
                    acc[key].cashUsd += report.cashUsd || 0;
                    acc[key].cashKhr += report.cashKhr || 0;
                    acc[key].bankUsd += report.bankUsd || 0;
                    acc[key].bankKhr += report.bankKhr || 0;
                    acc[key].grandTotalKhr += report.grandTotalKhr || 0;

                    return acc;
                }, {});

                return { type: 'aggregated', data: Object.values(aggregated) };

            }, [reports, filters]);

            const totals = useMemo(() => {
                if (!filteredAndAggregatedData?.data) return { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, netSale: 0 };
                return filteredAndAggregatedData.data.reduce((acc, r) => { 
                    acc.cashUsd += r.cashUsd || 0; acc.cashKhr += r.cashKhr || 0; 
                    acc.bankUsd += r.bankUsd || 0; acc.bankKhr += r.bankKhr || 0; 
                    acc.netSale += r.grandTotalKhr || 0; 
                    return acc; 
                }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, netSale: 0 })
            }, [filteredAndAggregatedData]);
            
            const handleExport = () => {
                if (!filteredAndAggregatedData?.data) return;

                const dataToExport = filteredAndAggregatedData.data.map(row => {
                    if (filteredAndAggregatedData.type === 'detailed') {
                        const base = {
                            'Date': formatDateDDMMYY(row.createdAt),
                            'Shop': row.shop,
                            'Cash KHR': row.cashKhr,
                            'Cash USD': row.cashUsd,
                            'Bank KHR': row.bankKhr,
                            'Bank USD': row.bankUsd,
                            'Net Sale (KHR)': row.grandTotalKhr
                        };
                        if (filters.dueTime !== 'Custom') {
                            base['Staff'] = row.staff;
                            base['Shift'] = row.shift;
                        }
                        return base;
                    } else { // aggregated
                        return {
                            [filters.dueTime]: row.period,
                            'Shop': row.shop,
                            'Cash KHR': row.cashKhr,
                            'Cash USD': row.cashUsd,
                            'Bank KHR': row.bankKhr,
                            'Bank USD': row.bankUsd,
                            'Net Sale (KHR)': row.grandTotalKhr
                        };
                    }
                });
                
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Drop Report");
                XLSX.writeFile(workbook, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="bg-white p-4 sm:p-6 rounded-xl shadow-lg mt-8">
                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-y-4">
                        <h2 className="text-xl font-bold text-slate-800">Daily Cash Drop History</h2>
                        <button onClick={handleExport} className="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <Icon name="export" /> Export to Excel
                        </button>
                    </div>
                    <ReportFilters 
                        filters={filters} 
                        setFilters={setFilters} 
                        shops={shops} 
                        onCustomClick={() => setIsCustomDateModalOpen(true)} 
                    />
                    
                    {!filteredAndAggregatedData ? (
                        <div className="py-16 flex justify-center items-center">
                            <Icon name="loader" className="w-8 h-8 text-slate-400" />
                        </div>
                    ) : (
                        <>
                            {filteredAndAggregatedData.type === 'detailed' ? (
                                <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={handleEditClick} onDelete={handleDeleteClick} viewType={filters.dueTime} shopColorMap={shopColorMap} />
                            ) : (
                                <AggregatedReportTable reports={filteredAndAggregatedData.data} totals={totals} periodType={filters.dueTime} shopColorMap={shopColorMap} />
                            )}
                            {hasMore && (
                                <div className="mt-6 text-center">
                                    <button onClick={loadMoreReports} disabled={isFetchingMore} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto disabled:bg-blue-300">
                                        {isFetchingMore ? <Icon name="loader" /> : 'Load More'}
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                    
                    {reportToEdit && (
                        <EditReportModal
                            isOpen={!!reportToEdit}
                            onClose={() => setReportToEdit(null)}
                            onSave={handleSaveEdit}
                            report={reportToEdit}
                            isSubmitting={isSubmitting}
                            shops={shops}
                        />
                    )}

                    <DeleteConfirmationModal
                        isOpen={!!reportToDelete}
                        onClose={() => setReportToDelete(null)}
                        onConfirm={handleConfirmDelete}
                        isSubmitting={isSubmitting}
                    />

                    <CustomDateRangeModal
                        isOpen={isCustomDateModalOpen}
                        onClose={() => setIsCustomDateModalOpen(false)}
                        onApply={(dates) => setFilters(prev => ({...prev, ...dates}))}
                    />
                </div>
            );
        };
        
        const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick }) => {
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                if (name === 'dueTime' && value === 'Custom') {
                    onCustomClick();
                }
                setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''})); // Reset dates on type change
            };

            const handleClearCustomDate = () => {
                setFilters(prev => ({...prev, startDate: '', endDate: ''}));
            }

            return (
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg items-center">
                    <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label:'All Shops'}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                    <FormSelect label="Due Time" name="dueTime" value={filters.dueTime} onChange={handleFilterChange} options={[
                        {value:'Daily',label:'Daily'}, 
                        {value:'Monthly',label:'Monthly'}, 
                        {value:'Yearly',label:'Yearly'},
                        {value:'Custom', label:'Custom'}
                    ]} />
                    {filters.dueTime === 'Daily' && (
                        <div className="pt-6">
                           <button onClick={onCustomClick} className="bg-blue-500 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-600">Find History</button>
                           {filters.startDate && <button onClick={handleClearCustomDate} className="ml-2 text-sm text-gray-500 hover:text-gray-700">Clear</button>}
                        </div>
                    )}
                </div>
            );
        });
        
        const AggregatedReportTable = React.memo(({ reports, totals, periodType, shopColorMap }) => {
            return (
                 <div className="overflow-x-auto">
                    {reports.length === 0 ? (
                         <div className="text-center py-16 text-gray-500">
                            <p>No reports found for the selected period.</p>
                        </div>
                    ) : (
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th className="p-3">{periodType}</th>
                                    <th className="p-3">Shop</th>
                                    <th className="p-3 text-right">Cash USD</th>
                                    <th className="p-3 text-right">Cash KHR</th>
                                    <th className="p-3 text-right">Bank USD</th>
                                    <th className="p-3 text-right">Bank KHR</th>
                                    <th className="p-3 text-right">Net Sale (៛)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {reports.map((r, index) => {
                                    const colorClasses = shopColorMap[r.shop] || { base: 'bg-white', hover: 'hover:bg-gray-50' };
                                    return (
                                        <tr key={index} className={`border-b ${colorClasses.base} ${colorClasses.hover}`}>
                                            <td className="p-3 whitespace-nowrap">{r.period}</td>
                                            <td className="p-3">{r.shop}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.cashUsd, 'USD')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.bankUsd, 'USD')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot className="bg-slate-200 font-bold">
                                <tr>
                                    <td colSpan={2} className="p-3 text-right">Sub-Total</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-blue-700">{formatCurrency(totals.netSale, 'KHR')}</td>
                                </tr>
                            </tfoot>
                        </table>
                    )}
                </div>
            );
        });
        
        const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, viewType, shopColorMap }) => {
            const { userData } = useAuth();
            const canModify = userData?.role === 'Admin' || userData?.role === 'Management';
            const isCustomView = viewType === 'Custom';

            return (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? (
                         <div className="text-center py-16 text-gray-500">
                            <p>No reports found for the selected filters.</p>
                        </div>
                    ) : (
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    {isCustomView ? <th className="p-3">Date</th> : <th className="p-3">Date & Time</th>}
                                    <th className="p-3">Shop</th>
                                    {!isCustomView && <th className="p-3">Staff</th>}
                                    <th className="p-3 text-right">Cash USD</th>
                                    <th className="p-3 text-right">Cash KHR</th>
                                    <th className="p-3 text-right">Bank USD</th>
                                    <th className="p-3 text-right">Bank KHR</th>
                                    <th className="p-3 text-right">Net Sale (៛)</th>
                                    {!isCustomView && <th className="p-3 text-center">Actions</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {reports.map(r => {
                                    const colorClasses = shopColorMap[r.shop] || { base: 'bg-white', hover: 'hover:bg-gray-50' };
                                    return (
                                        <tr key={r.id} className={`border-b ${colorClasses.base} ${colorClasses.hover}`}>
                                            <td className="p-3 whitespace-nowrap">{isCustomView ? formatDateDDMMYY(r.createdAt) : r.createdAt?.toDate().toLocaleString('en-GB', { timeZone: 'Asia/Phnom_Penh' }) || 'N/A'}</td>
                                            <td className="p-3">{r.shop}</td>
                                            {!isCustomView && <td className="p-3">{r.staff}</td>}
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.cashUsd, 'USD')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.bankUsd, 'USD')}</td>
                                            <td className="p-3 text-right font-mono">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                            <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                            {!isCustomView && (
                                                <td className="p-3 flex gap-2 justify-center">
                                                     <button onClick={() => canModify && onEdit(r)} disabled={!canModify} className="p-1 text-blue-500 hover:text-blue-700 disabled:text-gray-300 disabled:cursor-not-allowed"><Icon name="note"/></button>
                                                     <button onClick={() => canModify && onDelete(r)} disabled={!canModify} className="p-1 text-red-500 hover:text-red-700 disabled:text-gray-300 disabled:cursor-not-allowed"><Icon name="trash"/></button>
                                                </td>
                                            )}
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot className="bg-slate-200 font-bold">
                                <tr>
                                    <td colSpan={isCustomView ? 2 : 3} className="p-3 text-right">Sub-Total</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-blue-700">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    {!isCustomView && <td colSpan={1}></td>}
                                </tr>
                            </tfoot>
                        </table>
                    )}
                </div>
            )
        });

        /******************************************************************************
         * ROOT APPLICATION COMPONENT
         *****************************************************************************/
        const AppHeader = () => {
            const { userData, logout } = useAuth();
            const [installPrompt, setInstallPrompt] = useState(null);

            useEffect(() => {
                const handler = e => {
                    // Prevent the mini-infobar from appearing on mobile
                    e.preventDefault();
                    // Stash the event so it can be triggered later.
                    setInstallPrompt(e);
                    console.log('beforeinstallprompt event fired.');
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = () => {
                if (!installPrompt) {
                    console.log('Install prompt not available');
                    return;
                }
                // Show the install prompt
                installPrompt.prompt();
                // Wait for the user to respond to the prompt
                installPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    setInstallPrompt(null);
                });
            };

            return (
                <header className="bg-white/80 backdrop-blur-lg p-4 rounded-xl shadow-md mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                    <div className="text-center sm:text-left">
                        <h1 className="text-xl md:text-2xl font-bold text-slate-800">Cash Drop Report</h1>
                        <p className="mt-1 text-sm text-slate-600">Welcome, {userData.name} ({userData.role})</p>
                    </div>
                    <div className="flex items-center gap-2">
                        {installPrompt && (
                            <button onClick={handleInstallClick} className="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm w-full sm:w-auto justify-center">
                                <Icon name="install" /> Install App
                            </button>
                        )}
                        <button onClick={logout} className="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm w-full sm:w-auto justify-center">
                            <Icon name="logout" /> Logout
                        </button>
                    </div>
                </header>
            );
        };

        const App = () => {
            const { user, userData, loading } = useAuth();

            if (loading) {
                return <LoadingSpinner />;
            }

            if (!user || !userData) {
                return <LoginPage />;
            }
            
            return (
                <AppProvider>
                    <div className="container mx-auto p-4 md:p-8 w-full">
                        <div className="max-w-7xl mx-auto">
                            <AppHeader />
                            <main>
                                <CashDropPage />
                            </main>
                        </div>
                    </div>
                </AppProvider>
            );
        };

        const Root = () => {
            return (
                <AuthProvider>
                    <App />
                </AuthProvider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
