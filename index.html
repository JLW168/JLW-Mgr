<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Angkor&family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .ang-daunkeo {
            font-family: 'Kantumruy Pro', sans-serif; /* Using Kantumruy as a close web-safe alternative to Ang DaunKeo */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab {
            transition: all 0.2s ease-in-out;
        }
        .tab.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        .setting-tab.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        
        /* Styles for the hidden PDF template */
        #pdf-template-area {
            box-sizing: border-box;
        }
        #pdf-template-area * {
            box-sizing: border-box;
        }
        #pdf-template-area table {
            border-collapse: collapse;
            width: 100%;
        }
        #pdf-template-area th, #pdf-template-area td {
            border: 1px solid black;
            padding: 8px; /* Increased padding for better spacing */
            text-align: left;
            vertical-align: middle; /* Vertically center text */
        }
        #pdf-template-area th {
            text-align: center; /* Center header text */
        }

        /* Mobile-first responsive table styles */
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none; /* Hide table headers on mobile */
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                padding: 1rem;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
                color: #4b5563;
            }
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 15mm;
            }
            body * {
                visibility: hidden;
            }
            #request-print-area, #request-print-area *,
            #po-print-area, #po-print-area * {
                visibility: visible;
            }
            #request-print-area, #po-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 10pt;
            }
            .no-print {
                display: none;
            }
            h1 {
                font-size: 18pt;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-2 sm:p-4 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg">

            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200 no-print">
                <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 sm:px-6 md:px-8" aria-label="Tabs">
                    <button class="tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="po-request-form">
                        Purchase Order Page
                    </button>
                    <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="purchase-order">
                        POs Center
                    </button>
                    <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="product-data-page">
                        Product Data
                    </button>
                    <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="setting-page">
                        Settings
                    </button>
                </nav>
            </div>

            <div class="p-4 sm:p-6 md:p-8">
                <!-- PO Request Form Content -->
                <div id="po-request-form" class="tab-content active">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6">Purchase Order Request</h1>
                        
                        <div class="bg-gray-50 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200">
                            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-800">PO Request Data</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                                <div>
                                    <label for="request-vendor" class="block text-sm font-medium text-gray-700">Vendor</label>
                                    <input type="text" id="request-vendor" readonly class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                                </div>
                                <div>
                                    <label for="request-shop-dropdown" class="block text-sm font-medium text-gray-700">Request By</label>
                                    <select id="request-shop-dropdown" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                                <div>
                                    <label for="request-po-no" class="block text-sm font-medium text-gray-700">PO No.</label>
                                    <input type="text" id="request-po-no" readonly class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                                </div>
                                <div>
                                    <label for="request-po-date" class="block text-sm font-medium text-gray-700">PO Date</label>
                                    <input type="text" id="request-po-date" readonly class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                                </div>
                                <div class="sm:col-span-2">
                                    <label for="exchange-rate" class="block text-sm font-medium text-gray-700">Exchange Rate (KHR to 1 USD)</label>
                                    <input type="number" id="exchange-rate" value="4100" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-gray-200 no-print">
                                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-800">Add Product to PO</h2>
                                <div id="lookup-form">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div class="relative">
                                                <label for="product-code" class="block text-sm font-medium text-gray-700 mb-1">Product Code/Barcode</label>
                                                <input type="text" id="product-code" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter code...">
                                                <div id="product-preview" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg p-3">
                                                    <!-- Live preview content goes here -->
                                                </div>
                                            </div>
                                            <div>
                                                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                                <input type="number" id="quantity" value="1" min="1" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                            </div>
                                        </div>
                                        <button id="add-to-po" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 h-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-7">Add to PO</button>
                                    </div>
                                    <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white responsive-table">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">No.</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Product Code</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Barcode</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Product Name</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Qty</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Cost (KHR)</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Cost (USD)</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Sub-Total</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">CB4</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider no-print">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="po-table-body" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                     <div class="mt-6 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 no-print">
                        <button id="request-save-pdf-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Save as PDF</button>
                        <button id="create-po-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Purchase Order</button>
                    </div>
                </div>

                <!-- POs Center Content -->
                <div id="purchase-order" class="tab-content">
                    <div id="po-list-view">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6">Purchase Order Center</h1>
                        
                        <!-- Filter Controls -->
                        <div class="bg-gray-50 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="filter-shop" class="block text-sm font-medium text-gray-700">Shop</label>
                                    <select id="filter-shop" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                                <div>
                                    <label for="filter-date" class="block text-sm font-medium text-gray-700">Req. Date</label>
                                    <input type="date" id="filter-date" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="filter-vendor" class="block text-sm font-medium text-gray-700">Vendor</label>
                                    <input type="text" id="filter-vendor" placeholder="Enter vendor name..." class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <button id="clear-filters-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Clear Filters</button>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white responsive-table">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">No.</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">PO Number</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Request Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Vendor</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Shop</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="po-list-body" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="po-detail-view" class="hidden">
                        <button id="back-to-list-btn" class="mb-6 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">&larr; Back to PO List</button>
                        <div id="po-print-area" class="border border-gray-200 p-4 sm:p-6 rounded-lg">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4" id="po-number-display"></h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <p><strong>Vendor:</strong> <span id="print-vendor-name"></span></p>
                                    <p><strong>Request by:</strong> <span id="print-shop-name"></span></p>
                                </div>
                                <div class="text-left sm:text-right">
                                    <p><strong>PO Number:</strong> <span id="print-po-number"></span></p>
                                    <p><strong>Date:</strong> <span id="print-date"></span></p>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-left text-sm font-semibold">No.</th>
                                            <th class="p-3 text-left text-sm font-semibold">Product Name</th>
                                            <th class="p-3 text-center text-sm font-semibold">Qty</th>
                                            <th class="p-3 text-right text-sm font-semibold">Total Cost (KHR)</th>
                                            <th class="p-3 text-right text-sm font-semibold">Total Cost (USD)</th>
                                            <th class="p-3 text-right text-sm font-semibold">Cost/Unit (KHR)</th>
                                            <th class="p-3 text-right text-sm font-semibold">CheckUp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="print-table-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="mt-6 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 no-print">
                            <button id="update-goods-btn" class="bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">Update Manually</button>
                            <button id="save-updates-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hidden shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Updates</button>
                            <button id="detail-save-pdf-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save as PDF</button>
                            <button id="delete-po-detail-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete PO</button>
                        </div>
                    </div>
                </div>

                <!-- Product Data Page Content -->
                <div id="product-data-page" class="tab-content">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                            Product Data Management 
                            <span id="product-total-count" class="text-lg font-medium text-gray-500 ml-2"></span>
                        </h1>
                        <div class="w-full sm:w-auto flex flex-wrap gap-2">
                            <input type="text" id="product-search-input" placeholder="Search by name or code..." class="w-full sm:w-auto flex-grow px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="add-product-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 whitespace-nowrap">Add Product</button>
                            <button id="export-products-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap">Export to Excel</button>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 sm:p-6 mb-6 border border-gray-200">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-800">Import / Export</h2>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <input type="file" id="product-file-input" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="import-products-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 whitespace-nowrap">Import Products</button>
                        </div>
                        <div id="product-import-status" class="mt-4 text-sm"></div>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                             <button id="delete-all-products-btn" class="w-full sm:w-auto bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                Delete All Products
                            </button>
                            <p class="text-xs text-gray-500 mt-2">Permanently delete all product data. This action cannot be undone.</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white responsive-table">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Product Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Barcode</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Product Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Category</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Cost</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Price</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="product-list-body" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div id="product-pagination" class="mt-6 flex justify-center items-center space-x-2"></div>
                </div>
                
                <!-- Setting Page Content -->
                <div id="setting-page" class="tab-content">
                     <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Settings</h1>
                     <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button class="setting-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="shop-list">Shop List</button>
                            <button class="setting-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500" data-tab="vendor-list">Vendor List</button>
                        </nav>
                    </div>

                    <div id="shop-list" class="setting-tab-content active">
                         <p class="text-gray-500 mb-6">Add, view, or remove shops from your list.</p>
                         <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200 max-w-2xl mx-auto">
                            <h2 class="text-xl font-semibold mb-4">Add New Shop</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="shop-name" class="block text-sm font-medium text-gray-700">Shop Name</label>
                                    <input type="text" id="shop-name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter shop name...">
                                </div>
                                <div>
                                    <label for="shop-address" class="block text-sm font-medium text-gray-700">Address</label>
                                    <input type="text" id="shop-address" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter address...">
                                </div>
                                <div>
                                    <label for="shop-contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
                                    <input type="text" id="shop-contact" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter contact number...">
                                </div>
                                <button id="add-shop-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Add Shop</button>
                            </div>
                         </div>
                         <div class="overflow-x-auto max-w-2xl mx-auto">
                            <table class="min-w-full bg-white divide-y divide-gray-100 rounded-lg shadow-sm border border-gray-100">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Shop Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Address</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contact</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shop-list-body" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                         </div>
                    </div>
                    <div id="vendor-list" class="setting-tab-content" style="display:none;">
                        <p class="text-gray-500 mb-6">Add, view, or remove vendors from your list.</p>
                        <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200 max-w-2xl mx-auto">
                           <h2 class="text-xl font-semibold mb-4">Add New Vendor</h2>
                           <div class="space-y-4">
                               <div>
                                   <label for="vendor-name" class="block text-sm font-medium text-gray-700">Vendor Name</label>
                                   <input type="text" id="vendor-name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter vendor name...">
                               </div>
                               <div>
                                   <label for="vendor-contact" class="block text-sm font-medium text-gray-700">Contact</label>
                                   <input type="text" id="vendor-contact" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter contact...">
                               </div>
                               <div>
                                   <label for="vendor-address" class="block text-sm font-medium text-gray-700">Address</label>
                                   <input type="text" id="vendor-address" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg" placeholder="Enter address...">
                               </div>
                               <button id="add-vendor-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Add Vendor</button>
                           </div>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200 max-w-2xl mx-auto">
                            <h2 class="text-xl font-semibold mb-4">Import Vendors from Excel</h2>
                            <input type="file" id="vendor-file" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="import-vendors-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Import Vendors</button>
                            <div id="import-status" class="mt-4 text-sm"></div>
                        </div>
                        <div class="overflow-x-auto max-w-2xl mx-auto">
                           <table class="min-w-full bg-white divide-y divide-gray-100 rounded-lg shadow-sm border border-gray-100">
                               <thead class="bg-gray-50">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Vendor Name</th>
                                       <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contact</th>
                                       <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Address</th>
                                       <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Actions</th>
                                   </tr>
                               </thead>
                               <tbody id="vendor-list-body" class="bg-white divide-y divide-gray-100"></tbody>
                           </table>
                        </div>
                   </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Hidden PDF Template for PO Request -->
    <div id="pdf-template-area" class="w-[1123px] p-8 bg-white text-black fixed -left-[9999px] top-0 ang-daunkeo" style="font-size: 14px; opacity: 0; z-index: -10;">
        <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 24px;">Purchase Order</h1>
        <div style="display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 24px;">
            <div>
                <p><strong>Vendor:</strong> <span id="pdf-vendor"></span></p>
                <p><strong>Shop:</strong> <span id="pdf-shop"></span></p>
                <p><strong>Address:</strong> <span id="pdf-address"></span></p>
            </div>
            <div style="text-align: right;">
                <p><strong>PO NO.:</strong> <span id="pdf-po-no"></span></p>
                <p><strong>PO Date:</strong> <span id="pdf-po-date"></span></p>
                <p><strong>Contact:</strong> <span id="pdf-contact"></span></p>
            </div>
        </div>
        <table>
            <thead>
                <tr style="background-color: #e5e7eb;">
                    <th style="width: 5%;">No.</th>
                    <th style="width: 15%;">Product Code</th>
                    <th style="width: 15%;">Barcode</th>
                    <th style="width: 25%;">Product Name</th>
                    <th style="width: 8%;">QTY</th>
                    <th style="width: 10%;">Cost-៛</th>
                    <th style="width: 10%;">Cost-$</th>
                    <th style="width: 12%;">CB4</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                <!-- Rows will be injected here -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">Sub-Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; margin-top: 96px;">
            <div>
                <p>Req. By :</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
            <div>
                <p>Received By.:</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
            <div>
                <p>PO Check By:</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 id="delete-modal-title" class="text-lg leading-6 font-medium text-gray-900">Delete Item?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="delete-modal-text" class="text-sm text-gray-500">
                        Are you sure you want to delete this item? This action cannot be undone.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Delete
                    </button>
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="product-modal-title">Add New Product</h3>
                <div class="mt-4 space-y-4">
                    <input type="hidden" id="product-id">
                    <div>
                        <label for="modal-product-code" class="block text-sm font-medium text-gray-700">Product Code</label>
                        <input type="text" id="modal-product-code" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-barcode" class="block text-sm font-medium text-gray-700">Barcode</label>
                        <input type="text" id="modal-barcode" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="modal-product-name" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-category" class="block text-sm font-medium text-gray-700">Category (Vendor)</label>
                        <input type="text" id="modal-product-category" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-cost" class="block text-sm font-medium text-gray-700">Cost</label>
                        <input type="number" id="modal-product-cost" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="modal-product-price" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-product-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto mr-2 shadow-sm hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="save-product-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700">
                        Save Product
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PO Item Edit Modal -->
    <div id="edit-po-item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="edit-po-item-modal-title">Edit PO Item</h3>
                <div class="mt-4 space-y-4">
                    <input type="hidden" id="edit-po-item-index">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="modal-edit-product-name" readonly class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm cursor-not-allowed">
                    </div>
                    <div>
                        <label for="modal-edit-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="modal-edit-quantity" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-edit-cost" class="block text-sm font-medium text-gray-700">Cost</label>
                        <input type="number" id="modal-edit-cost" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-edit-po-item-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto mr-2 shadow-sm hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="save-edit-po-item-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- Main App Logic (runs after DOM is loaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Firebase Configuration and Initialization ---
            const firebaseConfig = {
                apiKey: "AIzaSyBsSA-iUiXFhYmkZQc9sMdkK7FW5HEu9p0",
                authDomain: "po-report-cd3fc.firebaseapp.com",
                projectId: "po-report-cd3fc",
                storageBucket: "po-report-cd3fc.appspot.com",
                messagingSenderId: "115437177983",
                appId: "1:115437177983:web:a0dc6b1046babcff6a034a",
                measurementId: "G-NWFTBZ7F2L"
            };
            
            let app, db, auth, isFirebaseInitialized = false;

            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseInitialized = true;
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // A custom modal or non-blocking notification would be better here
            }
            
            // --- Application State ---
            let poItems = [];
            let allProducts = []; // Cache for all products
            let shops = []; // Cache for shops
            let vendorSettings = {}; // To store currency for each vendor
            let allPurchaseOrders = []; // Cache for all POs
            let currentPoId = null;
            let currentPoData = null;
            let itemToDelete = { id: null, type: null };
            let productCurrentPage = 1;
            const productItemsPerPage = 100;

            // --- DOM Elements ---
            const productCodeInput = document.getElementById('product-code');
            const quantityInput = document.getElementById('quantity');
            const addToPoButton = document.getElementById('add-to-po');
            const poTableBody = document.getElementById('po-table-body');
            const errorMessageEl = document.getElementById('error-message');
            const printTableBody = document.getElementById('print-table-body');
            const printDateEl = document.getElementById('print-date');
            const printVendorNameEl = document.getElementById('print-vendor-name');
            const printShopNameEl = document.getElementById('print-shop-name');
            const printPoNumberEl = document.getElementById('print-po-number');
            const lookupForm = document.getElementById('lookup-form');
            const shopNameInput = document.getElementById('shop-name');
            const shopAddressInput = document.getElementById('shop-address');
            const shopContactInput = document.getElementById('shop-contact');
            const addShopBtn = document.getElementById('add-shop-btn');
            const shopListBody = document.getElementById('shop-list-body');
            const createPoBtn = document.getElementById('create-po-btn');
            const requestShopDropdown = document.getElementById('request-shop-dropdown');
            const exchangeRateInput = document.getElementById('exchange-rate');
            const vendorListContainer = document.getElementById('vendor-list-container');
            const saveVendorSettingsBtn = document.getElementById('save-vendor-settings-btn');
            const poNumberDisplay = document.getElementById('po-number-display');
            const updateGoodsBtn = document.getElementById('update-goods-btn');
            const saveUpdatesBtn = document.getElementById('save-updates-btn');
            const requestVendorInput = document.getElementById('request-vendor');
            const requestPoNoInput = document.getElementById('request-po-no');
            const requestPoDateInput = document.getElementById('request-po-date');
            const requestSavePdfBtn = document.getElementById('request-save-pdf-btn');
            const detailSavePdfBtn = document.getElementById('detail-save-pdf-btn');
            const deletePoDetailBtn = document.getElementById('delete-po-detail-btn');
            const productPreview = document.getElementById('product-preview');

            const poListView = document.getElementById('po-list-view');
            const poDetailView = document.getElementById('po-detail-view');
            const poListBody = document.getElementById('po-list-body');
            const backToListBtn = document.getElementById('back-to-list-btn');

            const filterShop = document.getElementById('filter-shop');
            const filterDate = document.getElementById('filter-date');
            const filterVendor = document.getElementById('filter-vendor');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');

            const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            const productModal = document.getElementById('product-modal');
            const addProductBtn = document.getElementById('add-product-btn');
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            const saveProductBtn = document.getElementById('save-product-btn');
            const productListBody = document.getElementById('product-list-body');
            const productSearchInput = document.getElementById('product-search-input');
            const productPagination = document.getElementById('product-pagination');
            const exportProductsBtn = document.getElementById('export-products-btn');
            const importProductsBtn = document.getElementById('import-products-btn');
            const productFileInput = document.getElementById('product-file-input');
            const productImportStatus = document.getElementById('product-import-status');
            const deleteAllProductsBtn = document.getElementById('delete-all-products-btn');
            const productTotalCountEl = document.getElementById('product-total-count');

            const editPoItemModal = document.getElementById('edit-po-item-modal');
            const cancelEditPoItemBtn = document.getElementById('cancel-edit-po-item-btn');
            const saveEditPoItemBtn = document.getElementById('save-edit-po-item-btn');


            // --- Helper Functions ---
            /**
             * Gets a value from an object using a list of possible case-insensitive keys.
             * @param {object} obj The object to search.
             * @param {string[]} keys The list of possible keys (e.g., ['Price', 'Sales Price']).
             * @returns The value of the first matching key, otherwise undefined.
             */
            function findValue(obj, keys) {
                if (!obj || typeof obj !== 'object') return undefined;
                for (const key of keys) {
                    const lowerKey = key.toLowerCase();
                    const objKey = Object.keys(obj).find(k => k.toLowerCase() === lowerKey);
                    if (objKey && obj[objKey] !== undefined) {
                        return obj[objKey];
                    }
                }
                return undefined;
            }

            // --- FUNCTION DEFINITIONS ---

            async function signIn() {
                 if (auth.currentUser) return auth.currentUser;
                try {
                    await auth.signInAnonymously(); return auth.currentUser;
                } catch (error) {
                    console.error("Authentication failed:", error); return null;
                }
            }
            
            function renderShopList() {
                shopListBody.innerHTML = '';
                shops.forEach(shop => {
                    const row = `
                        <tr data-id="${shop.id}">
                            <td data-label="Shop Name">${shop.name || ''}</td>
                            <td data-label="Address">${shop.address || ''}</td>
                            <td data-label="Contact">${shop.contact || ''}</td>
                            <td data-label="Actions" class="text-center">
                                <button class="delete-shop-btn text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `;
                    shopListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function populateShopDropdowns() {
                if (!requestShopDropdown || !filterShop) return;
                const selectedRequestValue = requestShopDropdown.value;
                const selectedFilterValue = filterShop.value;

                requestShopDropdown.innerHTML = '<option value="">Select a shop</option>';
                filterShop.innerHTML = '<option value="">All Shops</option>';

                shops.forEach(shop => {
                    const option1 = document.createElement('option');
                    option1.value = shop.name;
                    option1.textContent = shop.name;
                    requestShopDropdown.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = shop.name;
                    option2.textContent = shop.name;
                    filterShop.appendChild(option2);
                });

                if (Array.from(requestShopDropdown.options).some(opt => opt.value === selectedRequestValue)) {
                    requestShopDropdown.value = selectedRequestValue;
                }
                if (Array.from(filterShop.options).some(opt => opt.value === selectedFilterValue)) {
                    filterShop.value = selectedFilterValue;
                }
            }

            function listenForShops() {
                const shopsCollection = db.collection(`shops`);
                shopsCollection.onSnapshot((snapshot) => {
                    shops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderShopList(); // For settings page
                    populateShopDropdowns(); // For request form and filter
                });
            }

            async function loadVendorSettings() {
                const settingsCollection = db.collection('vendorSettings');
                const snapshot = await settingsCollection.get();
                vendorSettings = {};
                snapshot.forEach(doc => {
                    vendorSettings[doc.id] = doc.data().currency;
                });
            }

            function renderProductList() {
                if (!productListBody) return;
                
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => 
                    (p.Name || '').toLowerCase().includes(searchTerm) || 
                    (p["Product Code"] || '').toLowerCase().includes(searchTerm)
                );

                productListBody.innerHTML = '';
                const startIndex = (productCurrentPage - 1) * productItemsPerPage;
                const endIndex = startIndex + productItemsPerPage;
                const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

                paginatedProducts.forEach((product, index) => {
                    const cost = parseFloat(findValue(product, ['Cost'])) || 0;
                    const price = parseFloat(findValue(product, ['Price', 'Sales Price'])) || 0;
                    const row = `
                        <tr data-id="${product.id}" class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td data-label="Product Code">${product["Product Code"]}</td>
                            <td data-label="Barcode">${product.Barcode || ''}</td>
                            <td data-label="Product Name">${product.Name}</td>
                            <td data-label="Category">${product["Product Category"] || ''}</td>
                            <td data-label="Cost" class="text-right">${cost.toFixed(2)}</td>
                            <td data-label="Price" class="text-right">${price.toFixed(2)}</td>
                            <td data-label="Actions" class="text-right">
                                <button class="edit-product-btn text-indigo-600 hover:text-indigo-900 font-medium mr-4" data-id="${product.id}">Edit</button>
                                <button class="delete-product-btn text-red-600 hover:text-red-900 font-medium" data-id="${product.id}">Delete</button>
                            </td>
                        </tr>`;
                    productListBody.insertAdjacentHTML('beforeend', row);
                });

                renderProductPagination(filteredProducts.length);
            }

            function renderProductPagination(totalItems) {
                if (!productPagination) return;
                productPagination.innerHTML = '';
                const totalPages = Math.ceil(totalItems / productItemsPerPage);

                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.className = `px-3 py-1 rounded-md text-sm font-medium ${i === productCurrentPage ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                    pageButton.addEventListener('click', () => {
                        productCurrentPage = i;
                        renderProductList();
                    });
                    productPagination.appendChild(pageButton);
                }
            }

            async function loadAndCacheProducts() {
                const user = await signIn();
                if (!user) {
                    console.error("Authentication failed.");
                    return;
                }
                try {
                    db.collection(`products`).onSnapshot((querySnapshot) => {
                        allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        if (productTotalCountEl) {
                            productTotalCountEl.textContent = `(${allProducts.length} items)`;
                        }

                        renderProductList(); // Update the Product Data tab
                        
                        // If the PO detail view is open, refresh its calculations now that we have product data
                        if (currentPoData && !poDetailView.classList.contains('hidden')) {
                           recalculateDetailView();
                        }
                    });
                    await loadVendorSettings();
                } catch (error) {
                    console.error("Error fetching products:", error);
                }
            }

            function renderRequestPOTable() {
                poTableBody.innerHTML = '';
                let primaryVendor = "N/A";
                if (poItems.length > 0) {
                    const vendorCounts = poItems.reduce((acc, item) => {
                        const vendor = item["Product Category"] || "Unknown";
                        acc[vendor] = (acc[vendor] || 0) + 1;
                        return acc;
                    }, {});
                    primaryVendor = Object.keys(vendorCounts).reduce((a, b) => vendorCounts[a] > vendorCounts[b] ? a : b);
                }
                requestVendorInput.value = primaryVendor;
                updateRequestHeader();

                poItems.forEach((item, index) => {
                    const cost = parseFloat(item.Cost) || 0;
                    const qty = parseInt(item.quantity) || 0;
                    const subtotal = cost * qty;
                    const currencySymbol = item.currency === 'KHR' ? '៛' : '$';
                    const row = `
                        <tr data-index="${index}">
                            <td data-label="No.">${index + 1}</td>
                            <td data-label="Product Code">${item["Product Code"]}</td>
                            <td data-label="Barcode">${item.Barcode || ''}</td>
                            <td data-label="Product Name">${item.Name}</td>
                            <td data-label="Qty" class="text-right">${qty}</td>
                            <td data-label="Cost (KHR)" class="text-right">${item.currency === 'KHR' ? cost.toFixed(2) : '-'}</td>
                            <td data-label="Cost (USD)" class="text-right">${item.currency === 'USD' ? cost.toFixed(2) : '-'}</td>
                            <td data-label="Sub-Total" class="text-right">${subtotal.toFixed(2)} ${currencySymbol}</td>
                            <td data-label="CB4" class="text-right">${cost.toFixed(2)}</td>
                            <td data-label="Actions" class="no-print text-right">
                                <button class="edit-item text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                                <button class="delete-item text-red-600 hover:text-red-900">Del</button>
                            </td>
                        </tr>`;
                    poTableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            
            async function handleAddToPO() {
                const code = productCodeInput.value.trim();
                const quantity = parseInt(quantityInput.value);
                if (!code || isNaN(quantity) || quantity <= 0) {
                    errorMessageEl.textContent = "Please enter a valid product code and quantity.";
                    errorMessageEl.classList.remove('hidden');
                    return;
                }
                errorMessageEl.classList.add('hidden');
                
                let product = null;
                const lowerCaseCode = code.toLowerCase();

                // If cache is ready, use it for a fast lookup
                if (allProducts.length > 0) {
                    // Prioritize exact match
                    product = allProducts.find(p =>
                        (p["Product Code"] || "").toLowerCase() === lowerCaseCode ||
                        (p["Barcode"] || "").toLowerCase() === lowerCaseCode
                    );

                    // If no exact match, try endsWith match
                    if (!product) {
                        product = allProducts.find(p =>
                            (p["Product Code"] || "").toLowerCase().endsWith(lowerCaseCode) ||
                            (p["Barcode"] || "").toLowerCase().endsWith(lowerCaseCode)
                        );
                    }
                } else {
                    // If cache is not ready, query Firestore directly
                    addToPoButton.disabled = true;
                    addToPoButton.textContent = 'Searching...';
                    try {
                        // Firestore doesn't support case-insensitive or endsWith queries well,
                        // so this direct lookup is limited but better than nothing.
                        let querySnapshot = await db.collection('products').where('Product Code', '==', code).limit(1).get();
                        if (querySnapshot.empty) {
                            querySnapshot = await db.collection('products').where('Barcode', '==', code).limit(1).get();
                        }

                        if (!querySnapshot.empty) {
                            const doc = querySnapshot.docs[0];
                            product = { id: doc.id, ...doc.data() };
                        }
                    } catch (err) {
                        console.error("Error querying product:", err);
                        errorMessageEl.textContent = "An error occurred while searching for the product.";
                        errorMessageEl.classList.remove('hidden');
                    } finally {
                        addToPoButton.disabled = false;
                        addToPoButton.textContent = 'Add to PO';
                    }
                }

                if (product) {
                    const vendor = product["Product Category"] || "Unknown";
                    const currency = vendorSettings[vendor] || 'KHR';
                    const existingItem = poItems.find(item => item["Product Code"] === product["Product Code"]);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        poItems.push({ ...product, quantity, currency });
                    }
                    renderRequestPOTable();
                    productCodeInput.value = '';
                    quantityInput.value = '1';
                    productPreview.classList.add('hidden'); // Hide preview after adding
                    productCodeInput.focus();
                } else {
                    errorMessageEl.textContent = `Product with code "${code}" not found.`;
                    errorMessageEl.classList.remove('hidden');
                }
            }

            function updateRequestHeader() {
                const shopName = requestShopDropdown.value || "N/A";
                const vendor = requestVendorInput.value || "N/A";
                const shopCode = shopName.substring(0, 3).toUpperCase().replace(/\s/g, '');
                const vendorCode = vendor.substring(0, 4).toUpperCase().replace(/\s/g, '');
                requestPoNoInput.value = `${shopCode}-${vendorCode}-PO-PENDING`;
                requestPoDateInput.value = new Date().toLocaleDateString();
            }

            function renderPoListView(pos) {
                poListBody.innerHTML = '';
                pos.forEach((po, index) => {
                    const requestDate = po.createdAt ? po.createdAt.toDate().toLocaleDateString() : 'Pending...';
                    const row = `
                        <tr data-id="${po.id}">
                            <td data-label="No.">${index + 1}</td>
                            <td data-label="PO Number" class="font-medium text-indigo-600">${po.poNumber}</td>
                            <td data-label="Date">${requestDate}</td>
                            <td data-label="Vendor">${po.vendorName}</td>
                            <td data-label="Shop">${po.shopName}</td>
                            <td data-label="Actions" class="text-right">
                                <button class="edit-po-btn text-indigo-600 hover:text-indigo-900 font-medium mr-4" data-id="${po.id}">Edit</button>
                                <button class="delete-po-btn text-red-600 hover:text-red-900 font-medium" data-id="${po.id}">Delete</button>
                            </td>
                        </tr>`;
                    poListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function applyAndRenderFilters() {
                const shopValue = filterShop.value;
                const dateValue = filterDate.value;
                const vendorValue = filterVendor.value.toLowerCase();

                let filteredPOs = allPurchaseOrders;

                if (shopValue) {
                    filteredPOs = filteredPOs.filter(po => po.shopName === shopValue);
                }
                if (dateValue) {
                    // Normalize dates to compare them without time part
                    const filterDateObj = new Date(dateValue);
                    const filterDateString = new Date(filterDateObj.getTime() - filterDateObj.getTimezoneOffset() * -60000).toISOString().split('T')[0];
                    filteredPOs = filteredPOs.filter(po => {
                        if (!po.createdAt) return false;
                        const poDateObj = po.createdAt.toDate();
                        const poDateString = new Date(poDateObj.getTime() - poDateObj.getTimezoneOffset() * -60000).toISOString().split('T')[0];
                        return poDateString === filterDateString;
                    });
                }
                if (vendorValue) {
                    filteredPOs = filteredPOs.filter(po => po.vendorName.toLowerCase().includes(vendorValue));
                }

                renderPoListView(filteredPOs);
            }

            function showPoDetails(poId) {
                poListView.classList.add('hidden');
                poDetailView.classList.remove('hidden');
                loadPurchaseOrder(poId);
            }

            function showPoList() {
                poDetailView.classList.add('hidden');
                poListView.classList.remove('hidden');
                currentPoId = null;
                currentPoData = null;
            }

            function updatePrintView(poData) {
                printTableBody.innerHTML = '';
                poData.items.forEach((item, index) => {
                    const totalCostKhr = item.currency === 'KHR' ? (parseFloat(item.Cost) * parseInt(item.quantity)).toFixed(2) : '-';
                    const totalCostUsd = item.currency === 'USD' ? (parseFloat(item.Cost) * parseInt(item.quantity)).toFixed(2) : '-';

                    const rowHtml = `
                        <tr data-index="${index}" data-code="${item["Product Code"]}">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">${item.Name}</td>
                            <td class="p-3 text-center" data-field="quantity">${item.quantity}</td>
                            <td class="p-3 text-right" data-field="totalCostKhr">${totalCostKhr}</td>
                            <td class="p-3 text-right" data-field="totalCostUsd">${totalCostUsd}</td>
                            <td class="p-3 text-right" data-field="costPerUnit">0.00</td>
                            <td class="p-3 text-right" data-field="checkup">N/A</td>
                        </tr>`;
                    printTableBody.insertAdjacentHTML('beforeend', rowHtml);
                });
                
                recalculateDetailView();

                printDateEl.textContent = poData.createdAt ? poData.createdAt.toDate().toLocaleDateString() : 'N/A';
                printVendorNameEl.textContent = poData.vendorName;
                printShopNameEl.textContent = poData.shopName;
                printPoNumberEl.textContent = poData.poNumber;
                poNumberDisplay.textContent = `Viewing PO: ${poData.poNumber}`;
            }

            function recalculateDetailView() {
                if (!currentPoData) return;
                
                const exchangeRate = currentPoData.exchangeRate || 4100;

                printTableBody.querySelectorAll('tr').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    const item = currentPoData.items[index];

                    const qtyEl = row.querySelector('[data-field="quantity"]');
                    const totalCostKhrEl = row.querySelector('[data-field="totalCostKhr"]');
                    const totalCostUsdEl = row.querySelector('[data-field="totalCostUsd"]');

                    const qty = parseInt(qtyEl ? qtyEl.textContent : '0') || 0;
                    const totalCostKhr = parseFloat(totalCostKhrEl ? totalCostKhrEl.textContent : '0') || 0;
                    const totalCostUsd = parseFloat(totalCostUsdEl ? totalCostUsdEl.textContent : '0') || 0;
                    
                    let unitCostKhr = 0;
                    if (item.currency === 'KHR') {
                        unitCostKhr = qty > 0 ? totalCostKhr / qty : 0;
                    } else {
                        unitCostKhr = qty > 0 ? (totalCostUsd * exchangeRate) / qty : 0;
                    }
                    row.querySelector('[data-field="costPerUnit"]').textContent = unitCostKhr.toFixed(2);

                    const originalProduct = allProducts.find(p => p["Product Code"] === item["Product Code"]);
                    if (originalProduct) {
                        const masterCost = parseFloat(originalProduct.Cost) || 0;
                        const checkUpValue = masterCost - unitCostKhr;
                        const checkUpSign = checkUpValue >= 0 ? '+' : '';
                        const checkUpColor = Math.abs(checkUpValue) < 0.01 ? 'text-gray-500' : (checkUpValue > 0 ? 'text-green-600' : 'text-red-600');
                        row.querySelector('[data-field="checkup"]').innerHTML = `<span class="${checkUpColor} font-semibold">${checkUpSign}${checkUpValue.toFixed(2)}</span>`;
                    }
                });
            }

            async function loadPurchaseOrder(poId) {
                currentPoId = poId;
                if (!poId) {
                    document.getElementById('po-print-area').innerHTML = '<p class="text-center text-gray-500">Select a Purchase Order to view its details.</p>';
                    currentPoData = null;
                    return;
                }
                const poDoc = await db.collection('purchaseOrders').doc(poId).get();
                if (poDoc.exists) {
                    currentPoData = { id: poDoc.id, ...poDoc.data() };
                    updatePrintView(currentPoData);
                }
            }

            function showDeleteConfirmation(id, type) {
                itemToDelete = { id, type };
                const modalTitle = deleteConfirmationModal.querySelector('#delete-modal-title');
                const modalText = deleteConfirmationModal.querySelector('#delete-modal-text');

                switch (type) {
                    case 'product':
                        modalTitle.textContent = 'Delete Product?';
                        modalText.textContent = 'Are you sure you want to delete this product? This action cannot be undone.';
                        break;
                    case 'po':
                        modalTitle.textContent = 'Delete Purchase Order?';
                        modalText.textContent = 'Are you sure you want to delete this PO? This action cannot be undone.';
                        break;
                    case 'all-products':
                         modalTitle.textContent = 'Delete ALL Products?';
                        modalText.textContent = 'Are you absolutely sure you want to delete ALL products? This action is permanent and cannot be undone.';
                        break;
                }

                deleteConfirmationModal.classList.remove('hidden');
            }

            function hideDeleteConfirmation() {
                itemToDelete = { id: null, type: null };
                deleteConfirmationModal.classList.add('hidden');
            }

            async function deletePurchaseOrder() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('purchaseOrders').doc(itemToDelete.id).delete();
                    if (!poDetailView.classList.contains('hidden')) {
                        showPoList();
                    }
                } catch (error) {
                    console.error("Error deleting PO:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }

            async function deleteProduct() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('products').doc(itemToDelete.id).delete();
                } catch (error) {
                    console.error("Error deleting product:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function deleteAllProducts() {
                productImportStatus.textContent = 'Deleting all products... This may take a moment.';
                productImportStatus.className = 'mt-4 text-sm text-yellow-600';
                try {
                    const productsRef = db.collection('products');
                    const snapshot = await productsRef.get();
                    if (snapshot.empty) {
                        productImportStatus.textContent = 'There are no products to delete.';
                        productImportStatus.className = 'mt-4 text-sm text-gray-600';
                        hideDeleteConfirmation();
                        return;
                    }

                    // Firestore batches are limited to 500 operations.
                    const batchSize = 500;
                    let batch = db.batch();
                    let count = 0;

                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count % batchSize === 0) {
                            await batch.commit();
                            batch = db.batch(); // Start a new batch
                        }
                    }

                    if (count % batchSize !== 0) {
                        await batch.commit(); // Commit the final batch
                    }
                    
                    productImportStatus.textContent = `Successfully deleted ${count} products.`;
                    productImportStatus.className = 'mt-4 text-sm text-green-600';

                } catch (error) {
                    console.error("Error deleting all products:", error);
                    productImportStatus.textContent = `Error: ${error.message}`;
                    productImportStatus.className = 'mt-4 text-sm text-red-600';
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            // --- EVENT LISTENERS ---

            productCodeInput.addEventListener('input', () => {
                const code = productCodeInput.value.trim().toLowerCase();
                if (code.length < 2) {
                    productPreview.classList.add('hidden');
                    return;
                }

                // Prioritize exact match
                let product = allProducts.find(p =>
                    (p["Product Code"] || "").toLowerCase() === code ||
                    (p["Barcode"] || "").toLowerCase() === code
                );

                // If no exact match, try endsWith match
                if (!product) {
                    product = allProducts.find(p =>
                        (p["Product Code"] || "").toLowerCase().endsWith(code) ||
                        (p["Barcode"] || "").toLowerCase().endsWith(code)
                    );
                }
                
                if (product) {
                    const cost = parseFloat(product.Cost) || 0;
                    const vendor = product["Product Category"] || "Unknown";
                    const currency = vendorSettings[vendor] || 'KHR';
                    const currencySymbol = currency === 'KHR' ? '៛' : '$';
                    productPreview.innerHTML = `
                        <p class="font-semibold text-gray-800">${product.Name}</p>
                        <p class="text-sm text-gray-500">Vendor: <span class="font-medium text-gray-700">${vendor}</span></p>
                        <p class="text-sm text-gray-500">Cost: <span class="font-medium text-gray-700">${cost.toFixed(2)} ${currencySymbol}</span></p>
                    `;
                    productPreview.classList.remove('hidden');
                } else {
                    productPreview.classList.add('hidden');
                }
            });

            // Hide preview when clicking outside
            document.addEventListener('click', (e) => {
                if (!productCodeInput.contains(e.target) && !productPreview.contains(e.target)) {
                    productPreview.classList.add('hidden');
                }
            });

            addToPoButton.addEventListener('click', handleAddToPO);
            requestShopDropdown.addEventListener('change', updateRequestHeader);
            poTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-item')) {
                    const index = parseInt(e.target.closest('tr').dataset.index);
                    poItems.splice(index, 1);
                    renderRequestPOTable();
                }
                if (e.target.classList.contains('edit-item')) {
                    const tr = e.target.closest('tr');
                    const index = parseInt(tr.dataset.index);
                    const item = poItems[index];

                    // Populate and show the modal
                    document.getElementById('edit-po-item-index').value = index;
                    document.getElementById('modal-edit-product-name').value = item.Name;
                    document.getElementById('modal-edit-quantity').value = item.quantity;
                    document.getElementById('modal-edit-cost').value = item.Cost;
                    
                    editPoItemModal.classList.remove('hidden');
                }
            });

            cancelEditPoItemBtn.addEventListener('click', () => {
                editPoItemModal.classList.add('hidden');
            });

            saveEditPoItemBtn.addEventListener('click', () => {
                const index = parseInt(document.getElementById('edit-po-item-index').value);
                const newQuantity = parseInt(document.getElementById('modal-edit-quantity').value);
                const newCost = parseFloat(document.getElementById('modal-edit-cost').value);

                if (isNaN(index) || isNaN(newQuantity) || isNaN(newCost) || newQuantity <= 0) {
                    alert("Please enter valid quantity and cost.");
                    return;
                }

                // Update the item in the poItems array
                poItems[index].quantity = newQuantity;
                poItems[index].Cost = newCost;

                // Re-render the table and hide the modal
                renderRequestPOTable();
                editPoItemModal.classList.add('hidden');
            });


            createPoBtn.addEventListener('click', async () => {
                if (poItems.length === 0) {
                    alert("Please add items to the request form first.");
                    return;
                }
                updateRequestHeader(); // Ensure header is up to date

                const counterRef = db.collection('counters').doc('purchaseOrder');
                let newPoNumber;
                try {
                    newPoNumber = await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const lastNumber = counterDoc.data()?.lastPoNumber || 0;
                        const newNumber = lastNumber + 1;
                        transaction.set(counterRef, { lastPoNumber: newNumber }, { merge: true });
                        const paddedNumber = String(newNumber).padStart(5, '0');
                        return requestPoNoInput.value.replace('PENDING', paddedNumber);
                    });
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    alert("Could not generate PO number."); return;
                }

                const newPO = {
                    poNumber: newPoNumber,
                    vendorName: requestVendorInput.value,
                    shopName: requestShopDropdown.value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    exchangeRate: parseFloat(exchangeRateInput.value) || 4100,
                    items: poItems,
                    status: 'Requested'
                };

                try {
                    await db.collection('purchaseOrders').add(newPO);
                    alert(`Purchase Order ${newPoNumber} has been saved!`);
                    poItems = [];
                    renderRequestPOTable();
                    requestVendorInput.value = '';
                    requestPoNoInput.value = '';
                } catch (error) {
                    console.error("Error saving PO:", error);
                    alert("Could not save the PO.");
                }
            });

            poListBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-po-btn');
                const deleteBtn = e.target.closest('.delete-po-btn');

                if (editBtn) {
                    showPoDetails(editBtn.dataset.id);
                } else if (deleteBtn) {
                    showDeleteConfirmation(deleteBtn.dataset.id, 'po');
                }
            });

            backToListBtn.addEventListener('click', showPoList);

            updateGoodsBtn.addEventListener('click', () => {
                if (!currentPoData) return;
                printTableBody.querySelectorAll('tr').forEach(row => {
                    const qtyEl = row.querySelector('[data-field="quantity"]');
                    const totalCostKhrEl = row.querySelector('[data-field="totalCostKhr"]');
                    const totalCostUsdEl = row.querySelector('[data-field="totalCostUsd"]');

                    // Make all three fields editable
                    if (qtyEl) qtyEl.contentEditable = true;
                    if (totalCostKhrEl) totalCostKhrEl.contentEditable = true;
                    if (totalCostUsdEl) totalCostUsdEl.contentEditable = true;
                    
                    row.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                        cell.classList.add('bg-yellow-100', 'focus:outline-blue-400');
                        cell.addEventListener('input', () => recalculateDetailView());
                    });
                });
                updateGoodsBtn.classList.add('hidden');
                saveUpdatesBtn.classList.remove('hidden');
            });

            saveUpdatesBtn.addEventListener('click', async () => {
                if (!currentPoId || !currentPoData) return;
                const poDocRef = db.collection('purchaseOrders').doc(currentPoId);
                const updatedItems = JSON.parse(JSON.stringify(currentPoData.items));
                let hasChanges = false;

                printTableBody.querySelectorAll('tr').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    const item = updatedItems[index];
                    const qty = parseInt(row.querySelector('[data-field="quantity"]').textContent);
                    let newUnitCost = parseFloat(item.Cost); // Default to old value

                    if (item.currency?.toUpperCase() === 'KHR') {
                        const totalCostKhrText = row.querySelector('[data-field="totalCostKhr"]').textContent;
                        if (totalCostKhrText !== '-') {
                            const totalCostKhr = parseFloat(totalCostKhrText);
                            if (!isNaN(totalCostKhr) && qty > 0) {
                                newUnitCost = totalCostKhr / qty;
                            }
                        }
                    } else if (item.currency?.toUpperCase() === 'USD') {
                        const totalCostUsdText = row.querySelector('[data-field="totalCostUsd"]').textContent;
                        if (totalCostUsdText !== '-') {
                            const totalCostUsd = parseFloat(totalCostUsdText);
                            if (!isNaN(totalCostUsd) && qty > 0) {
                                newUnitCost = totalCostUsd / qty;
                            }
                        }
                    }

                    if (item.quantity !== qty) {
                        item.quantity = qty;
                        hasChanges = true;
                    }

                    // Check if newUnitCost is a valid number and has changed significantly
                    if (!isNaN(newUnitCost) && Math.abs(item.Cost - newUnitCost) > 0.001) {
                        item.Cost = newUnitCost;
                        hasChanges = true;
                    }
                });

                if (hasChanges) {
                    try {
                        await poDocRef.update({ items: updatedItems });
                        alert("PO updated successfully!");
                        await loadPurchaseOrder(currentPoId); // Reload
                    } catch (error) {
                        console.error("Error updating PO:", error);
                        alert("Failed to update PO.");
                    }
                }
                
                printTableBody.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                    cell.contentEditable = false;
                    cell.classList.remove('bg-yellow-100', 'focus:outline-blue-400');
                    // Event listeners are removed automatically when the table is re-rendered by loadPurchaseOrder
                });
                updateGoodsBtn.classList.remove('hidden');
                saveUpdatesBtn.classList.add('hidden');
            });

            confirmDeleteBtn.addEventListener('click', () => {
                switch (itemToDelete.type) {
                    case 'po':
                        deletePurchaseOrder();
                        break;
                    case 'product':
                        deleteProduct();
                        break;
                    case 'all-products':
                        deleteAllProducts();
                        break;
                }
            });
            cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
            deletePoDetailBtn.addEventListener('click', () => {
                if (currentPoId) {
                    showDeleteConfirmation(currentPoId, 'po');
                }
            });

            // Filter listeners
            filterShop.addEventListener('input', applyAndRenderFilters);
            filterDate.addEventListener('input', applyAndRenderFilters);
            filterVendor.addEventListener('input', applyAndRenderFilters);
            clearFiltersBtn.addEventListener('click', () => {
                filterShop.value = '';
                filterDate.value = '';
                filterVendor.value = '';
                applyAndRenderFilters();
            });
            
            // --- Initial Load and Listeners ---
            signIn().then(() => {
                if (!isFirebaseInitialized) return;
                loadAndCacheProducts();
                listenForShops();
                db.collection('purchaseOrders').orderBy("createdAt", "desc").onSnapshot((snapshot) => {
                    allPurchaseOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyAndRenderFilters();
                });
            });

            // Tab switching logic
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // When switching main tabs, always hide the detail view and show the list view within the POs Center
                    poDetailView.classList.add('hidden');
                    if (poListView) poListView.classList.remove('hidden');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    const activeTabContent = document.getElementById(tab.dataset.tab);
                    if(activeTabContent) activeTabContent.classList.add('active');
                });
            });

            const settingTabs = document.querySelectorAll('.setting-tab');
            const settingTabContents = document.querySelectorAll('.setting-tab-content');
            settingTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    settingTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    settingTabContents.forEach(content => content.style.display = 'none');
                    document.getElementById(tab.dataset.tab).style.display = 'block';
                });
            });
            
            // Settings Page Listeners
            addShopBtn.addEventListener('click', async () => {
                const name = shopNameInput.value.trim();
                const address = shopAddressInput.value.trim();
                const contact = shopContactInput.value.trim();
                if (!name) return;
                try {
                    await db.collection(`shops`).add({ name, address, contact });
                    shopNameInput.value = '';
                    shopAddressInput.value = '';
                    shopContactInput.value = '';
                } catch (error) {
                    console.error("Error adding shop:", error);
                }
            });

            shopListBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-shop-btn')) {
                    const id = e.target.closest('tr').dataset.id;
                    try {
                        await db.collection(`shops`).doc(id).delete();
                    } catch (error) {
                        console.error("Error deleting shop:", error);
                    }
                }
            });
            
            saveVendorSettingsBtn?.addEventListener('click', async () => {
                const selects = document.querySelectorAll('.vendor-currency-select');
                const batch = db.batch();
                selects.forEach(select => {
                    const vendor = select.dataset.vendor;
                    const currency = select.value;
                    const docRef = db.collection("vendorSettings").doc(vendor);
                    batch.set(docRef, { currency: currency });
                });
                try {
                    await batch.commit();
                    alert('Vendor settings saved!');
                    await loadVendorSettings();
                } catch (error) {
                    console.error("Error saving vendor settings:", error);
                    alert('Error saving settings.');
                }
            });
            
            // Product Data Page Listeners
            addProductBtn.addEventListener('click', () => {
                document.getElementById('product-modal-title').textContent = 'Add New Product';
                document.getElementById('product-id').value = '';
                document.getElementById('modal-product-code').value = '';
                document.getElementById('modal-barcode').value = '';
                document.getElementById('modal-product-name').value = '';
                document.getElementById('modal-product-category').value = '';
                document.getElementById('modal-product-cost').value = '';
                document.getElementById('modal-product-price').value = '';
                productModal.classList.remove('hidden');
            });

            cancelProductBtn.addEventListener('click', () => {
                productModal.classList.add('hidden');
            });

            saveProductBtn.addEventListener('click', async () => {
                const id = document.getElementById('product-id').value;
                const productCode = document.getElementById('modal-product-code').value.trim().toUpperCase();

                if (!productCode) {
                    alert("Product Code cannot be empty.");
                    return;
                }

                // Check for duplicates only when adding a NEW product
                if (!id) {
                    const productsRef = db.collection('products');
                    const q = productsRef.where('Product Code', '==', productCode).limit(1);
                    const snapshot = await q.get();
                    if (!snapshot.empty) {
                        alert(`A product with code "${productCode}" already exists.`);
                        return;
                    }
                }

                const productData = {
                    "Product Code": productCode,
                    "Barcode": document.getElementById('modal-barcode').value,
                    "Name": document.getElementById('modal-product-name').value,
                    "Product Category": document.getElementById('modal-product-category').value,
                    "Cost": parseFloat(document.getElementById('modal-product-cost').value) || 0,
                    "Price": parseFloat(document.getElementById('modal-product-price').value) || 0
                };

                try {
                    if (id) {
                        // Update existing product
                        await db.collection('products').doc(id).update(productData);
                    } else {
                        // Add new product
                        await db.collection('products').add(productData);
                    }
                    productModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving product:", error);
                    alert("Could not save product.");
                }
            });

            productListBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-product-btn');
                const deleteBtn = e.target.closest('.delete-product-btn');

                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const product = allProducts.find(p => p.id === id);
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'Edit Product';
                        document.getElementById('product-id').value = product.id;
                        document.getElementById('modal-product-code').value = product["Product Code"] || '';
                        document.getElementById('modal-barcode').value = product.Barcode || '';
                        document.getElementById('modal-product-name').value = product.Name || '';
                        document.getElementById('modal-product-category').value = product["Product Category"] || '';
                        document.getElementById('modal-product-cost').value = findValue(product, ['Cost']) || 0;
                        document.getElementById('modal-product-price').value = findValue(product, ['Price', 'Sales Price']) || 0;
                        productModal.classList.remove('hidden');
                    }
                } else if (deleteBtn) {
                    showDeleteConfirmation(deleteBtn.dataset.id, 'product');
                }
            });
            
            productSearchInput.addEventListener('input', () => {
                productCurrentPage = 1;
                renderProductList();
            });

            exportProductsBtn.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => 
                    (p.Name || '').toLowerCase().includes(searchTerm) || 
                    (p["Product Code"] || '').toLowerCase().includes(searchTerm)
                );

                // Remove the 'id' field for a cleaner export
                const productsToExport = filteredProducts.map(({ id, ...rest }) => rest);

                const worksheet = XLSX.utils.json_to_sheet(productsToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
                XLSX.writeFile(workbook, "ProductData.xlsx");
            });

            importProductsBtn.addEventListener('click', () => {
                const file = productFileInput.files[0];
                if (!file) {
                    productImportStatus.textContent = 'Please select a file to import.';
                    productImportStatus.className = 'mt-4 text-sm text-red-600';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        productImportStatus.textContent = 'Reading file...';
                        productImportStatus.className = 'mt-4 text-sm text-gray-600';
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const productsFromFile = XLSX.utils.sheet_to_json(worksheet);

                        if (productsFromFile.length === 0) {
                            productImportStatus.textContent = 'No products found in the file.';
                            productImportStatus.className = 'mt-4 text-sm text-yellow-600';
                            return;
                        }

                        productImportStatus.textContent = `Found ${productsFromFile.length} products. Checking against database...`;
                        
                        // Fetch all existing product codes once for efficient lookup
                        const existingProductsSnapshot = await db.collection('products').get();
                        const existingProductsMap = new Map();
                        existingProductsSnapshot.forEach(doc => {
                            existingProductsMap.set(doc.data()['Product Code'], doc.id);
                        });

                        productImportStatus.textContent = `Preparing updates...`;

                        const batch = db.batch();
                        let updatedCount = 0;
                        let newCount = 0;

                        for (const product of productsFromFile) {
                            const rawProductCode = findValue(product, ['Product Code']);
                            if (!rawProductCode) continue; // Skip rows without a product code
                            
                            const productCode = rawProductCode.toString().trim().toUpperCase();
                            if (!productCode) continue;

                            const productData = {
                                "Product Code": productCode,
                                "Barcode": findValue(product, ['Barcode']) || '',
                                "Name": findValue(product, ['Name']) || '',
                                "Product Category": findValue(product, ['Product Category']) || '',
                                "Cost": parseFloat(findValue(product, ['Cost'])) || 0,
                                "Price": parseFloat(findValue(product, ['Price', 'Sales Price'])) || 0,
                            };
                            
                            const existingDocId = existingProductsMap.get(productCode);
                            
                            if (existingDocId) {
                                // Product exists, update it
                                const docRef = db.collection('products').doc(existingDocId);
                                batch.update(docRef, productData);
                                updatedCount++;
                            } else {
                                // Product doesn't exist, add new
                                const newDocRef = db.collection('products').doc();
                                batch.set(newDocRef, productData);
                                newCount++;
                            }
                        }

                        await batch.commit();
                        productImportStatus.textContent = `Import complete! ${newCount} products added, ${updatedCount} products updated.`;
                        productImportStatus.className = 'mt-4 text-sm text-green-600';
                        productFileInput.value = ''; // Clear the file input

                    } catch (error) {
                        console.error("Error importing products:", error);
                        productImportStatus.textContent = `Error during import: ${error.message}`;
                        productImportStatus.className = 'mt-4 text-sm text-red-600';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            deleteAllProductsBtn.addEventListener('click', () => {
                showDeleteConfirmation(null, 'all-products');
            });

            // PDF Buttons
            requestSavePdfBtn.addEventListener('click', () => {
                const element = document.getElementById('pdf-template-area');
                const selectedShopName = requestShopDropdown.value;
                const selectedShop = shops.find(s => s.name === selectedShopName) || {};

                document.getElementById('pdf-vendor').textContent = requestVendorInput.value;
                document.getElementById('pdf-shop').textContent = selectedShopName;
                document.getElementById('pdf-address').textContent = selectedShop.address || '';
                document.getElementById('pdf-po-no').textContent = requestPoNoInput.value.replace('-PENDING', '');
                document.getElementById('pdf-po-date').textContent = requestPoDateInput.value;
                document.getElementById('pdf-contact').textContent = selectedShop.contact || '';

                const pdfTableBody = document.getElementById('pdf-table-body');
                pdfTableBody.innerHTML = '';
                let totalRows = 15;
                poItems.forEach((item, index) => {
                    const cost = parseFloat(item.Cost) || 0;
                    const costKhrDisplay = '&nbsp;'; // Hide KHR cost value as requested
                    const costUsdDisplay = item.currency === 'USD' ? cost.toFixed(2) : '&nbsp;';
                    const row = `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item["Product Code"]}</td>
                            <td>${item.Barcode || ''}</td>
                            <td>${item.Name}</td>
                            <td style="text-align: center;">${item.quantity}</td>
                            <td style="text-align: right;">${costKhrDisplay}</td>
                            <td style="text-align: right;">${costUsdDisplay}</td>
                            <td style="text-align: right;">${cost.toFixed(2)}</td>
                        </tr>`;
                    pdfTableBody.insertAdjacentHTML('beforeend', row);
                });

                for(let i = poItems.length; i < totalRows; i++) {
                    const emptyRow = `<tr>
                        <td style="height: 2.2em;"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>`;
                     pdfTableBody.insertAdjacentHTML('beforeend', emptyRow);
                }
                
                // Temporarily make the element visible for rendering
                element.style.position = 'absolute';
                element.style.left = '0px';
                element.style.top = '0px';
                element.style.opacity = '1';
                element.style.zIndex = '1000';


                const { jsPDF } = window.jspdf;
                html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                    // Hide element again after capture
                    element.style.position = 'fixed';
                    element.style.left = '-9999px';
                    element.style.opacity = '0';
                    element.style.zIndex = '-10';

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${requestPoNoInput.value || 'request'}.pdf`);
                });
            });
            
            detailSavePdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('po-print-area');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / pdfWidth;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight / ratio);
                    pdf.save(`${printPoNumberEl.textContent || 'details'}.pdf`);
                });
            });

        });
    </script>
</body>
</html>
