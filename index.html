<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Angkor&family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .ang-daunkeo {
            font-family: 'Kantumruy Pro', sans-serif; /* Using Kantumruy as a close web-safe alternative to Ang DaunKeo */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab {
            transition: all 0.2s ease-in-out;
            border-bottom-color: transparent;
        }
        /* Color highlighting for active tabs */
        .tab.active-indigo { border-bottom-color: #4f46e5; color: #4f46e5; }
        .tab.active-amber { border-bottom-color: #f59e0b; color: #f59e0b; }
        .tab.active-blue { border-bottom-color: #2563eb; color: #2563eb; }
        .tab.active-emerald { border-bottom-color: #059669; color: #059669; }
        .tab.active-slate { border-bottom-color: #475569; color: #475569; }

        .setting-tab.active-slate { border-bottom-color: #475569; color: #475569; }
        
        /* Styles for the hidden PDF template */
        #pdf-template-area {
            box-sizing: border-box;
        }
        #pdf-template-area * {
            box-sizing: border-box;
        }
        #pdf-template-area table {
            border-collapse: collapse;
            width: 100%;
        }
        #pdf-template-area th, #pdf-template-area td {
            border: 1px solid black;
            padding: 8px; /* Increased padding for better spacing */
            text-align: left;
            vertical-align: middle; /* Vertically center text */
        }
        #pdf-template-area th {
            text-align: center; /* Center header text */
        }

        /* Mobile-first responsive table styles */
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none; /* Hide table headers on mobile */
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                padding: 1rem;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f1f5f9;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
                color: #475569;
            }
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 15mm;
            }
            body * {
                visibility: hidden;
            }
            #request-print-area, #request-print-area *,
            #po-print-area, #po-print-area * {
                visibility: visible;
            }
            #request-print-area, #po-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 10pt;
            }
            .no-print {
                display: none;
            }
            h1 {
                font-size: 18pt;
            }
        }
    </style>
</head>
<body class="bg-slate-900">

    <!-- Login Page Container -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-100">
                    Sign in to your account
                </h2>
                <p class="mt-2 text-center text-sm text-slate-400">
                    This application is used for Internal POs ONLY!
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-slate-600 bg-slate-700 placeholder-slate-400 text-white rounded-t-md focus:outline-none focus:ring-red-500 focus:border-red-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-slate-600 bg-slate-700 placeholder-slate-400 text-white rounded-b-md focus:outline-none focus:ring-red-500 focus:border-red-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-slate-600 rounded bg-slate-700">
                        <label for="remember-me" class="ml-2 block text-sm text-slate-300">
                            Remember me
                        </label>
                    </div>

                    <div class="text-sm">
                        <a href="#" class="font-medium text-red-500 hover:text-red-400">
                            Forgot your password?
                        </a>
                    </div>
                </div>
                
                <div id="login-error-container" class="hidden p-3 bg-red-900/50 border border-red-700 rounded-md">
                    <p id="login-error-message" class="text-sm text-red-300"></p>
                </div>

                <div>
                    <button type="submit" id="login-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-red-500">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-red-400 group-hover:text-red-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden bg-slate-100 text-slate-800">
        <div class="container mx-auto p-2 sm:p-4 lg:p-8 max-w-7xl">
            <div class="bg-white rounded-2xl shadow-lg">

                <!-- Tabs Navigation -->
                <div class="border-b border-slate-200 no-print flex justify-between items-center pr-4">
                    <nav id="main-tabs" class="-mb-px flex space-x-4 sm:space-x-8 px-4 sm:px-6 md:px-8" aria-label="Tabs">
                        <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="po-request-form">
                            Purchase Order Page
                        </button>
                        <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="drafts-page">
                            Drafts
                        </button>
                        <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="purchase-order">
                            POs Center
                        </button>
                        <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="product-data-page">
                            Product Data
                        </button>
                        <button class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="setting-page">
                            Settings
                        </button>
                    </nav>
                    <button id="logout-button" class="bg-red-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Logout</button>
                </div>

                <div class="p-4 sm:p-6 md:p-8">
                    <!-- PO Request Form Content -->
                    <div id="po-request-form" class="tab-content">
                        <div>
                            <h1 class="text-3xl font-bold text-indigo-600 mb-6">Purchase Order Request</h1>
                            
                            <div class="bg-slate-50 rounded-xl p-4 sm:p-6 mb-6 border border-slate-200">
                                <h2 class="text-xl font-semibold mb-4 text-slate-800">PO Request Data</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                                    <div>
                                        <label for="request-vendor-dropdown" class="block text-sm font-medium text-slate-700">Vendor</label>
                                        <select id="request-vendor-dropdown" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                    </div>
                                    <div>
                                        <label for="request-shop-dropdown" class="block text-sm font-medium text-slate-700">Request By</label>
                                        <select id="request-shop-dropdown" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                    </div>
                                    <div>
                                        <label for="request-po-no" class="block text-sm font-medium text-slate-700">PO No.</label>
                                        <input type="text" id="request-po-no" readonly class="mt-1 block w-full bg-slate-200 border-slate-300 rounded-lg shadow-sm cursor-not-allowed">
                                    </div>
                                    <div>
                                        <label for="request-po-date" class="block text-sm font-medium text-slate-700">PO Date</label>
                                        <input type="text" id="request-po-date" readonly class="mt-1 block w-full bg-slate-200 border-slate-300 rounded-lg shadow-sm cursor-not-allowed">
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-6 border-t border-slate-200 no-print">
                                    <h2 class="text-xl font-semibold mb-4 text-slate-800">Add Product to PO</h2>
                                    <div id="lookup-form">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                                            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div class="relative">
                                                    <label for="product-code" class="block text-sm font-medium text-slate-700 mb-1">Product Code/Barcode</label>
                                                    <input type="text" id="product-code" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter code...">
                                                    <div id="product-preview" class="hidden absolute z-10 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg p-3">
                                                        <!-- Live preview content goes here -->
                                                    </div>
                                                </div>
                                                <div>
                                                    <label for="quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                                                    <input type="number" id="quantity" value="1" min="1" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2 mt-7">
                                                <button id="add-to-po" class="w-full bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 h-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add</button>
                                                <button id="cancel-add-product" type="button" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 h-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">Cancel</button>
                                            </div>
                                        </div>
                                        <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white responsive-table">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">No.</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Product Code</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Barcode</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Product Name</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Vendor</th>
                                            <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Qty</th>
                                            <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Cost (KHR)</th>
                                            <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Cost (USD)</th>
                                            <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Sub-Total</th>
                                            <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">CB4</th>
                                            <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="po-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                         <div id="submission-status" class="text-right mt-4 h-6"></div>
                         <div class="mt-2 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 no-print">
                            <button id="save-draft-btn" class="bg-slate-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-slate-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Save as Draft</button>
                            <button id="submit-pr-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Submit PR</button>
                            <button id="cancel-po-request-btn" type="button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Cancel Request</button>
                        </div>
                    </div>
                    
                    <!-- Drafts Page Content -->
                    <div id="drafts-page" class="tab-content">
                        <h1 class="text-3xl font-bold text-amber-500 mb-6">Saved Drafts</h1>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white responsive-table">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">No.</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Date</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Shop</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">PO No.</th>
                                        <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="drafts-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>


                    <!-- POs Center Content -->
                    <div id="purchase-order" class="tab-content">
                        <div id="po-list-view">
                            <h1 class="text-3xl font-bold text-blue-600 mb-6">Purchase Order Center</h1>
                            
                            <!-- Filter Controls -->
                            <div class="bg-slate-50 rounded-xl p-4 sm:p-6 mb-6 border border-slate-200">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                    <div>
                                        <label for="filter-shop" class="block text-sm font-medium text-slate-700">Shop</label>
                                        <select id="filter-shop" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                    </div>
                                    <div>
                                        <label for="filter-date" class="block text-sm font-medium text-slate-700">Req. Date</label>
                                        <input type="date" id="filter-date" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label for="filter-vendor" class="block text-sm font-medium text-slate-700">Vendor</label>
                                        <input type="text" id="filter-vendor" placeholder="Enter vendor name..." class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <button id="clear-filters-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Clear Filters</button>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white responsive-table">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">No.</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">PO Number</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Request Date</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Vendor</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Shop</th>
                                            <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="po-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="po-detail-view" class="hidden">
                            <button id="back-to-list-btn" class="mb-6 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">&larr; Back to PO List</button>
                            <div id="po-print-area" class="border border-slate-200 p-4 sm:p-6 rounded-lg">
                                <h2 class="text-2xl font-bold text-slate-800 mb-4" id="po-number-display"></h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                    <div>
                                        <p><strong>Vendor:</strong> <span id="print-vendor-name"></span></p>
                                        <p><strong>Request by:</strong> <span id="print-shop-name"></span></p>
                                    </div>
                                    <div class="text-left sm:text-right lg:text-left">
                                        <p><strong>PO Number:</strong> <span id="print-po-number"></span></p>
                                        <p><strong>Date:</strong> <span id="print-date"></span></p>
                                    </div>
                                    <div class="sm:col-span-2 lg:col-span-1 text-left sm:text-right">
                                        <div class="no-print">
                                            <label for="detail-exchange-rate" class="block text-sm font-medium text-slate-700">Exchange Rate (KHR to 1 USD)</label>
                                            <input type="number" id="detail-exchange-rate" value="4100" class="mt-1 block w-full max-w-xs ml-auto border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white">
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="p-3 text-left text-sm font-semibold">No.</th>
                                                <th class="p-3 text-left text-sm font-semibold">Product Name</th>
                                                <th class="p-3 text-center text-sm font-semibold">Qty</th>
                                                <th class="p-3 text-right text-sm font-semibold">Total Cost (KHR)</th>
                                                <th class="p-3 text-right text-sm font-semibold">Total Cost (USD)</th>
                                                <th class="p-3 text-right text-sm font-semibold">Cost/Unit (KHR)</th>
                                                <th class="p-3 text-right text-sm font-semibold">CheckUp</th>
                                            </tr>
                                        </thead>
                                        <tbody id="print-table-body" class="divide-y divide-slate-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mt-6 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 no-print">
                                <button id="update-goods-btn" class="bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">Update Manually</button>
                                <button id="save-updates-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hidden shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Updates</button>
                                <button id="detail-save-pdf-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save as PDF</button>
                                <button id="delete-po-detail-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete PO</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product Data Page Content -->
                    <div id="product-data-page" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h1 class="text-3xl font-bold text-emerald-600">
                                Product Data Management 
                                <span id="product-total-count" class="text-lg font-medium text-slate-500 ml-2"></span>
                            </h1>
                            <div class="w-full sm:w-auto flex flex-wrap gap-2">
                                <input type="text" id="product-search-input" placeholder="Search by name or code..." class="w-full sm:w-auto flex-grow px-4 py-2 bg-white border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                <button id="add-product-btn" class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 whitespace-nowrap">Add Product</button>
                                <button id="export-products-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap">Export to Excel</button>
                            </div>
                        </div>

                        <div class="bg-slate-50 rounded-xl p-4 sm:p-6 mb-6 border border-slate-200">
                            <h2 class="text-xl font-semibold mb-4 text-slate-800">Import / Export</h2>
                            <div class="flex flex-col sm:flex-row items-center gap-4">
                                <input type="file" id="product-file-input" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                                <button id="import-products-btn" class="w-full sm:w-auto bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-emerald-700 whitespace-nowrap">Import Products</button>
                            </div>
                            <div id="product-import-status" class="mt-4 text-sm"></div>
                            <div class="mt-6 pt-4 border-t border-slate-200">
                                 <button id="delete-all-products-btn" class="w-full sm:w-auto bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    Delete All Products
                                </button>
                                <p class="text-xs text-slate-500 mt-2">Permanently delete all product data. This action cannot be undone.</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white responsive-table">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Product Code</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Barcode</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Product Name</th>
                                        <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Category</th>
                                        <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase">Cost</th>
                                        <th class="p-3 text-right text-xs font-semibold text-slate-700 uppercase">Price</th>
                                        <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="product-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                        <div id="product-pagination-controls" class="mt-6 flex flex-col sm:flex-row justify-between items-center text-sm text-slate-600">
                            <div>
                                <label for="items-per-page" class="mr-2">Show:</label>
                                <select id="items-per-page" class="border-slate-300 rounded-lg shadow-sm">
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span class="ml-4" id="product-list-summary"></span>
                            </div>
                            <div class="flex items-center mt-4 sm:mt-0">
                                <span id="page-info" class="mr-4"></span>
                                <button id="prev-page-btn" class="px-3 py-1 border rounded-lg hover:bg-slate-100 disabled:opacity-50" disabled>&larr; Previous</button>
                                <button id="next-page-btn" class="px-3 py-1 border rounded-lg hover:bg-slate-100 disabled:opacity-50 ml-2" disabled>Next &rarr;</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Setting Page Content -->
                    <div id="setting-page" class="tab-content">
                         <h1 class="text-3xl font-bold text-slate-600 mb-2">Settings</h1>
                         <div class="border-b border-slate-200 mb-4">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button class="setting-tab active-slate whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="shop-list">Shop List</button>
                                <button class="setting-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500" data-tab="vendor-list">Vendor List</button>
                                <button class="setting-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500" data-tab="employees">Employees</button>
                            </nav>
                        </div>

                        <div id="shop-list" class="setting-tab-content active">
                             <p class="text-slate-600 mb-6">Add, view, or remove shops from your list.</p>
                             <div class="bg-slate-50 rounded-xl p-6 mb-6 border border-slate-200 max-w-2xl mx-auto">
                                <h2 class="text-xl font-semibold mb-4">Add New Shop</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="shop-name" class="block text-sm font-medium text-slate-700">Shop Name</label>
                                        <input type="text" id="shop-name" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter shop name...">
                                    </div>
                                    <div>
                                        <label for="shop-address" class="block text-sm font-medium text-slate-700">Address</label>
                                        <input type="text" id="shop-address" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter address...">
                                    </div>
                                    <div>
                                        <label for="shop-contact" class="block text-sm font-medium text-slate-700">Contact Number</label>
                                        <input type="text" id="shop-contact" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter contact number...">
                                    </div>
                                    <button id="add-shop-btn" class="w-full bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-slate-700">Add Shop</button>
                                </div>
                             </div>
                             <div class="overflow-x-auto max-w-2xl mx-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm border border-slate-100">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Shop Name</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Address</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Contact</th>
                                            <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shop-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                             </div>
                        </div>
                        <div id="vendor-list" class="setting-tab-content" style="display:none;">
                            <p class="text-slate-600 mb-6">Add, view, or remove vendors from your list.</p>
                            <div class="bg-slate-50 rounded-xl p-6 mb-6 border border-slate-200 max-w-2xl mx-auto">
                               <h2 class="text-xl font-semibold mb-4">Add New Vendor</h2>
                               <div class="space-y-4">
                                   <div>
                                       <label for="vendor-name" class="block text-sm font-medium text-slate-700">Vendor Name</label>
                                       <input type="text" id="vendor-name" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter vendor name...">
                                   </div>
                                   <div>
                                       <label for="vendor-contact" class="block text-sm font-medium text-slate-700">Contact</label>
                                       <input type="text" id="vendor-contact" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter contact...">
                                   </div>
                                   <div>
                                       <label for="vendor-address" class="block text-sm font-medium text-slate-700">Address</label>
                                       <input type="text" id="vendor-address" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg" placeholder="Enter address...">
                                   </div>
                                   <button id="add-vendor-btn" class="w-full bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-slate-700">Add Vendor</button>
                               </div>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-6 mb-6 border border-slate-200 max-w-2xl mx-auto">
                                <h2 class="text-xl font-semibold mb-4">Import Vendors from Excel</h2>
                                <input type="file" id="vendor-file" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100">
                                <button id="import-vendors-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Import Vendors</button>
                                <div id="import-status" class="mt-4 text-sm"></div>
                            </div>
                            <div class="overflow-x-auto max-w-2xl mx-auto">
                               <table class="min-w-full bg-white rounded-lg shadow-sm border border-slate-100">
                                   <thead class="bg-slate-100">
                                       <tr>
                                           <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Vendor Name</th>
                                           <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Contact</th>
                                           <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Address</th>
                                           <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                       </tr>
                                   </thead>
                                   <tbody id="vendor-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                               </table>
                            </div>
                       </div>
                       <div id="employees" class="setting-tab-content" style="display:none;">
                            <div class="flex justify-between items-center mb-6">
                                <p class="text-slate-600">Manage employee access and permissions.</p>
                                <button id="add-employee-btn" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700">Add Employee</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white responsive-table">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">UID</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Name</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Position</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Email</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Role</th>
                                            <th class="p-3 text-left text-xs font-semibold text-slate-700 uppercase">Assigned Shops</th>
                                            <th class="p-3 text-center text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employee-list-body" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                       </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden PDF Template for PO Request -->
    <div id="pdf-template-area" class="w-[1123px] p-8 bg-white text-black fixed -left-[9999px] top-0 ang-daunkeo" style="font-size: 14px; opacity: 0; z-index: -10;">
        <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 24px;">Purchase Order</h1>
        <div style="display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 24px;">
            <div>
                <p><strong>Vendor:</strong> <span id="pdf-vendor"></span></p>
                <p><strong>Shop:</strong> <span id="pdf-shop"></span></p>
                <p><strong>Address:</strong> <span id="pdf-address"></span></p>
            </div>
            <div style="text-align: right;">
                <p><strong>PO NO.:</strong> <span id="pdf-po-no"></span></p>
                <p><strong>PO Date:</strong> <span id="pdf-po-date"></span></p>
                <p><strong>Contact:</strong> <span id="pdf-contact"></span></p>
            </div>
        </div>
        <table>
            <thead>
                <tr style="background-color: #e5e7eb;">
                    <th style="width: 5%;">No.</th>
                    <th>Product Code</th>
                    <th>Barcode</th>
                    <th>Product Name</th>
                    <th>Qty</th>
                    <th>Cost (KHR)</th>
                    <th>Cost (USD)</th>
                    <th>Sub-Total</th>
                    <th>CB4</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                <!-- Rows will be injected here -->
            </tbody>
            <tfoot id="pdf-table-footer">
                <!-- Footer will be injected here -->
            </tfoot>
        </table>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; margin-top: 96px;">
            <div>
                <p>Req. By :</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
            <div>
                <p>Received By.:</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
            <div>
                <p>PO Check By:</p>
                <p style="margin-top: 48px;">...................................</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 id="delete-modal-title" class="text-lg leading-6 font-medium text-slate-900">Delete Item?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="delete-modal-text" class="text-sm text-slate-500">
                        Are you sure you want to delete this item? This action cannot be undone.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Delete
                    </button>
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900" id="product-modal-title">Add New Product</h3>
                <div class="mt-4 space-y-4">
                    <input type="hidden" id="product-id">
                    <div>
                        <label for="modal-product-code" class="block text-sm font-medium text-slate-700">Product Code</label>
                        <input type="text" id="modal-product-code" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-barcode" class="block text-sm font-medium text-slate-700">Barcode</label>
                        <input type="text" id="modal-barcode" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-name" class="block text-sm font-medium text-slate-700">Product Name</label>
                        <input type="text" id="modal-product-name" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-category" class="block text-sm font-medium text-slate-700">Category (Vendor)</label>
                        <input type="text" id="modal-product-category" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-cost" class="block text-sm font-medium text-slate-700">Cost</label>
                        <input type="number" id="modal-product-cost" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-product-price" class="block text-sm font-medium text-slate-700">Price</label>
                        <input type="number" id="modal-product-price" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-product-btn" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto mr-2 shadow-sm hover:bg-slate-300">
                        Cancel
                    </button>
                    <button id="save-product-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700">
                        Save Product
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PO Item Edit Modal -->
    <div id="edit-po-item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900" id="edit-po-item-modal-title">Edit PO Item</h3>
                <div class="mt-4 space-y-4">
                    <input type="hidden" id="edit-po-item-index">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Product Name</label>
                        <input type="text" id="modal-edit-product-name" readonly class="mt-1 block w-full bg-slate-200 border-slate-300 rounded-lg shadow-sm cursor-not-allowed">
                    </div>
                    <div>
                        <label for="modal-edit-quantity" class="block text-sm font-medium text-slate-700">Quantity</label>
                        <input type="number" id="modal-edit-quantity" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="modal-edit-cost" class="block text-sm font-medium text-slate-700">Cost</label>
                        <input type="number" id="modal-edit-cost" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="cancel-edit-po-item-btn" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto mr-2 shadow-sm hover:bg-slate-300">
                        Cancel
                    </button>
                    <button id="save-edit-po-item-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost History Modal -->
    <div id="cost-history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900" id="cost-history-modal-title">Cost History</h3>
                <div class="mt-4 overflow-y-auto" style="max-height: 60vh;">
                     <table class="min-w-full bg-white">
                        <thead class="bg-slate-100 sticky top-0">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold">Date</th>
                                <th class="p-3 text-right text-sm font-semibold">Previous Cost (KHR)</th>
                                <th class="p-3 text-right text-sm font-semibold">New Cost (KHR)</th>
                                <th class="p-3 text-left text-sm font-semibold">Source PO</th>
                            </tr>
                        </thead>
                        <tbody id="cost-history-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="close-history-btn" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-slate-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 border-b border-slate-200 pb-4" id="employee-modal-title">Add New Employee</h3>
                <div class="mt-4 space-y-4">
                    <input type="hidden" id="employee-id">
                    <div>
                        <label for="employee-uid" class="block text-sm font-medium text-slate-700">User ID (UID)</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="employee-uid" class="block w-full rounded-none rounded-l-md border-slate-300 bg-slate-100" placeholder="Unique ID for login...">
                            <button type="button" id="generate-uid-btn" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-slate-300 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                                <span>Generate</span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="employee-name" class="block text-sm font-medium text-slate-700">Name</label>
                            <input type="text" id="employee-name" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="employee-position" class="block text-sm font-medium text-slate-700">Position</label>
                            <input type="text" id="employee-position" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="employee-email" class="block text-sm font-medium text-slate-700">Email</label>
                            <input type="email" id="employee-email" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="employee-role" class="block text-sm font-medium text-slate-700">Role</label>
                            <select id="employee-role" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                                <option>Staff</option>
                                <option>Manager</option>
                                <option>Admin</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Assigned Shops</label>
                        <div id="employee-shops-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 border border-slate-200 p-4 rounded-lg h-32 overflow-y-auto">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Page Permissions</label>
                        <div id="employee-permissions" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4 border border-slate-200 p-4 rounded-lg">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right bg-slate-50 -mx-5 -mb-5 rounded-b-md">
                    <button id="cancel-employee-btn" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-auto mr-2 shadow-sm hover:bg-slate-300">
                        Cancel
                    </button>
                    <button id="save-employee-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-indigo-700">
                        Save Employee
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- Main App Logic (runs after DOM is loaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Firebase Configuration and Initialization ---
            const firebaseConfig = {
                apiKey: "AIzaSyBsSA-iUiXFhYmkZQc9sMdkK7FW5HEu9p0",
                authDomain: "po-report-cd3fc.firebaseapp.com",
                projectId: "po-report-cd3fc",
                storageBucket: "po-report-cd3fc.appspot.com",
                messagingSenderId: "115437177983",
                appId: "1:115437177983:web:a0dc6b1046babcff6a034a",
                measurementId: "G-NWFTBZ7F2L"
            };
            
            let app, db, auth, isFirebaseInitialized = false;

            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseInitialized = true;
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayLoginError("Could not connect to the authentication service.");
            }
            
            // --- Application State ---
            let poItems = [];
            let allProducts = []; // Cache for all products
            let shops = []; // Cache for shops
            let vendors = []; // Cache for vendors
            let vendorSettings = {}; // To store currency for each vendor
            let allPurchaseOrders = []; // Cache for all POs
            let drafts = []; // Cache for drafts
            let employees = []; // Cache for employees
            let currentPoId = null;
            let currentDraftId = null; // <-- To track the loaded draft
            let currentPoData = null;
            let itemToDelete = { id: null, type: null };
            let productCurrentPage = 1;
            let productItemsPerPage = 50;
            let currentUser = null;
            let currentUserProfile = null;
            let loginTimestamp = null;
            let employeeProfileListener = null;

            // --- DOM Elements ---
            // Login Page
            const loginContainer = document.getElementById('login-container');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email-address');
            const passwordInput = document.getElementById('password');
            const loginButton = document.getElementById('login-button');
            const loginErrorContainer = document.getElementById('login-error-container');
            const loginErrorMessageEl = document.getElementById('login-error-message');
            const rememberMeCheckbox = document.getElementById('remember-me');
            
            // Main App
            const appContainer = document.getElementById('app-container');
            const logoutButton = document.getElementById('logout-button');
            const productCodeInput = document.getElementById('product-code');
            const quantityInput = document.getElementById('quantity');
            const addToPoButton = document.getElementById('add-to-po');
            const cancelAddProductBtn = document.getElementById('cancel-add-product');
            const poTableBody = document.getElementById('po-table-body');
            const errorMessageEl = document.getElementById('error-message');
            const printTableBody = document.getElementById('print-table-body');
            const printDateEl = document.getElementById('print-date');
            const printVendorNameEl = document.getElementById('print-vendor-name');
            const printShopNameEl = document.getElementById('print-shop-name');
            const printPoNumberEl = document.getElementById('print-po-number');
            const lookupForm = document.getElementById('lookup-form');
            const shopNameInput = document.getElementById('shop-name');
            const shopAddressInput = document.getElementById('shop-address');
            const shopContactInput = document.getElementById('shop-contact');
            const addShopBtn = document.getElementById('add-shop-btn');
            const shopListBody = document.getElementById('shop-list-body');
            const submitPrBtn = document.getElementById('submit-pr-btn');
            const saveDraftBtn = document.getElementById('save-draft-btn');
            const cancelPoRequestBtn = document.getElementById('cancel-po-request-btn');
            const requestShopDropdown = document.getElementById('request-shop-dropdown');
            const requestVendorDropdown = document.getElementById('request-vendor-dropdown');
            const poNumberDisplay = document.getElementById('po-number-display');
            const updateGoodsBtn = document.getElementById('update-goods-btn');
            const saveUpdatesBtn = document.getElementById('save-updates-btn');
            const requestPoNoInput = document.getElementById('request-po-no');
            const requestPoDateInput = document.getElementById('request-po-date');
            const detailSavePdfBtn = document.getElementById('detail-save-pdf-btn');
            const deletePoDetailBtn = document.getElementById('delete-po-detail-btn');
            const productPreview = document.getElementById('product-preview');
            const detailExchangeRateInput = document.getElementById('detail-exchange-rate');
            const submissionStatusEl = document.getElementById('submission-status');
            const vendorNameInput = document.getElementById('vendor-name');
            const vendorContactInput = document.getElementById('vendor-contact');
            const vendorAddressInput = document.getElementById('vendor-address');
            const addVendorBtn = document.getElementById('add-vendor-btn');
            const vendorListBody = document.getElementById('vendor-list-body');
            const importVendorsBtn = document.getElementById('import-vendors-btn');
            const vendorFileInput = document.getElementById('vendor-file');
            const importStatusEl = document.getElementById('import-status');

            const poListView = document.getElementById('po-list-view');
            const poDetailView = document.getElementById('po-detail-view');
            const poListBody = document.getElementById('po-list-body');
            const backToListBtn = document.getElementById('back-to-list-btn');
            const draftsListBody = document.getElementById('drafts-list-body');

            const filterShop = document.getElementById('filter-shop');
            const filterDate = document.getElementById('filter-date');
            const filterVendor = document.getElementById('filter-vendor');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');

            const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            const productModal = document.getElementById('product-modal');
            const addProductBtn = document.getElementById('add-product-btn');
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            const saveProductBtn = document.getElementById('save-product-btn');
            const productListBody = document.getElementById('product-list-body');
            const productSearchInput = document.getElementById('product-search-input');
            const exportProductsBtn = document.getElementById('export-products-btn');
            const importProductsBtn = document.getElementById('import-products-btn');
            const productFileInput = document.getElementById('product-file-input');
            const productImportStatus = document.getElementById('product-import-status');
            const deleteAllProductsBtn = document.getElementById('delete-all-products-btn');
            const productTotalCountEl = document.getElementById('product-total-count');
            const itemsPerPageSelect = document.getElementById('items-per-page');
            const productListSummary = document.getElementById('product-list-summary');
            const pageInfo = document.getElementById('page-info');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');

            const editPoItemModal = document.getElementById('edit-po-item-modal');
            const cancelEditPoItemBtn = document.getElementById('cancel-edit-po-item-btn');
            const saveEditPoItemBtn = document.getElementById('save-edit-po-item-btn');
            
            const costHistoryModal = document.getElementById('cost-history-modal');
            const costHistoryModalTitle = document.getElementById('cost-history-modal-title');
            const costHistoryBody = document.getElementById('cost-history-body');
            const closeHistoryBtn = document.getElementById('close-history-btn');

            // Employee section DOM elements
            const employeeModal = document.getElementById('employee-modal');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            const cancelEmployeeBtn = document.getElementById('cancel-employee-btn');
            const saveEmployeeBtn = document.getElementById('save-employee-btn');
            const employeeListBody = document.getElementById('employee-list-body');
            const employeeModalTitle = document.getElementById('employee-modal-title');
            const employeeIdInput = document.getElementById('employee-id');
            const employeeUidInput = document.getElementById('employee-uid');
            const generateUidBtn = document.getElementById('generate-uid-btn');
            const employeeNameInput = document.getElementById('employee-name');
            const employeePositionInput = document.getElementById('employee-position');
            const employeeEmailInput = document.getElementById('employee-email');
            const employeeRoleSelect = document.getElementById('employee-role');
            const employeeShopsCheckboxesDiv = document.getElementById('employee-shops-checkboxes');
            const employeePermissionsDiv = document.getElementById('employee-permissions');


            // --- Helper Functions ---
            function findValue(obj, keys) {
                if (!obj || typeof obj !== 'object') return undefined;
                for (const key of keys) {
                    const lowerKey = key.toLowerCase();
                    const objKey = Object.keys(obj).find(k => k.toLowerCase() === lowerKey);
                    if (objKey && obj[objKey] !== undefined) {
                        return obj[objKey];
                    }
                }
                return undefined;
            }
            
            function clearStatus() {
                submissionStatusEl.innerHTML = '';
            }
            
            function displayLoginError(message) {
                loginErrorMessageEl.textContent = message;
                loginErrorContainer.classList.remove('hidden');
            }
            
            function hideLoginError() {
                loginErrorContainer.classList.add('hidden');
                loginErrorMessageEl.textContent = '';
            }

            // --- Main Application Logic ---
            function initializeMainApp() {
                document.body.classList.remove('bg-slate-900');
                document.body.classList.add('bg-slate-100');
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                applyUserPermissions();

                // Load all application data
                loadAndCacheProducts();
                listenForShops();
                listenForVendors();
                listenForEmployees();
                db.collection('purchaseOrders').orderBy("createdAt", "desc").onSnapshot((snapshot) => {
                    allPurchaseOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyAndRenderFilters();
                });
                db.collection('drafts').onSnapshot((snapshot) => {
                    drafts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDraftsList();
                });
            }

            function applyUserPermissions() {
                if (!currentUserProfile) return;

                const allowedPages = currentUserProfile.permissions || [];
                const allTabs = document.querySelectorAll('.tab');
                let firstVisibleTab = null;

                // Hide/show tabs based on permissions
                allTabs.forEach(tab => {
                    const tabId = tab.dataset.tab;
                    if (currentUserProfile.role === 'Admin' || allowedPages.includes(tabId)) {
                        tab.style.display = 'flex';
                        if (!firstVisibleTab) {
                            firstVisibleTab = tab;
                        }
                    } else {
                        tab.style.display = 'none';
                    }
                });

                // Deactivate all tabs first, then activate the first allowed one
                allTabs.forEach(t => {
                    Object.keys(tabColors).forEach(colorClass => t.classList.remove(colorClass));
                });
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                if (firstVisibleTab) {
                    const activeColorClass = tabColors[firstVisibleTab.dataset.tab];
                    firstVisibleTab.classList.add(activeColorClass);
                    const activeContent = document.getElementById(firstVisibleTab.dataset.tab);
                    if (activeContent) {
                        activeContent.classList.add('active');
                    }
                }
            }

            // --- Authentication Logic ---
            auth.onAuthStateChanged(async (user) => {
                if (employeeProfileListener) employeeProfileListener(); // Detach old listener

                if (user) {
                    const employeesRef = db.collection('employees');
                    const q = employeesRef.where('uid', '==', user.uid).limit(1);
                    const querySnapshot = await q.get();

                    if (querySnapshot.empty) {
                        console.log("User is authenticated but not authorized.");
                        auth.signOut(); // Force sign out
                    } else {
                        console.log("User is logged in and authorized.");
                        currentUser = user;
                        currentUserProfile = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                        loginTimestamp = new Date(); // Set login time
                        
                        // Listen for forced logout
                        employeeProfileListener = db.collection('employees').doc(currentUserProfile.id).onSnapshot(doc => {
                            const data = doc.data();
                            if (data && data.forceLogoutTimestamp && data.forceLogoutTimestamp.toDate() > loginTimestamp) {
                                if (employeeProfileListener) employeeProfileListener();
                                auth.signOut();
                            }
                        });

                        initializeMainApp();
                    }
                } else {
                    console.log("No user is logged in.");
                    currentUser = null;
                    currentUserProfile = null;
                    loginTimestamp = null;
                    document.body.classList.add('bg-slate-900');
                    document.body.classList.remove('bg-slate-100');
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideLoginError();

                const email = emailInput.value;
                const password = passwordInput.value;
                const rememberMe = rememberMeCheckbox.checked;
                
                if (!email || !password) {
                    displayLoginError("Please enter both email and password.");
                    return;
                }

                loginButton.disabled = true;
                loginButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Signing In...`;

                try {
                    // Set persistence based on "Remember me" checkbox
                    const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
                    await auth.setPersistence(persistence);
                    
                    // Now, sign in the user
                    await auth.signInWithEmailAndPassword(email, password);
                    // onAuthStateChanged will handle the UI switch
                } catch (error) {
                    console.error("Login failed:", error.code, error.message);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        displayLoginError("Invalid email or password. Please try again.");
                    } else {
                        displayLoginError("An error occurred during login. Please try again later.");
                    }
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = `<span class="absolute left-0 inset-y-0 flex items-center pl-3"><svg class="h-5 w-5 text-red-400 group-hover:text-red-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg></span>Sign in`;
                }
            });
            
            logoutButton.addEventListener('click', () => {
                if (employeeProfileListener) employeeProfileListener();
                auth.signOut();
            });
            
            function renderShopList() {
                shopListBody.innerHTML = '';
                shops.forEach((shop, index) => {
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'}" data-id="${shop.id}">
                            <td data-label="Shop Name" class="p-3">${shop.name || ''}</td>
                            <td data-label="Address" class="p-3">${shop.address || ''}</td>
                            <td data-label="Contact" class="p-3">${shop.contact || ''}</td>
                            <td data-label="Actions" class="p-3 text-center">
                                <button class="delete-shop-btn text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `;
                    shopListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function renderVendorList() {
                vendorListBody.innerHTML = '';
                vendors.forEach((vendor, index) => {
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'}" data-id="${vendor.id}">
                            <td data-label="Vendor Name" class="p-3">${vendor.name || ''}</td>
                            <td data-label="Contact" class="p-3">${vendor.contact || ''}</td>
                            <td data-label="Address" class="p-3">${vendor.address || ''}</td>
                            <td data-label="Actions" class="p-3 text-center">
                                <button class="delete-vendor-btn text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `;
                    vendorListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function populateAndFilterShopDropdowns() {
                if (!requestShopDropdown || !filterShop) return;
                
                let shopsToDisplay = [];
                if (currentUserProfile && currentUserProfile.role !== 'Admin' && currentUserProfile.assignedShops) {
                    const allowedShopNames = currentUserProfile.assignedShops;
                    shopsToDisplay = shops.filter(shop => allowedShopNames.includes(shop.name));
                } else {
                    shopsToDisplay = shops; // Admin or user with no specific shops assigned sees all shops
                }

                const selectedRequestValue = requestShopDropdown.value;
                const selectedFilterValue = filterShop.value;

                requestShopDropdown.innerHTML = '<option value="">Select a shop</option>';
                filterShop.innerHTML = '<option value="">All Shops</option>';

                shopsToDisplay.forEach(shop => {
                    const option1 = document.createElement('option');
                    option1.value = shop.name;
                    option1.textContent = shop.name;
                    requestShopDropdown.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = shop.name;
                    option2.textContent = shop.name;
                    filterShop.appendChild(option2);
                });

                if (Array.from(requestShopDropdown.options).some(opt => opt.value === selectedRequestValue)) {
                    requestShopDropdown.value = selectedRequestValue;
                }
                if (Array.from(filterShop.options).some(opt => opt.value === selectedFilterValue)) {
                    filterShop.value = selectedFilterValue;
                }
            }
            
            function populateVendorDropdowns() {
                if (!requestVendorDropdown) return;
                const selectedValue = requestVendorDropdown.value;

                requestVendorDropdown.innerHTML = '<option value="">Select a vendor</option>';

                vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.name;
                    option.textContent = vendor.name;
                    requestVendorDropdown.appendChild(option);
                });

                if (Array.from(requestVendorDropdown.options).some(opt => opt.value === selectedValue)) {
                    requestVendorDropdown.value = selectedValue;
                }
            }

            function listenForShops() {
                db.collection(`shops`).onSnapshot((snapshot) => {
                    shops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderShopList(); // For settings page
                    populateAndFilterShopDropdowns(); // Use the new filtered function
                });
            }

            function listenForVendors() {
                db.collection('vendors').onSnapshot((snapshot) => {
                    vendors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderVendorList();
                    populateVendorDropdowns();
                });
            }
            
            function renderEmployeeList() {
                if (!employeeListBody) return;
                employeeListBody.innerHTML = '';
                employees.forEach((emp, index) => {
                    const assignedShopsHtml = (emp.assignedShops && emp.assignedShops.length > 0) 
                        ? emp.assignedShops.map(s => `<span class="inline-block bg-slate-200 rounded-full px-2 py-1 text-xs font-semibold text-slate-700 mr-1 mb-1">${s}</span>`).join('')
                        : 'N/A';

                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100" data-id="${emp.id}">
                            <td data-label="UID" class="p-3 text-xs text-slate-500 truncate" style="max-width: 100px;">${emp.uid || 'N/A'}</td>
                            <td data-label="Name" class="p-3 font-medium">${emp.name || ''}</td>
                            <td data-label="Position" class="p-3">${emp.position || ''}</td>
                            <td data-label="Email" class="p-3">${emp.email || ''}</td>
                            <td data-label="Role" class="p-3">${emp.role || ''}</td>
                            <td data-label="Assigned Shops" class="p-3">${assignedShopsHtml}</td>
                            <td data-label="Actions" class="p-3 text-center space-x-2 whitespace-nowrap">
                                <button class="edit-employee-btn text-indigo-600 hover:text-indigo-900 font-medium" data-id="${emp.id}">Edit</button>
                                <button class="delete-employee-btn text-red-600 hover:text-red-900 font-medium" data-id="${emp.id}">Delete</button>
                                <button class="force-logout-btn text-yellow-600 hover:text-yellow-900 font-medium" data-id="${emp.id}">Force Logout</button>
                            </td>
                        </tr>
                    `;
                    employeeListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function listenForEmployees() {
                db.collection('employees').onSnapshot((snapshot) => {
                    employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEmployeeList();
                });
            }

            async function loadVendorSettings() {
                const settingsCollection = db.collection('vendorSettings');
                const snapshot = await settingsCollection.get();
                vendorSettings = {};
                snapshot.forEach(doc => {
                    vendorSettings[doc.id] = doc.data().currency;
                });
            }

            function renderProductList() {
                if (!productListBody) return;
                
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => 
                    (p.Name || '').toLowerCase().includes(searchTerm) || 
                    (p["Product Code"] || '').toLowerCase().includes(searchTerm)
                );

                productListBody.innerHTML = '';
                const startIndex = (productCurrentPage - 1) * productItemsPerPage;
                const endIndex = startIndex + productItemsPerPage;
                const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

                paginatedProducts.forEach((product, index) => {
                    const cost = parseFloat(findValue(product, ['Cost'])) || 0;
                    const price = parseFloat(findValue(product, ['Price', 'Sales Price'])) || 0;
                    const row = `
                        <tr data-id="${product.id}" class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100">
                            <td data-label="Product Code" class="p-3">${product["Product Code"]}</td>
                            <td data-label="Barcode" class="p-3">${product.Barcode || ''}</td>
                            <td data-label="Product Name" class="p-3">${product.Name}</td>
                            <td data-label="Category" class="p-3">${product["Product Category"] || ''}</td>
                            <td data-label="Cost" class="p-3 text-right">${cost.toFixed(2)}</td>
                            <td data-label="Price" class="p-3 text-right">${price.toFixed(2)}</td>
                            <td data-label="Actions" class="p-3 text-center space-x-2">
                                <button class="edit-product-btn text-indigo-600 hover:text-indigo-900 font-medium" data-id="${product.id}">Edit</button>
                                <button class="history-product-btn text-slate-500 hover:text-slate-800 font-medium" data-id="${product.id}" data-name="${product.Name}">History</button>
                                <button class="delete-product-btn text-red-600 hover:text-red-900 font-medium" data-id="${product.id}">Delete</button>
                            </td>
                        </tr>`;
                    productListBody.insertAdjacentHTML('beforeend', row);
                });

                renderProductPaginationControls(filteredProducts);
            }

            function renderProductPaginationControls(filteredProducts) {
                const totalItems = filteredProducts.length;
                const totalPages = Math.ceil(totalItems / productItemsPerPage);
                const startIndex = (productCurrentPage - 1) * productItemsPerPage + 1;
                const endIndex = Math.min(startIndex + productItemsPerPage - 1, totalItems);

                productListSummary.textContent = `Showing ${startIndex}-${endIndex} of ${totalItems} products`;
                pageInfo.textContent = `Page ${productCurrentPage} of ${totalPages}`;

                prevPageBtn.disabled = productCurrentPage === 1;
                nextPageBtn.disabled = productCurrentPage === totalPages || totalItems === 0;
            }

            async function loadAndCacheProducts() {
                if (!currentUser) return;
                
                // Try to load from cache first for a fast startup
                try {
                    const cachedProductsJSON = localStorage.getItem('cachedProducts');
                    if (cachedProductsJSON) {
                        allProducts = JSON.parse(cachedProductsJSON);
                        if (productTotalCountEl) {
                           productTotalCountEl.textContent = `(${allProducts.length} items)`;
                        }
                        renderProductList(); // Render immediately with cached data
                    }
                } catch(e) {
                    console.error("Could not parse cached products:", e);
                    allProducts = []; // Start fresh if cache is corrupt
                }


                try {
                    db.collection(`products`).onSnapshot((querySnapshot) => {
                        allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        if (productTotalCountEl) {
                            productTotalCountEl.textContent = `(${allProducts.length} items)`;
                        }

                        renderProductList(); // Update the Product Data tab
                        
                        // If the PO detail view is open, refresh its calculations now that we have product data
                        if (currentPoData && !poDetailView.classList.contains('hidden')) {
                           recalculateDetailView();
                        }
                        
                        // Update the local storage cache with the fresh data
                        try {
                            localStorage.setItem('cachedProducts', JSON.stringify(allProducts));
                        } catch (e) {
                            console.error("Could not cache products to local storage:", e);
                        }
                    });
                    await loadVendorSettings();
                } catch (error) {
                    console.error("Error fetching products:", error);
                }
            }

            function renderRequestPOTable() {
                poTableBody.innerHTML = '';
                let primaryVendor = "";
                if (poItems.length > 0) {
                    const vendorCounts = poItems.reduce((acc, item) => {
                        const vendor = item["Product Category"] || "Unknown";
                        acc[vendor] = (acc[vendor] || 0) + 1;
                        return acc;
                    }, {});
                    primaryVendor = Object.keys(vendorCounts).reduce((a, b) => vendorCounts[a] > vendorCounts[b] ? a : b);
                }
                
                if (Array.from(requestVendorDropdown.options).some(opt => opt.value === primaryVendor)) {
                    requestVendorDropdown.value = primaryVendor;
                } else if (poItems.length === 0) {
                    requestVendorDropdown.value = "";
                }

                updateRequestHeader();

                poItems.forEach((item, index) => {
                    const cost = parseFloat(item.Cost) || 0;
                    const qty = parseInt(item.quantity) || 0;
                    const subtotal = cost * qty;
                    const currencySymbol = item.currency === 'KHR' ? '' : '$';
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100" data-index="${index}">
                            <td data-label="No." class="p-3">${index + 1}</td>
                            <td data-label="Product Code" class="p-3">${item["Product Code"]}</td>
                            <td data-label="Barcode" class="p-3">${item.Barcode || ''}</td>
                            <td data-label="Product Name" class="p-3">${item.Name}</td>
                            <td data-label="Vendor" class="p-3">${item["Product Category"] || ''}</td>
                            <td data-label="Qty" class="p-3 text-right">${qty}</td>
                            <td data-label="Cost (KHR)" class="p-3 text-right">${item.currency === 'KHR' ? cost.toFixed(2) : '-'}</td>
                            <td data-label="Cost (USD)" class="p-3 text-right">${item.currency === 'USD' ? cost.toFixed(2) : '-'}</td>
                            <td data-label="Sub-Total" class="p-3 text-right">${subtotal.toFixed(2)} ${currencySymbol}</td>
                            <td data-label="CB4" class="p-3 text-right">${cost.toFixed(2)}</td>
                            <td data-label="Actions" class="p-3 no-print text-right">
                                <button class="edit-item text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                                <button class="delete-item text-red-600 hover:text-red-900">Del</button>
                            </td>
                        </tr>`;
                    poTableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            
            async function handleAddToPO() {
                clearStatus();
                const code = productCodeInput.value.trim();
                const quantity = parseInt(quantityInput.value);
                if (!code || isNaN(quantity) || quantity <= 0) {
                    errorMessageEl.textContent = "Please enter a valid product code and quantity.";
                    errorMessageEl.classList.remove('hidden');
                    return;
                }
                errorMessageEl.classList.add('hidden');
                
                let product = null;
                const lowerCaseCode = code.toLowerCase();

                // If cache is ready, use it for a fast lookup
                if (allProducts.length > 0) {
                    // Prioritize exact match
                    product = allProducts.find(p =>
                        (p["Product Code"] || "").toLowerCase() === lowerCaseCode ||
                        (p["Barcode"] || "").toLowerCase() === lowerCaseCode
                    );

                    // If no exact match, try endsWith match
                    if (!product) {
                        product = allProducts.find(p =>
                            (p["Product Code"] || "").toLowerCase().endsWith(lowerCaseCode) ||
                            (p["Barcode"] || "").toLowerCase().endsWith(lowerCaseCode)
                        );
                    }
                } else {
                    // If cache is not ready, query Firestore directly
                    addToPoButton.disabled = true;
                    addToPoButton.textContent = 'Searching...';
                    try {
                        // Firestore doesn't support case-insensitive or endsWith queries well,
                        // so this direct lookup is limited but better than nothing.
                        let querySnapshot = await db.collection('products').where('Product Code', '==', code).limit(1).get();
                        if (querySnapshot.empty) {
                            querySnapshot = await db.collection('products').where('Barcode', '==', code).limit(1).get();
                        }

                        if (!querySnapshot.empty) {
                            const doc = querySnapshot.docs[0];
                            product = { id: doc.id, ...doc.data() };
                        }
                    } catch (err) {
                        console.error("Error querying product:", err);
                        errorMessageEl.textContent = "An error occurred while searching for the product.";
                        errorMessageEl.classList.remove('hidden');
                    } finally {
                        addToPoButton.disabled = false;
                        addToPoButton.textContent = 'Add';
                    }
                }

                if (product) {
                    const vendor = product["Product Category"] || "Unknown";
                    const currency = vendorSettings[vendor] || 'KHR';
                    const existingItem = poItems.find(item => item["Product Code"] === product["Product Code"]);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        poItems.push({ ...product, quantity, currency });
                    }
                    renderRequestPOTable();
                    productCodeInput.value = '';
                    quantityInput.value = '1';
                    productPreview.classList.add('hidden'); // Hide preview after adding
                    productCodeInput.focus();
                } else {
                    errorMessageEl.textContent = `Product with code "${code}" not found.`;
                    errorMessageEl.classList.remove('hidden');
                }
            }

            function updateRequestHeader() {
                const shopName = requestShopDropdown.value || "N/A";
                const vendor = requestVendorDropdown.value || "N/A";
                const shopCode = shopName.substring(0, 3).toUpperCase().replace(/\s/g, '');
                const vendorCode = vendor.substring(0, 4).toUpperCase().replace(/\s/g, '');
                requestPoNoInput.value = `${shopCode}-${vendorCode}-PO-PENDING`;
                requestPoDateInput.value = new Date().toLocaleDateString();
            }

            function renderPoListView(pos) {
                poListBody.innerHTML = '';
                pos.forEach((po, index) => {
                    const requestDate = po.createdAt ? po.createdAt.toDate().toLocaleDateString() : 'Pending...';
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100" data-id="${po.id}">
                            <td data-label="No." class="p-3">${index + 1}</td>
                            <td data-label="PO Number" class="p-3 font-medium text-indigo-600">${po.poNumber}</td>
                            <td data-label="Date" class="p-3">${requestDate}</td>
                            <td data-label="Vendor" class="p-3">${po.vendorName}</td>
                            <td data-label="Shop" class="p-3">${po.shopName}</td>
                            <td data-label="Actions" class="p-3 text-right">
                                <button class="edit-po-btn text-indigo-600 hover:text-indigo-900 font-medium mr-4" data-id="${po.id}">Edit</button>
                                <button class="delete-po-btn text-red-600 hover:text-red-900 font-medium" data-id="${po.id}">Delete</button>
                            </td>
                        </tr>`;
                    poListBody.insertAdjacentHTML('beforeend', row);
                });
            }
            
            function renderDraftsList() {
                if (!draftsListBody) return;
                draftsListBody.innerHTML = '';
                // Sort drafts by saved date, newest first
                const sortedDrafts = drafts.sort((a, b) => (b.savedAt?.toDate() || 0) - (a.savedAt?.toDate() || 0));

                sortedDrafts.forEach((draft, index) => {
                    const savedDate = draft.savedAt ? draft.savedAt.toDate().toLocaleDateString() : 'N/A';
                    const shopName = draft.shopName || "N/A";
                    const vendorName = draft.vendorName || "N/A";
                    const shopCode = shopName.substring(0, 3).toUpperCase().replace(/\s/g, '');
                    const vendorCode = vendorName.substring(0, 4).toUpperCase().replace(/\s/g, '');
                    const draftPoNo = `${shopCode}-${vendorCode}-PO-DRAFT`;

                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100" data-id="${draft.id}">
                            <td data-label="No." class="p-3">${index + 1}</td>
                            <td data-label="Date" class="p-3">${savedDate}</td>
                            <td data-label="Shop" class="p-3">${shopName}</td>
                            <td data-label="PO No." class="p-3">${draftPoNo}</td>
                            <td data-label="Actions" class="p-3 text-center">
                                <button class="edit-draft-btn text-indigo-600 hover:text-indigo-900 font-medium mr-4" data-id="${draft.id}">Edit</button>
                                <button class="delete-draft-btn text-red-600 hover:text-red-900 font-medium" data-id="${draft.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    draftsListBody.insertAdjacentHTML('beforeend', row);
                });
            }

            function applyAndRenderFilters() {
                const shopValue = filterShop.value;
                const dateValue = filterDate.value;
                const vendorValue = filterVendor.value.toLowerCase();

                let filteredPOs = allPurchaseOrders;

                if (shopValue) {
                    filteredPOs = filteredPOs.filter(po => po.shopName === shopValue);
                }
                if (dateValue) {
                    // Normalize dates to compare them without time part
                    const filterDateObj = new Date(dateValue);
                    const filterDateString = new Date(filterDateObj.getTime() - filterDateObj.getTimezoneOffset() * -60000).toISOString().split('T')[0];
                    filteredPOs = filteredPOs.filter(po => {
                        if (!po.createdAt) return false;
                        const poDateObj = po.createdAt.toDate();
                        const poDateString = new Date(poDateObj.getTime() - poDateObj.getTimezoneOffset() * -60000).toISOString().split('T')[0];
                        return poDateString === filterDateString;
                    });
                }
                if (vendorValue) {
                    filteredPOs = filteredPOs.filter(po => po.vendorName.toLowerCase().includes(vendorValue));
                }

                renderPoListView(filteredPOs);
            }

            function showPoDetails(poId) {
                poListView.classList.add('hidden');
                poDetailView.classList.remove('hidden');
                loadPurchaseOrder(poId);
            }

            function showPoList() {
                poDetailView.classList.add('hidden');
                poListView.classList.remove('hidden');
                currentPoId = null;
                currentPoData = null;
            }

            function updatePrintView(poData) {
                printTableBody.innerHTML = '';
                poData.items.forEach((item, index) => {
                    const totalCostKhr = item.currency === 'KHR' ? (parseFloat(item.Cost) * parseInt(item.quantity)).toFixed(2) : '-';
                    const totalCostUsd = item.currency === 'USD' ? (parseFloat(item.Cost) * parseInt(item.quantity)).toFixed(2) : '-';

                    const rowHtml = `
                        <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'}" data-index="${index}" data-code="${item["Product Code"]}">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">${item.Name}</td>
                            <td class="p-3 text-center" data-field="quantity">${item.quantity}</td>
                            <td class="p-3 text-right" data-field="totalCostKhr">${totalCostKhr}</td>
                            <td class="p-3 text-right" data-field="totalCostUsd">${totalCostUsd}</td>
                            <td class="p-3 text-right" data-field="costPerUnit">0.00</td>
                            <td class="p-3 text-right" data-field="checkup">N/A</td>
                        </tr>`;
                    printTableBody.insertAdjacentHTML('beforeend', rowHtml);
                });
                
                recalculateDetailView();

                printDateEl.textContent = poData.createdAt ? poData.createdAt.toDate().toLocaleDateString() : 'N/A';
                printVendorNameEl.textContent = poData.vendorName;
                printShopNameEl.textContent = poData.shopName;
                printPoNumberEl.textContent = poData.poNumber;
                poNumberDisplay.textContent = `Viewing PO: ${poData.poNumber}`;
                detailExchangeRateInput.value = poData.exchangeRate || 4100;
            }

            function recalculateDetailView() {
                if (!currentPoData) return;
                
                const exchangeRate = parseFloat(detailExchangeRateInput.value) || 4100;

                printTableBody.querySelectorAll('tr').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    const item = currentPoData.items[index];

                    const qtyEl = row.querySelector('[data-field="quantity"]');
                    const totalCostKhrEl = row.querySelector('[data-field="totalCostKhr"]');
                    const totalCostUsdEl = row.querySelector('[data-field="totalCostUsd"]');

                    const qty = parseInt(qtyEl ? qtyEl.textContent : '0') || 0;
                    const totalCostKhr = parseFloat(totalCostKhrEl ? totalCostKhrEl.textContent.replace(/[^\d.-]/g, '') : '0') || 0;
                    const totalCostUsd = parseFloat(totalCostUsdEl ? totalCostUsdEl.textContent.replace(/[^\d.-]/g, '') : '0') || 0;
                    
                    let unitCostKhr = 0;

                    if (qty > 0) {
                        if (totalCostKhr > 0) {
                             unitCostKhr = totalCostKhr / qty;
                        } else if (totalCostUsd > 0) {
                            unitCostKhr = (totalCostUsd * exchangeRate) / qty;
                        }
                    }
                    
                    row.querySelector('[data-field="costPerUnit"]').textContent = unitCostKhr.toFixed(2);

                    const originalProduct = allProducts.find(p => p["Product Code"] === item["Product Code"]);
                    if (originalProduct) {
                        const masterCost = parseFloat(originalProduct.Cost) || 0;
                        const checkUpValue = masterCost - unitCostKhr;
                        const checkUpSign = checkUpValue >= 0 ? '+' : '';
                        const checkUpColor = Math.abs(checkUpValue) < 0.01 ? 'text-slate-500' : (checkUpValue > 0 ? 'text-green-600' : 'text-red-600');
                        row.querySelector('[data-field="checkup"]').innerHTML = `<span class="${checkUpColor} font-semibold">${checkUpSign}${checkUpValue.toFixed(2)}</span>`;
                    }
                });
            }

            async function loadPurchaseOrder(poId) {
                currentPoId = poId;
                if (!poId) {
                    document.getElementById('po-print-area').innerHTML = '<p class="text-center text-slate-500">Select a Purchase Order to view its details.</p>';
                    currentPoData = null;
                    return;
                }
                const poDoc = await db.collection('purchaseOrders').doc(poId).get();
                if (poDoc.exists) {
                    currentPoData = { id: poDoc.id, ...poDoc.data() };
                    updatePrintView(currentPoData);
                }
            }

            function showDeleteConfirmation(id, type) {
                itemToDelete = { id, type };
                const modalTitle = deleteConfirmationModal.querySelector('#delete-modal-title');
                const modalText = deleteConfirmationModal.querySelector('#delete-modal-text');
                const confirmBtn = deleteConfirmationModal.querySelector('#confirm-delete-btn');

                // Reset button style
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500';


                switch (type) {
                    case 'product':
                        modalTitle.textContent = 'Delete Product?';
                        modalText.textContent = 'Are you sure you want to delete this product? This action cannot be undone.';
                        break;
                    case 'po':
                        modalTitle.textContent = 'Delete Purchase Order?';
                        modalText.textContent = 'Are you sure you want to delete this PO? This action cannot be undone.';
                        break;
                    case 'draft':
                        modalTitle.textContent = 'Delete Draft?';
                        modalText.textContent = 'Are you sure you want to delete this draft? This action cannot be undone.';
                        break;
                    case 'all-products':
                         modalTitle.textContent = 'Delete ALL Products?';
                        modalText.textContent = 'Are you absolutely sure you want to delete ALL products? This action is permanent and cannot be undone.';
                        break;
                    case 'employee':
                        modalTitle.textContent = 'Delete Employee?';
                        modalText.textContent = 'Are you sure you want to delete this employee? This action cannot be undone.';
                        break;
                    case 'force-logout':
                        modalTitle.textContent = 'Force Logout User?';
                        modalText.textContent = 'Are you sure you want to force this user to log out from all active sessions?';
                        confirmBtn.textContent = 'Logout User';
                        confirmBtn.className = 'px-4 py-2 bg-yellow-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500';
                        break;
                }

                deleteConfirmationModal.classList.remove('hidden');
            }

            function hideDeleteConfirmation() {
                itemToDelete = { id: null, type: null };
                deleteConfirmationModal.classList.add('hidden');
            }

            async function deletePurchaseOrder() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('purchaseOrders').doc(itemToDelete.id).delete();
                    if (!poDetailView.classList.contains('hidden')) {
                        showPoList();
                    }
                } catch (error) {
                    console.error("Error deleting PO:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }

            async function deleteProduct() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('products').doc(itemToDelete.id).delete();
                } catch (error) {
                    console.error("Error deleting product:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function deleteDraft() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('drafts').doc(itemToDelete.id).delete();
                } catch (error) {
                    console.error("Error deleting draft:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function deleteEmployee() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('employees').doc(itemToDelete.id).delete();
                } catch (error) {
                    console.error("Error deleting employee:", error);
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function forceLogoutEmployee() {
                if (!itemToDelete.id) return;
                try {
                    await db.collection('employees').doc(itemToDelete.id).update({
                        forceLogoutTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    submissionStatusEl.innerHTML = `<p class="text-green-600 font-medium">Force logout signal sent successfully!</p>`;
                    setTimeout(() => submissionStatusEl.innerHTML = '', 3000);
                } catch (error) {
                    console.error("Error sending force logout signal:", error);
                    submissionStatusEl.innerHTML = `<p class="text-red-600 font-medium">Could not send force logout signal.</p>`;
                    setTimeout(() => submissionStatusEl.innerHTML = '', 3000);
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function deleteAllProducts() {
                productImportStatus.textContent = 'Deleting all products... This may take a moment.';
                productImportStatus.className = 'mt-4 text-sm text-yellow-600';
                try {
                    const productsRef = db.collection('products');
                    const snapshot = await productsRef.get();
                    if (snapshot.empty) {
                        productImportStatus.textContent = 'There are no products to delete.';
                        productImportStatus.className = 'mt-4 text-sm text-slate-600';
                        hideDeleteConfirmation();
                        return;
                    }

                    // Firestore batches are limited to 500 operations.
                    const batchSize = 500;
                    let batch = db.batch();
                    let count = 0;

                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count % batchSize === 0) {
                            await batch.commit();
                            batch = db.batch(); // Start a new batch
                        }
                    }

                    if (count % batchSize !== 0) {
                        await batch.commit(); // Commit the final batch
                    }
                    
                    productImportStatus.textContent = `Successfully deleted ${count} products.`;
                    productImportStatus.className = 'mt-4 text-sm text-green-600';

                } catch (error) {
                    console.error("Error deleting all products:", error);
                    productImportStatus.textContent = `Error: ${error.message}`;
                    productImportStatus.className = 'mt-4 text-sm text-red-600';
                } finally {
                    hideDeleteConfirmation();
                }
            }
            
            async function showCostHistory(productId, productName) {
                costHistoryModalTitle.textContent = `Cost History for: ${productName}`;
                costHistoryBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Loading history...</td></tr>';
                costHistoryModal.classList.remove('hidden');

                try {
                    const historyRef = db.collection('products').doc(productId).collection('costHistory');
                    const snapshot = await historyRef.orderBy('changeDate', 'desc').get();

                    if (snapshot.empty) {
                        costHistoryBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">No cost history found for this product.</td></tr>';
                        return;
                    }

                    let historyHtml = '';
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const changeDate = data.changeDate ? data.changeDate.toDate().toLocaleString() : 'N/A';
                        historyHtml += `
                            <tr class="${index % 2 === 0 ? 'bg-slate-50' : 'bg-white'}">
                                <td class="p-3">${changeDate}</td>
                                <td class="p-3 text-right">${(data.previousCost || 0).toFixed(2)}</td>
                                <td class="p-3 text-right font-semibold">${(data.newCost || 0).toFixed(2)}</td>
                                <td class="p-3">${data.poNumber || 'N/A'}</td>
                            </tr>
                        `;
                    });
                    costHistoryBody.innerHTML = historyHtml;

                } catch (error) {
                    console.error("Error fetching cost history:", error);
                    costHistoryBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Could not load history.</td></tr>';
                }
            }
            
            function populateEmployeeModal(employee = {}) {
                // Populate shops with checkboxes
                employeeShopsCheckboxesDiv.innerHTML = '';
                shops.forEach(shop => {
                    const isChecked = employee.assignedShops && employee.assignedShops.includes(shop.name);
                    const checkboxHtml = `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="${shop.name}" class="rounded border-slate-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" ${isChecked ? 'checked' : ''}>
                            <span class="text-sm text-slate-700">${shop.name}</span>
                        </label>
                    `;
                    employeeShopsCheckboxesDiv.insertAdjacentHTML('beforeend', checkboxHtml);
                });

                // Populate permissions
                employeePermissionsDiv.innerHTML = '';
                const pages = [
                    { id: 'po-request-form', name: 'PO Request' },
                    { id: 'drafts-page', name: 'Drafts' },
                    { id: 'purchase-order', name: 'POs Center' },
                    { id: 'product-data-page', name: 'Product Data' },
                    { id: 'setting-page', name: 'Settings' }
                ];
                pages.forEach(page => {
                    const isChecked = employee.permissions && employee.permissions.includes(page.id);
                    const checkboxHtml = `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="${page.id}" class="rounded border-slate-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" ${isChecked ? 'checked' : ''}>
                            <span class="text-sm text-slate-700">${page.name}</span>
                        </label>
                    `;
                    employeePermissionsDiv.insertAdjacentHTML('beforeend', checkboxHtml);
                });
            }

            // --- EVENT LISTENERS ---

            productCodeInput.addEventListener('input', () => {
                const code = productCodeInput.value.trim().toLowerCase();
                if (code.length < 2) {
                    productPreview.classList.add('hidden');
                    return;
                }

                // Prioritize exact match
                let product = allProducts.find(p =>
                    (p["Product Code"] || "").toLowerCase() === code ||
                    (p["Barcode"] || "").toLowerCase() === code
                );

                // If no exact match, try endsWith match
                if (!product) {
                    product = allProducts.find(p =>
                        (p["Product Code"] || "").toLowerCase().endsWith(code) ||
                        (p["Barcode"] || "").toLowerCase().endsWith(code)
                    );
                }
                
                if (product) {
                    const cost = parseFloat(product.Cost) || 0;
                    const vendor = product["Product Category"] || "Unknown";
                    const currency = vendorSettings[vendor] || 'KHR';
                    const currencySymbol = currency === 'KHR' ? '' : '$';
                    productPreview.innerHTML = `
                        <p class="font-semibold text-slate-800">${product.Name}</p>
                        <p class="text-sm text-slate-500">Vendor: <span class="font-medium text-slate-700">${vendor}</span></p>
                        <p class="text-sm text-slate-500">Cost: <span class="font-medium text-slate-700">${cost.toFixed(2)} ${currencySymbol}</span></p>
                    `;
                    productPreview.classList.remove('hidden');
                } else {
                    productPreview.classList.add('hidden');
                }
            });

            // Hide preview when clicking outside
            document.addEventListener('click', (e) => {
                if (!productCodeInput.contains(e.target) && !productPreview.contains(e.target)) {
                    productPreview.classList.add('hidden');
                }
            });

            addToPoButton.addEventListener('click', handleAddToPO);
            
            cancelAddProductBtn.addEventListener('click', () => {
                productCodeInput.value = '';
                quantityInput.value = '1';
                productPreview.classList.add('hidden');
                errorMessageEl.classList.add('hidden');
                productCodeInput.focus();
            });

            requestShopDropdown.addEventListener('change', updateRequestHeader);
            requestVendorDropdown.addEventListener('change', updateRequestHeader);
            
            poTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-item')) {
                    const index = parseInt(e.target.closest('tr').dataset.index);
                    poItems.splice(index, 1);
                    renderRequestPOTable();
                }
                if (e.target.classList.contains('edit-item')) {
                    const tr = e.target.closest('tr');
                    const index = parseInt(tr.dataset.index);
                    const item = poItems[index];

                    // Populate and show the modal
                    document.getElementById('edit-po-item-index').value = index;
                    document.getElementById('modal-edit-product-name').value = item.Name;
                    document.getElementById('modal-edit-quantity').value = item.quantity;
                    document.getElementById('modal-edit-cost').value = item.Cost;
                    
                    editPoItemModal.classList.remove('hidden');
                }
            });

            cancelEditPoItemBtn.addEventListener('click', () => {
                editPoItemModal.classList.add('hidden');
            });

            saveEditPoItemBtn.addEventListener('click', () => {
                const index = parseInt(document.getElementById('edit-po-item-index').value);
                const newQuantity = parseInt(document.getElementById('modal-edit-quantity').value);
                const newCost = parseFloat(document.getElementById('modal-edit-cost').value);

                if (isNaN(index) || isNaN(newQuantity) || isNaN(newCost) || newQuantity <= 0) {
                    alert("Please enter valid quantity and cost.");
                    return;
                }

                // Update the item in the poItems array
                poItems[index].quantity = newQuantity;
                poItems[index].Cost = newCost;

                // Re-render the table and hide the modal
                renderRequestPOTable();
                editPoItemModal.classList.add('hidden');
            });

            saveDraftBtn.addEventListener('click', async () => {
                clearStatus();
                if (poItems.length === 0) {
                    alert("Cannot save an empty PO as a draft.");
                    return;
                }
                updateRequestHeader();

                const draftData = {
                    vendorName: requestVendorDropdown.value,
                    shopName: requestShopDropdown.value,
                    items: poItems,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (currentDraftId) {
                        // Update existing draft
                        await db.collection('drafts').doc(currentDraftId).update(draftData);
                        submissionStatusEl.innerHTML = `<p class="text-green-600 font-medium">Draft updated successfully!</p>`;
                    } else {
                        // Add new draft
                        await db.collection('drafts').add(draftData);
                        submissionStatusEl.innerHTML = `<p class="text-green-600 font-medium">New draft saved successfully!</p>`;
                    }
                    // Clear the form and state after saving
                    poItems = [];
                    currentDraftId = null;
                    document.getElementById('draft-indicator')?.remove();
                    renderRequestPOTable();
                } catch (error) {
                    console.error("Error saving draft:", error);
                    submissionStatusEl.innerHTML = `<p class="text-red-600 font-medium">Could not save the draft.</p>`;
                }
            });

            submitPrBtn.addEventListener('click', async () => {
                clearStatus();
                // 1. Validate form
                if (poItems.length === 0) {
                    alert("Please add items to the request form first.");
                    return;
                }
                if (!requestShopDropdown.value) {
                    alert("Please select a shop.");
                    return;
                }
                if (!requestVendorDropdown.value) {
                    alert("Please select a vendor.");
                    return;
                }

                // Disable button to prevent double-clicks
                submitPrBtn.disabled = true;
                submitPrBtn.textContent = 'Submitting...';

                // 2. Generate PO Number using a transaction
                const shopName = requestShopDropdown.value;
                const vendorName = requestVendorDropdown.value;
                const shopCode = shopName.substring(0, 3).toUpperCase().replace(/\s/g, '');
                const vendorCode = vendorName.substring(0, 4).toUpperCase().replace(/\s/g, '');
                
                const counterRef = db.collection('counters').doc('purchaseOrder');
                let newPoNumber;
                try {
                    const newNumber = await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let newCount = 1;
                        if (counterDoc.exists) {
                            newCount = (counterDoc.data()?.lastPoNumber || 0) + 1;
                        }
                        transaction.set(counterRef, { lastPoNumber: newCount }, { merge: true });
                        return newCount;
                    });
                    const paddedNumber = String(newNumber).padStart(5, '0');
                    newPoNumber = `${shopCode}-${vendorCode}-PO-${paddedNumber}`;
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    let errorMessage = "Could not generate PO number. An unknown error occurred.";
                    if (error.message && error.message.toLowerCase().includes('quota exceeded')) {
                        errorMessage = "<strong>Submission Failed:</strong> The database's daily usage quota has been exceeded. Please try again tomorrow.";
                    }
                    submissionStatusEl.innerHTML = `<p class="text-red-600 font-medium">${errorMessage}</p>`;
                    
                    // Re-enable button on failure
                    submitPrBtn.disabled = false;
                    submitPrBtn.textContent = 'Submit PR';
                    return;
                }


                const newPO = {
                    poNumber: newPoNumber,
                    vendorName: vendorName,
                    shopName: shopName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    exchangeRate: 4100,
                    items: poItems,
                    status: 'Requested'
                };

                try {
                    await db.collection('purchaseOrders').add(newPO);
                } catch (error) {
                    console.error("Error saving PO:", error);
                    submissionStatusEl.innerHTML = `<p class="text-red-600 font-medium">Could not save the PO.</p>`;
                    // Re-enable button on failure
                    submitPrBtn.disabled = false;
                    submitPrBtn.textContent = 'Submit PR';
                    return;
                }

                // 3. Generate and Download PDF using the newPoNumber
                const element = document.getElementById('pdf-template-area');
                const selectedShop = shops.find(s => s.name === shopName) || {};

                document.getElementById('pdf-vendor').textContent = vendorName;
                document.getElementById('pdf-shop').textContent = shopName;
                document.getElementById('pdf-address').textContent = selectedShop.address || '';
                document.getElementById('pdf-po-no').textContent = newPoNumber; // Use the final PO number
                document.getElementById('pdf-po-date').textContent = new Date().toLocaleDateString();
                document.getElementById('pdf-contact').textContent = selectedShop.contact || '';

                const pdfTableBody = document.getElementById('pdf-table-body');
                const pdfTableFooter = document.getElementById('pdf-table-footer');
                pdfTableBody.innerHTML = '';
                pdfTableFooter.innerHTML = '';
                let totalRows = 15;

                poItems.forEach((item, index) => {
                    const cost = parseFloat(item.Cost) || 0;
                    const qty = parseInt(item.quantity) || 0;
                    
                    const costKhrDisplay = '&nbsp;';
                    const costUsdDisplay = item.currency === 'USD' ? cost.toFixed(2) : '&nbsp;';
                    const subTotalDisplay = '&nbsp;';
                    const cb4Value = cost.toFixed(2);
                    
                    const row = `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item["Product Code"]}</td>
                            <td>${item.Barcode || ''}</td>
                            <td>${item.Name}</td>
                            <td style="text-align: center;">${qty}</td>
                            <td style="text-align: right;">${costKhrDisplay}</td>
                            <td style="text-align: right;">${costUsdDisplay}</td>
                            <td style="text-align: right;">${subTotalDisplay}</td>
                            <td style="text-align: right;">${cb4Value}</td>
                        </tr>`;
                    pdfTableBody.insertAdjacentHTML('beforeend', row);
                });

                for(let i = poItems.length; i < totalRows; i++) {
                    const emptyRow = `<tr><td style="height: 2.2em;"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
                    pdfTableBody.insertAdjacentHTML('beforeend', emptyRow);
                }
                
                pdfTableFooter.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: right; font-weight: bold;">Total</td>
                        <td style="text-align: right; font-weight: bold;">&nbsp;</td>
                    </tr>
                `;

                element.style.position = 'absolute';
                element.style.left = '0px';
                element.style.top = '0px';
                element.style.opacity = '1';
                element.style.zIndex = '1000';

                const { jsPDF } = window.jspdf;
                html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                    element.style.position = 'fixed';
                    element.style.left = '-9999px';
                    element.style.opacity = '0';
                    element.style.zIndex = '-10';

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'a4' });
                    pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                    pdf.save(`${newPoNumber}.pdf`);

                    submissionStatusEl.innerHTML = `<p class="text-green-600 font-medium">PO ${newPoNumber} submitted and downloaded!</p>`;
                     // If the submitted PO came from a draft, delete that draft
                    if (currentDraftId) {
                        db.collection('drafts').doc(currentDraftId).delete();
                    }
                    
                    poItems = [];
                    currentDraftId = null; 
                    document.getElementById('draft-indicator')?.remove();
                    renderRequestPOTable();
                    
                    submitPrBtn.disabled = false;
                    submitPrBtn.textContent = 'Submit PR';
                }).catch(err => {
                    console.error("PDF generation failed:", err);
                    submissionStatusEl.innerHTML = `<p class="text-yellow-600 font-medium">PO was saved, but PDF download failed.</p>`;
                    poItems = [];
                    currentDraftId = null;
                    document.getElementById('draft-indicator')?.remove();
                    renderRequestPOTable();
                    submitPrBtn.disabled = false;
                    submitPrBtn.textContent = 'Submit PR';
                });
            });


            poListBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-po-btn');
                const deleteBtn = e.target.closest('.delete-po-btn');

                if (editBtn) {
                    showPoDetails(editBtn.dataset.id);
                } else if (deleteBtn) {
                    showDeleteConfirmation(deleteBtn.dataset.id, 'po');
                }
            });
            
            draftsListBody.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-draft-btn');
                const deleteBtn = e.target.closest('.delete-draft-btn');

                if (editBtn) {
                    clearStatus();
                    const draftId = editBtn.dataset.id;
                    const draft = drafts.find(d => d.id === draftId);
                    if (draft) {
                        poItems = draft.items || [];
                        requestShopDropdown.value = draft.shopName || '';
                        requestVendorDropdown.value = draft.vendorName || '';
                        currentDraftId = draftId; // Set the current draft ID
                        renderRequestPOTable(); // This will also update the vendor input

                        // Add a visual indicator that a draft is being edited
                        const indicator = document.createElement('p');
                        indicator.id = 'draft-indicator';
                        indicator.className = 'text-sm text-blue-600 font-semibold mb-4';
                        indicator.textContent = `Editing draft for "${draft.vendorName}". Saving will update this draft.`;
                        
                        // Remove any existing indicator first
                        document.getElementById('draft-indicator')?.remove();
                        // Add it after the main H1 title
                        document.querySelector('#po-request-form > div > h1').insertAdjacentElement('afterend', indicator);

                        // Switch to the PO request form tab
                        document.querySelector('.tab[data-tab="po-request-form"]').click();
                    }
                }

                if (deleteBtn) {
                    const draftId = deleteBtn.dataset.id;
                    showDeleteConfirmation(draftId, 'draft');
                }
            });

            backToListBtn.addEventListener('click', showPoList);

            updateGoodsBtn.addEventListener('click', () => {
                if (!currentPoData) return;
                detailExchangeRateInput.readOnly = false;
                detailExchangeRateInput.classList.remove('bg-slate-200', 'cursor-not-allowed');

                printTableBody.querySelectorAll('tr').forEach(row => {
                    const qtyEl = row.querySelector('[data-field="quantity"]');
                    const totalCostKhrEl = row.querySelector('[data-field="totalCostKhr"]');
                    const totalCostUsdEl = row.querySelector('[data-field="totalCostUsd"]');

                    // Make all three fields editable
                    if (qtyEl) qtyEl.contentEditable = true;
                    if (totalCostKhrEl) totalCostKhrEl.contentEditable = true;
                    if (totalCostUsdEl) totalCostUsdEl.contentEditable = true;
                    
                    row.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                        cell.classList.add('bg-yellow-100', 'focus:outline-blue-400');
                        cell.addEventListener('input', () => recalculateDetailView());
                    });
                });
                updateGoodsBtn.classList.add('hidden');
                saveUpdatesBtn.classList.remove('hidden');
            });

            saveUpdatesBtn.addEventListener('click', async () => {
                if (!currentPoId || !currentPoData) return;
                const poDocRef = db.collection('purchaseOrders').doc(currentPoId);
                const updatedItems = JSON.parse(JSON.stringify(currentPoData.items));
                let hasChanges = false;
                
                const newExchangeRate = parseFloat(detailExchangeRateInput.value) || 4100;
                if (currentPoData.exchangeRate !== newExchangeRate) {
                    hasChanges = true;
                }

                const costUpdateBatch = db.batch();
                let costUpdatesCount = 0;

                printTableBody.querySelectorAll('tr').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    const item = updatedItems[index];
                    const qty = parseInt(row.querySelector('[data-field="quantity"]').textContent);
                    const newUnitCostKhr = parseFloat(row.querySelector('[data-field="costPerUnit"]').textContent);

                    if (item.quantity !== qty) {
                        item.quantity = qty;
                        hasChanges = true;
                    }

                    const originalProduct = allProducts.find(p => p["Product Code"] === item["Product Code"]);
                    if (originalProduct) {
                        const masterCost = parseFloat(originalProduct.Cost) || 0;
                        // Check if newUnitCost is a valid number and has changed significantly
                        if (!isNaN(newUnitCostKhr) && Math.abs(masterCost - newUnitCostKhr) > 0.01) {
                            const productRef = db.collection('products').doc(originalProduct.id);
                            const historyRef = productRef.collection('costHistory').doc();
                            
                            costUpdateBatch.set(historyRef, {
                                previousCost: masterCost,
                                newCost: newUnitCostKhr,
                                changeDate: firebase.firestore.FieldValue.serverTimestamp(),
                                poNumber: currentPoData.poNumber,
                                shopName: currentPoData.shopName
                            });
                            costUpdateBatch.update(productRef, { "Cost": newUnitCostKhr });
                            costUpdatesCount++;
                        }
                    }
                });

                try {
                    if (hasChanges) {
                        await poDocRef.update({ items: updatedItems, exchangeRate: newExchangeRate });
                    }
                    if (costUpdatesCount > 0) {
                        await costUpdateBatch.commit();
                    }
                    alert(`PO updated successfully! ${costUpdatesCount} product cost(s) were updated.`);
                    await loadPurchaseOrder(currentPoId); // Reload
                } catch (error) {
                    console.error("Error updating PO and product costs:", error);
                    alert("Failed to save updates.");
                }
                
                detailExchangeRateInput.readOnly = true;
                detailExchangeRateInput.classList.add('bg-slate-200', 'cursor-not-allowed');
                printTableBody.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                    cell.contentEditable = false;
                    cell.classList.remove('bg-yellow-100', 'focus:outline-blue-400');
                });
                updateGoodsBtn.classList.remove('hidden');
                saveUpdatesBtn.classList.add('hidden');
            });

            confirmDeleteBtn.addEventListener('click', () => {
                switch (itemToDelete.type) {
                    case 'po': deletePurchaseOrder(); break;
                    case 'product': deleteProduct(); break;
                    case 'draft': deleteDraft(); break;
                    case 'all-products': deleteAllProducts(); break;
                    case 'employee': deleteEmployee(); break;
                    case 'force-logout': forceLogoutEmployee(); break;
                }
            });
            cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
            deletePoDetailBtn.addEventListener('click', () => {
                if (currentPoId) {
                    showDeleteConfirmation(currentPoId, 'po');
                }
            });

            // Filter listeners
            filterShop.addEventListener('input', applyAndRenderFilters);
            filterDate.addEventListener('input', applyAndRenderFilters);
            filterVendor.addEventListener('input', applyAndRenderFilters);
            clearFiltersBtn.addEventListener('click', () => {
                filterShop.value = '';
                filterDate.value = '';
                filterVendor.value = '';
                applyAndRenderFilters();
            });
            
            // Tab switching logic
            const mainTabs = document.getElementById('main-tabs');
            const tabContents = document.querySelectorAll('.tab-content');
            const tabColors = {
                'po-request-form': 'active-indigo',
                'drafts-page': 'active-amber',
                'purchase-order': 'active-blue',
                'product-data-page': 'active-emerald',
                'setting-page': 'active-slate'
            };

            mainTabs.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.tab');
                if (!clickedTab) return;

                // When switching main tabs, always hide the detail view and show the list view within the POs Center
                poDetailView.classList.add('hidden');
                if (poListView) poListView.classList.remove('hidden');
                
                const allTabs = mainTabs.querySelectorAll('.tab');
                allTabs.forEach(t => {
                    Object.values(tabColors).forEach(colorClass => t.classList.remove(colorClass));
                });
                
                const tabId = clickedTab.dataset.tab;
                clickedTab.classList.add(tabColors[tabId]);
                
                tabContents.forEach(content => content.classList.remove('active'));
                const activeTabContent = document.getElementById(tabId);
                if(activeTabContent) activeTabContent.classList.add('active');
            });

            const settingTabs = document.querySelectorAll('.setting-tab');
            const settingTabContents = document.querySelectorAll('.setting-tab-content');
            settingTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    settingTabs.forEach(t => t.classList.remove('active-slate'));
                    tab.classList.add('active-slate');
                    settingTabContents.forEach(content => content.style.display = 'none');
                    document.getElementById(tab.dataset.tab).style.display = 'block';
                });
            });
            
            // Settings Page Listeners
            addShopBtn.addEventListener('click', async () => {
                const name = shopNameInput.value.trim();
                const address = shopAddressInput.value.trim();
                const contact = shopContactInput.value.trim();
                if (!name) return;
                try {
                    await db.collection(`shops`).add({ name, address, contact });
                    shopNameInput.value = '';
                    shopAddressInput.value = '';
                    shopContactInput.value = '';
                } catch (error) {
                    console.error("Error adding shop:", error);
                }
            });

            shopListBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-shop-btn')) {
                    const id = e.target.closest('tr').dataset.id;
                    try {
                        await db.collection(`shops`).doc(id).delete();
                    } catch (error) {
                        console.error("Error deleting shop:", error);
                    }
                }
            });

            addVendorBtn.addEventListener('click', async () => {
                const name = vendorNameInput.value.trim();
                const contact = vendorContactInput.value.trim();
                const address = vendorAddressInput.value.trim();
                if (!name) return;
                try {
                    await db.collection('vendors').add({ name, contact, address });
                    vendorNameInput.value = '';
                    vendorContactInput.value = '';
                    vendorAddressInput.value = '';
                } catch (error) {
                    console.error("Error adding vendor:", error);
                }
            });

            vendorListBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-vendor-btn')) {
                    const id = e.target.closest('tr').dataset.id;
                    try {
                        await db.collection('vendors').doc(id).delete();
                    } catch (error) {
                        console.error("Error deleting vendor:", error);
                    }
                }
            });
            
            importVendorsBtn.addEventListener('click', () => {
                const file = vendorFileInput.files[0];
                if (!file) {
                    importStatusEl.textContent = 'Please select a file to import.';
                    importStatusEl.className = 'mt-4 text-sm text-red-600';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        importStatusEl.textContent = 'Reading file...';
                        importStatusEl.className = 'mt-4 text-sm text-slate-600';
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const vendorsFromFile = XLSX.utils.sheet_to_json(worksheet);

                        if (vendorsFromFile.length === 0) {
                            importStatusEl.textContent = 'No vendors found in the file.';
                            importStatusEl.className = 'mt-4 text-sm text-yellow-600';
                            return;
                        }

                        importStatusEl.textContent = `Found ${vendorsFromFile.length} vendors. Preparing to import...`;

                        const batch = db.batch();
                        let newCount = 0;

                        vendorsFromFile.forEach(vendor => {
                            const name = findValue(vendor, ['Vendor Name', 'Name']);
                            if (name) { // Only import if a name is present
                                const vendorData = {
                                    name: name,
                                    contact: findValue(vendor, ['Contact', 'Phone', 'Tel']) || '',
                                    address: findValue(vendor, ['Address']) || ''
                                };
                                const newDocRef = db.collection('vendors').doc(); // Auto-generate ID
                                batch.set(newDocRef, vendorData);
                                newCount++;
                            }
                        });

                        await batch.commit();
                        importStatusEl.textContent = `Import complete! ${newCount} vendors added.`;
                        importStatusEl.className = 'mt-4 text-sm text-green-600';
                        vendorFileInput.value = ''; // Clear the file input

                    } catch (error) {
                        console.error("Error importing vendors:", error);
                        importStatusEl.textContent = `Error during import: ${error.message}`;
                        importStatusEl.className = 'mt-4 text-sm text-red-600';
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            // Product Data Page Listeners
            addProductBtn.addEventListener('click', () => {
                document.getElementById('product-modal-title').textContent = 'Add New Product';
                document.getElementById('product-id').value = '';
                document.getElementById('modal-product-code').value = '';
                document.getElementById('modal-barcode').value = '';
                document.getElementById('modal-product-name').value = '';
                document.getElementById('modal-product-category').value = '';
                document.getElementById('modal-product-cost').value = '';
                document.getElementById('modal-product-price').value = '';
                productModal.classList.remove('hidden');
            });

            cancelProductBtn.addEventListener('click', () => {
                productModal.classList.add('hidden');
            });

            saveProductBtn.addEventListener('click', async () => {
                const id = document.getElementById('product-id').value;
                const productCode = document.getElementById('modal-product-code').value.trim().toUpperCase();

                if (!productCode) {
                    alert("Product Code cannot be empty.");
                    return;
                }

                // Check for duplicates only when adding a NEW product
                if (!id) {
                    const productsRef = db.collection('products');
                    const q = productsRef.where('Product Code', '==', productCode).limit(1);
                    const snapshot = await q.get();
                    if (!snapshot.empty) {
                        alert(`A product with code "${productCode}" already exists.`);
                        return;
                    }
                }

                const productData = {
                    "Product Code": productCode,
                    "Barcode": document.getElementById('modal-barcode').value,
                    "Name": document.getElementById('modal-product-name').value,
                    "Product Category": document.getElementById('modal-product-category').value,
                    "Cost": parseFloat(document.getElementById('modal-product-cost').value) || 0,
                    "Price": parseFloat(document.getElementById('modal-product-price').value) || 0
                };

                try {
                    if (id) {
                        // Update existing product
                        await db.collection('products').doc(id).update(productData);
                    } else {
                        // Add new product
                        await db.collection('products').add(productData);
                    }
                    productModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving product:", error);
                    alert("Could not save product.");
                }
            });

            productListBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-product-btn');
                const deleteBtn = e.target.closest('.delete-product-btn');
                const historyBtn = e.target.closest('.history-product-btn');

                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const product = allProducts.find(p => p.id === id);
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'Edit Product';
                        document.getElementById('product-id').value = product.id;
                        document.getElementById('modal-product-code').value = product["Product Code"] || '';
                        document.getElementById('modal-barcode').value = product.Barcode || '';
                        document.getElementById('modal-product-name').value = product.Name || '';
                        document.getElementById('modal-product-category').value = product["Product Category"] || '';
                        document.getElementById('modal-product-cost').value = findValue(product, ['Cost']) || 0;
                        document.getElementById('modal-product-price').value = findValue(product, ['Price', 'Sales Price']) || 0;
                        productModal.classList.remove('hidden');
                    }
                } else if (deleteBtn) {
                    showDeleteConfirmation(deleteBtn.dataset.id, 'product');
                } else if (historyBtn) {
                    showCostHistory(historyBtn.dataset.id, historyBtn.dataset.name);
                }
            });
            
            closeHistoryBtn.addEventListener('click', () => {
                costHistoryModal.classList.add('hidden');
            });
            
            productSearchInput.addEventListener('input', () => {
                productCurrentPage = 1;
                renderProductList();
            });

            itemsPerPageSelect.addEventListener('change', () => {
                productItemsPerPage = parseInt(itemsPerPageSelect.value);
                productCurrentPage = 1;
                renderProductList();
            });

            prevPageBtn.addEventListener('click', () => {
                if (productCurrentPage > 1) {
                    productCurrentPage--;
                    renderProductList();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => 
                    (p.Name || '').toLowerCase().includes(searchTerm) || 
                    (p["Product Code"] || '').toLowerCase().includes(searchTerm)
                );
                const totalPages = Math.ceil(filteredProducts.length / productItemsPerPage);
                if (productCurrentPage < totalPages) {
                    productCurrentPage++;
                    renderProductList();
                }
            });

            exportProductsBtn.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => 
                    (p.Name || '').toLowerCase().includes(searchTerm) || 
                    (p["Product Code"] || '').toLowerCase().includes(searchTerm)
                );

                // Remove the 'id' field for a cleaner export
                const productsToExport = filteredProducts.map(({ id, ...rest }) => rest);

                const worksheet = XLSX.utils.json_to_sheet(productsToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
                XLSX.writeFile(workbook, "ProductData.xlsx");
            });

            importProductsBtn.addEventListener('click', () => {
                const file = productFileInput.files[0];
                if (!file) {
                    productImportStatus.textContent = 'Please select a file to import.';
                    productImportStatus.className = 'mt-4 text-sm text-red-600';
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        productImportStatus.textContent = 'Reading file...';
                        productImportStatus.className = 'mt-4 text-sm text-slate-600';
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const productsFromFile = XLSX.utils.sheet_to_json(worksheet);

                        if (productsFromFile.length === 0) {
                            productImportStatus.textContent = 'No products found in the file.';
                            productImportStatus.className = 'mt-4 text-sm text-yellow-600';
                            return;
                        }

                        productImportStatus.textContent = `Found ${productsFromFile.length} products. Checking against database...`;
                        
                        // Fetch all existing product codes once for efficient lookup
                        const existingProductsSnapshot = await db.collection('products').get();
                        const existingProductsMap = new Map();
                        existingProductsSnapshot.forEach(doc => {
                            existingProductsMap.set(doc.data()['Product Code'], doc.id);
                        });

                        productImportStatus.textContent = `Preparing updates...`;

                        const batch = db.batch();
                        let updatedCount = 0;
                        let newCount = 0;

                        for (const product of productsFromFile) {
                            const rawProductCode = findValue(product, ['Product Code']);
                            if (!rawProductCode) continue; // Skip rows without a product code
                            
                            const productCode = rawProductCode.toString().trim().toUpperCase();
                            if (!productCode) continue;

                            const productData = {
                                "Product Code": productCode,
                                "Barcode": findValue(product, ['Barcode']) || '',
                                "Name": findValue(product, ['Name']) || '',
                                "Product Category": findValue(product, ['Product Category']) || '',
                                "Cost": parseFloat(findValue(product, ['Cost'])) || 0,
                                "Price": parseFloat(findValue(product, ['Price', 'Sales Price'])) || 0,
                            };
                            
                            const existingDocId = existingProductsMap.get(productCode);
                            
                            if (existingDocId) {
                                // Product exists, update it
                                const docRef = db.collection('products').doc(existingDocId);
                                batch.update(docRef, productData);
                                updatedCount++;
                            } else {
                                // Product doesn't exist, add new
                                const newDocRef = db.collection('products').doc();
                                batch.set(newDocRef, productData);
                                newCount++;
                            }
                        }

                        await batch.commit();
                        productImportStatus.textContent = `Import complete! ${newCount} products added, ${updatedCount} products updated.`;
                        productImportStatus.className = 'mt-4 text-sm text-green-600';
                        productFileInput.value = ''; // Clear the file input

                    } catch (error) {
                        console.error("Error importing products:", error);
                        productImportStatus.textContent = `Error during import: ${error.message}`;
                        productImportStatus.className = 'mt-4 text-sm text-red-600';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            deleteAllProductsBtn.addEventListener('click', () => {
                showDeleteConfirmation(null, 'all-products');
            });
            
            // Employee Section Listeners
            addEmployeeBtn.addEventListener('click', () => {
                employeeModalTitle.textContent = 'Add New Employee';
                employeeIdInput.value = '';
                employeeUidInput.value = '';
                employeeNameInput.value = '';
                employeePositionInput.value = '';
                employeeEmailInput.value = '';
                employeeRoleSelect.value = 'Staff';
                populateEmployeeModal();
                employeeModal.classList.remove('hidden');
            });
            
            generateUidBtn.addEventListener('click', () => {
                // This is a placeholder for a real Firebase Auth UID.
                // In a real app, you'd get this after a user signs up.
                employeeUidInput.value = `temp_${new Date().getTime()}_${Math.random().toString(36).substr(2, 9)}`;
            });

            cancelEmployeeBtn.addEventListener('click', () => {
                employeeModal.classList.add('hidden');
            });

            saveEmployeeBtn.addEventListener('click', async () => {
                const id = employeeIdInput.value;
                const uid = employeeUidInput.value.trim();
                const name = employeeNameInput.value.trim();
                const email = employeeEmailInput.value.trim();

                if (!name || !email || !uid) {
                    alert("Employee UID, Name, and Email are required.");
                    return;
                }

                const selectedShops = Array.from(employeeShopsCheckboxesDiv.querySelectorAll('input:checked')).map(input => input.value);
                const selectedPermissions = Array.from(employeePermissionsDiv.querySelectorAll('input:checked')).map(input => input.value);

                const employeeData = {
                    uid,
                    name,
                    email,
                    position: employeePositionInput.value.trim(),
                    role: employeeRoleSelect.value,
                    assignedShops: selectedShops,
                    permissions: selectedPermissions
                };

                try {
                    if (id) {
                        await db.collection('employees').doc(id).update(employeeData);
                    } else {
                        await db.collection('employees').add(employeeData);
                    }
                    employeeModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving employee:", error);
                    alert("Could not save employee data.");
                }
            });

            employeeListBody.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-employee-btn');
                const deleteBtn = e.target.closest('.delete-employee-btn');
                const forceLogoutBtn = e.target.closest('.force-logout-btn');

                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const employee = employees.find(emp => emp.id === id);
                    if (employee) {
                        employeeModalTitle.textContent = 'Edit Employee';
                        employeeIdInput.value = employee.id;
                        employeeUidInput.value = employee.uid || '';
                        employeeNameInput.value = employee.name || '';
                        employeePositionInput.value = employee.position || '';
                        employeeEmailInput.value = employee.email || '';
                        employeeRoleSelect.value = employee.role || 'Staff';
                        populateEmployeeModal(employee);
                        employeeModal.classList.remove('hidden');
                    }
                } else if (deleteBtn) {
                    showDeleteConfirmation(deleteBtn.dataset.id, 'employee');
                } else if (forceLogoutBtn) {
                    const id = forceLogoutBtn.dataset.id;
                    showDeleteConfirmation(id, 'force-logout');
                }
            });


            // PDF Buttons
            detailSavePdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('po-print-area');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / pdfWidth;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight / ratio);
                    pdf.save(`${printPoNumberEl.textContent || 'details'}.pdf`);
                });
            });

            cancelPoRequestBtn.addEventListener('click', () => {
                poItems = [];
                currentDraftId = null;
                document.getElementById('draft-indicator')?.remove();
                renderRequestPOTable();
                clearStatus();
            });

        });
    </script>
</body>
</html>
