<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLW Management System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" id="manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashFlow App">
    <link rel="apple-touch-icon" href="https://i.imgur.com/Ahdcb2w.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }

        /* Custom modal animations */
        .modal-enter { animation: modal-enter 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        .modal-leave { animation: modal-leave 0.2s ease-in forwards; }
        @keyframes modal-enter {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes modal-leave {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(20px) scale(0.95); }
        }

        /* Custom notification animations */
        .notification-enter { animation: notification-enter 0.4s ease-out; }
        .notification-leave { animation: notification-leave 0.3s ease-in forwards; }
        @keyframes notification-enter {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes notification-leave {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-full">
    <div id="root" class="h-full"></div>

    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, Timestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase services globally available for Babel
        window.db = db;
        window.auth = auth;
        window.Firebase = {
            Timestamp,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            getDoc
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;
        
        // =================================================================================
        // #region 1. CONTEXT & PROVIDERS (DATA & NOTIFICATION)
        // =================================================================================
        const DataContext = createContext();
        const useData = () => useContext(DataContext);
        const NotificationContext = createContext();

        const NotificationProvider = ({ children }) => {
            const [notification, setNotification] = useState(null);
            const timeoutRef = useRef(null);

            const showNotification = useCallback((message, type = 'success', duration = 3000) => {
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                setNotification({ message, type, id: Date.now() });
                timeoutRef.current = setTimeout(() => {
                    setNotification(null);
                }, duration);
            }, []);

            return (
                <NotificationContext.Provider value={{ showNotification }}>
                    {children}
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                </NotificationContext.Provider>
            );
        };
        const useNotification = () => useContext(NotificationContext);

        const DataProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [dbData, setDbData] = useState({
                shops: [], employees: [], vendors: [],
                businessExpenseCategories: [], familyExpenseCategories: [],
                cashDrops: [], purchaseOrders: [], internalTransfers: [],
                businessExpenses: [], familyExpenses: [], bankStatements: [],
                personalCashflowStatements: [],
                appSettings: { exchangeRate: 4000 }
            });
            const [isLoading, setIsLoading] = useState(true);
            const { showNotification } = useNotification();
            
            useEffect(() => {
                const { onAuthStateChanged, signOut, doc, getDoc } = window.Firebase;
                const unsubscribeAuth = onAuthStateChanged(window.auth, async (firebaseUser) => {
                    setIsLoading(true);
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        const userDocRef = doc(window.db, "employees", firebaseUser.uid);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists()) {
                                setUserData({ uid: firebaseUser.uid, ...userDocSnap.data() });
                            } else {
                                setUserData(null);
                                signOut(window.auth);
                                showNotification("Access denied. User profile not found.", "error");
                            }
                        } catch (error) {
                            setUserData(null);
                            signOut(window.auth);
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setIsLoading(false);
                });
                return () => unsubscribeAuth();
            }, [showNotification]);

            useEffect(() => {
                if (!user || !userData) {
                    setDbData({
                        shops: [], employees: [], vendors: [],
                        businessExpenseCategories: [], familyExpenseCategories: [],
                        cashDrops: [], purchaseOrders: [], internalTransfers: [],
                        businessExpenses: [], familyExpenses: [], bankStatements: [],
                        personalCashflowStatements: [],
                        appSettings: { exchangeRate: 4000 }
                    });
                    return;
                };

                const { collection, onSnapshot, doc } = window.Firebase;
                const collectionsToSubscribe = [
                    'shops', 'employees', 'vendors', 'businessExpenseCategories', 
                    'familyExpenseCategories', 'cashDrops', 'purchaseOrders', 
                    'internalTransfers', 'businessExpenses', 'familyExpenses', 'bankStatements',
                    'personalCashflowStatements'
                ];

                const unsubscribes = collectionsToSubscribe.map(colName => 
                    onSnapshot(collection(window.db, colName), (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDbData(prev => ({ ...prev, [colName]: data }));
                    }, (error) => console.error(`Error fetching ${colName}:`, error))
                );

                const unsubSettings = onSnapshot(doc(window.db, "settings", "app"), (docSnap) => {
                    if (docSnap.exists()) setDbData(prev => ({ ...prev, appSettings: docSnap.data() }));
                });

                return () => {
                    unsubscribes.forEach(unsub => unsub());
                    unsubSettings();
                };
            }, [user, userData]);

            const value = { 
                ...dbData, 
                user, userData, isLoading,
                staffList: dbData.employees, 
                businessCategories: dbData.businessExpenseCategories, 
                familyCategories: dbData.familyExpenseCategories, 
                reports: dbData.cashDrops
            };

            return <DataContext.Provider value={value}>{children}</DataContext.Provider>;
        };
        // #endregion

        // =================================================================================
        // #region 2. CONSTANTS & HELPERS
        // =================================================================================
        const CONSTANTS = {
            NAV_ITEMS: [
                
                { id: 'cashDrop', label: 'Cash Drop Report', icon: 'Droplets' },
                { id: 'saleReport', label: 'Sale Report', icon: 'BarChart3' },
                { id: 'purchaseOrder', label: 'Purchase Order', icon: 'ShoppingCart' },
                { id: 'expenseReport', label: 'Expense Report', icon: 'CreditCard' },
                { id: 'cashflowReport', label: 'CashFlow Report', icon: 'PieChart' },
                { id: 'settings', label: 'Settings', icon: 'Settings' },
            ],
            ALL_PAGES: [
            
                { id: 'cashDrop', label: 'Cash Drop Report' }, 
                { id: 'saleReport', label: 'Sale Report' },
                { id: 'purchaseOrder', label: 'Purchase Order' },
                { id: 'expenseReport', label: 'Expense Report' }, 
                { id: 'cashflowReport', label: 'CashFlow Report' }, 
                { id: 'settings', label: 'Settings' },
            ],
            MAKE_WEBHOOK_URL: 'https://hook.eu2.make.com/zdwmgoi1rnj2n5u1c74uzw93zhx4mvxe'
        };

        const getCambodiaISODate = (date = new Date()) => date.toLocaleDateString('en-CA', { timeZone: 'Asia/Phnom_Penh' });
        const formatInCambodiaTime = (ts) => ts?.toDate ? ts.toDate().toLocaleString('en-GB', { timeZone: 'Asia/Phnom_Penh', year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }).replace(',', '') : 'N/A';
        const formatInCambodiaDateOnly = (ts) => ts?.toDate ? ts.toDate().toLocaleDateString('en-GB', { timeZone: 'Asia/Phnom_Penh' }).split('/').reverse().join('-') : 'N/A';
        const createTimestampFromDate = (dateString) => window.Firebase.Timestamp.fromDate(new Date(dateString));
        const createTimestampFromDateAndCurrentTime = (dateString) => {
            const now = new Date();
            const [year, month, day] = dateString.split('-').map(Number);
            const combinedDate = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds());
            return window.Firebase.Timestamp.fromDate(combinedDate);
        };
        const parseFormattedNumber = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
        const formatCurrency = (val, currency = 'KHR') => {
            const num = parseFormattedNumber(val);
            if (currency === 'KHR') {
                // Format to 2 decimal places with comma separators and the Riel symbol
                return `${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}៛`;
            }
            // Original USD formatting
            const options = {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            };
            return new Intl.NumberFormat('en-US', options).format(num);
        };
        // #endregion

        // =================================================================================
        // #region 3. REUSABLE UI COMPONENTS
        // =================================================================================
        const Icon = React.memo(({ name, size = 16, className = '' }) => {
            const Svg = ({ children, ...props }) => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {children}
                </svg>
            );

            const iconMap = {
                LoaderCircle: <Svg className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Svg>,
                PieChart: <Svg><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></Svg>,
                BarChart3: <Svg><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Svg>,
                Droplets: <Svg><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.7-3.29C8.93 8.4 7.59 7.5 7.59 6.4c0-.55.45-1 1-1s1 .45 1 1c0 .55.45 1 1 1s1-.45 1-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 1.76-1.27 2.75-2.38 3.66C3.57 10.97 3 12.06 3 13.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.54 1.53 1 3.23 1 4.98 0 2.22 1.8 4.05 4 4.05s4-1.83 4-4.05c0-1.16-.57-2.26-1.7-3.29C20.93 8.4 19.59 7.5 19.59 6.4c0-.55.45-1 1-1s1 .45 1 1c0 .55.45 1 1 1s1-.45 1-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 .46.1.9.27 1.34"/></Svg>,
                ShoppingCart: <Svg><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></Svg>,
                CreditCard: <Svg><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></Svg>,
                Settings: <Svg><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Svg>,
                Landmark: <Svg><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></Svg>,
                Users: <Svg><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Svg>,
                Truck: <Svg><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4h-8v-4l-4-4Z"/><circle cx="7.5" cy="18.5" r="2.5"/><circle cx="17.5" cy="18.5" r="2.5"/></Svg>,
                List: <Svg><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Svg>,
                X: <Svg><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Svg>,
                FileText: <Svg><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></Svg>,
                PenSquare: <Svg><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Svg>,
                Trash2: <Svg><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Svg>,
                Download: <Svg><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Svg>,
                Menu: <Svg><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Svg>,
                CheckCircle: <Svg><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Svg>,
                XCircle: <Svg><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Svg>,
                AlertTriangle: <Svg><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Svg>,
                Info: <Svg><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></Svg>,
                HelpCircle: <Svg><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></Svg>,
                Plus: <Svg><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Svg>,
                Eye: <Svg><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></Svg>,
                EyeOff: <Svg><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></Svg>,
                ArrowUpCircle: <Svg><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></Svg>,
                ArrowDownCircle: <Svg><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/></Svg>,
            };

            return iconMap[name] || iconMap.HelpCircle;
        });

        const Card = ({ children, className = "", ...props }) => (
            <div className={`bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-gray-200/80 ${className}`} {...props}>
                {children}
            </div>
        );
        
        const PageHeader = ({ title, subtitle, children }) => (
            <header className="mb-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">{title}</h1>
                    {subtitle && <p className="mt-1 text-lg text-gray-600">{subtitle}</p>}
                </div>
                <div className="flex-shrink-0 flex items-center gap-2">{children}</div>
            </header>
        );
        
        const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '', icon: IconName, ...props }) => {
            const baseStyles = 'px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';
            const variants = {
                primary: 'bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-400 focus:ring-indigo-500',
                secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 disabled:bg-gray-200 focus:ring-gray-400',
                danger: 'bg-red-600 text-white hover:bg-red-700 disabled:bg-red-400 focus:ring-red-500',
                ghost: 'bg-transparent text-gray-700 hover:bg-gray-100 focus:ring-indigo-500'
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyles} ${variants[variant]} ${className}`} {...props}>
                    {IconName && <Icon name={IconName} size={16} className={IconName === 'LoaderCircle' ? 'animate-spin' : ''} />}
                    {children}
                </button>
            );
        };

        const FormInput = React.memo(({ label, name, icon: IconName, ...props }) => (
            <div className="w-full">
                {label && <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1.5">{label}</label>}
                <div className="relative">
                    {IconName && <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><Icon name={IconName} className="h-5 w-5 text-gray-400" /></div>}
                    <input name={name} id={name} {...props} className={`block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm ${IconName ? 'pl-10' : ''}`} />
                </div>
            </div>
        ));
        
        const FormTextarea = React.memo(({ label, name, ...props }) => (
            <div>
                {label && <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1.5">{label}</label>}
                <textarea name={name} id={name} {...props} rows="3" className="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm" />
            </div>
        ));

        const FormSelect = React.memo(({ label, name, options, ...props }) => (
            <div>
                {label && <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1.5">{label}</label>}
                <select name={name} id={name} {...props} className="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm">
                    {options.map((opt, index) => <option key={`${opt.value}-${index}`} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        ));
        
        const LiveFormatInput = React.memo(({ value, onChange, name, label, ...props }) => {
            const handleChange = useCallback((e) => {
                const rawValue = e.target.value;
                let sanitized = rawValue.replace(/[^0-9.]/g, '');
                const parts = sanitized.split('.');
                if (parts.length > 2) sanitized = parts[0] + '.' + parts.slice(1).join('');
                onChange({ target: { name, value: sanitized } });
            }, [onChange, name]);

            const formatForDisplay = (val) => {
                if (val === null || val === undefined || val === '') return '';
                const stringVal = String(val);
                const [integerPart, decimalPart] = stringVal.split('.');
                const formattedIntegerPart = integerPart ? new Intl.NumberFormat('en-US').format(integerPart) : '';
                if (decimalPart !== undefined) return `${formattedIntegerPart}.${decimalPart}`;
                if (stringVal.endsWith('.')) return `${formattedIntegerPart}.`;
                return formattedIntegerPart;
            };

            return <FormInput label={label} name={name} value={formatForDisplay(value)} onChange={handleChange} placeholder="0" {...props}/>;
        });

        const Modal = ({ children, onClose, title, size = 'xl' }) => {
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '2xl': 'max-w-2xl', '4xl': 'max-w-4xl' };
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className={`bg-gray-50 rounded-xl shadow-2xl w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col modal-enter`}>
                        <header className="flex justify-between items-center p-4 border-b bg-white rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-900">{title}</h3>
                            <Button variant="ghost" onClick={onClose} className="p-1 rounded-full" icon="X" />
                        </header>
                        <div className="p-6 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };
        
        const ConfirmationModal = React.memo(({ title, message, onConfirm, onClose, isSubmitting, confirmVariant = 'primary', confirmText = 'Confirm' }) => (
            <Modal title={title} onClose={onClose} size="sm">
                <div className="space-y-4">
                    <p className="text-sm text-gray-600">{message}</p>
                    <div className="flex justify-end gap-4">
                        <Button onClick={onClose} variant="secondary">Cancel</Button>
                        <Button onClick={onConfirm} disabled={isSubmitting} variant={confirmVariant} className="w-28" icon={isSubmitting ? "LoaderCircle" : null}>
                            {isSubmitting ? '' : confirmText}
                        </Button>
                    </div>
                </div>
            </Modal>
        ));

        const NoteModal = React.memo(({ note, onClose }) => (
             <Modal title="Note" onClose={onClose} size="md">
                <p className="text-sm text-gray-800 whitespace-pre-wrap bg-gray-100 p-4 rounded-lg">{note}</p>
                <div className="flex justify-end mt-4">
                    <Button onClick={onClose} variant="secondary">Close</Button>
                </div>
            </Modal>
        ));

        const Notification = ({ message, type, onClose }) => {
            const baseClasses = "fixed top-5 right-5 z-[100] flex items-center w-full max-w-xs p-4 space-x-4 text-gray-500 bg-white divide-x divide-gray-200 rounded-lg shadow-2xl space-x";
            const typeClasses = {
                success: 'text-green-800 bg-green-50',
                error: 'text-red-800 bg-red-50',
                warning: 'text-yellow-800 bg-yellow-50',
                info: 'text-blue-800 bg-blue-50',
            };
            const icons = {
                success: <Icon name="CheckCircle" className="text-green-500" />,
                error: <Icon name="XCircle" className="text-red-500" />,
                warning: <Icon name="AlertTriangle" className="text-yellow-500" />,
                info: <Icon name="Info" className="text-blue-500" />,
            };

            return (
                <div className={`${baseClasses} ${typeClasses[type]} notification-enter`} role="alert">
                    <div className="flex-shrink-0">{icons[type]}</div>
                    <div className="pl-4 text-sm font-normal">{message}</div>
                    <button onClick={onClose} className="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8">
                        <span className="sr-only">Close</span>
                        <Icon name="X" size={20} />
                    </button>
                </div>
            );
        };
        // #endregion
        
        // =================================================================================
        // #region 4. PAGE COMPONENTS (Implemented)
        // =================================================================================
        
        // --- START: Cash Drop Report Page ---
        const NewCashDropForm = () => {
            const { shops, appSettings, userData } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, Timestamp } = window.Firebase;
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const getInitialState = useCallback(() => {
                const defaultShop = (userData?.role === 'Admin' || userData?.role === 'Management') 
                    ? (shops[0]?.name || '') 
                    : (shops.find(s => userData?.shopIds?.includes(s.id))?.name || '');
                return {
                    date: getCambodiaISODate(), shop: defaultShop, staff: userData?.name || '',
                    shift: 'Morning', cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', note: '',
                }
            }, [shops, userData]);

            const [formData, setFormData] = useState(getInitialState());
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);

            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const grandTotal = useMemo(() => {
                const { cashUsd, cashKhr, bankUsd, bankKhr } = formData;
                const exchangeRate = appSettings.exchangeRate || 4100;
                return (parseFormattedNumber(cashUsd) + parseFormattedNumber(bankUsd)) * exchangeRate + parseFormattedNumber(cashKhr) + parseFormattedNumber(bankKhr);
            }, [formData, appSettings.exchangeRate]);

            const handleConfirmSubmit = useCallback(async () => {
                if (!isMounted.current) return;
                setIsSubmitting(true);
                try {
                    const cashDropData = {
                        shop: formData.shop, staff: formData.staff, shift: formData.shift,
                        cashUsd: parseFormattedNumber(formData.cashUsd), cashKhr: parseFormattedNumber(formData.cashKhr),
                        bankUsd: parseFormattedNumber(formData.bankUsd), bankKhr: parseFormattedNumber(formData.bankKhr),
                        grandTotalKhr: grandTotal, note: formData.note,
                        createdAt: createTimestampFromDateAndCurrentTime(formData.date),
                        submittedBy: userData.uid
                    };
                    await addDoc(collection(window.db, "cashDrops"), cashDropData);
                    
                    // Trigger Make.com webhook
                    fetch(CONSTANTS.MAKE_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dateTime: new Date().toLocaleString('en-GB', { timeZone: 'Asia/Phnom_Penh' }),
                            shop: formData.shop, staff: formData.staff,
                            cashUsd: formatCurrency(formData.cashUsd, 'USD'), cashKhr: formatCurrency(formData.cashKhr, 'KHR'),
                            bankUsd: formatCurrency(formData.bankUsd, 'USD'), bankKhr: formatCurrency(formData.bankKhr, 'KHR'),
                            total: formatCurrency(grandTotal, 'KHR'), note: formData.note
                        })
                    }).catch(err => console.error("Webhook notification failed:", err));

                    showNotification('Report submitted successfully!', 'success');
                    if(isMounted.current) setFormData(getInitialState());

                } catch (error) {
                    showNotification('Failed to submit report.', 'error');
                    console.error("Error submitting cash drop:", error);
                } finally {
                    if(isMounted.current) {
                        setIsSubmitting(false);
                        setIsConfirming(false);
                    }
                }
            }, [formData, grandTotal, userData, getInitialState, showNotification]);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData?.role === 'Admin' || userData?.role === 'Management') return shops;
                return shops.filter(s => userData?.shopIds?.includes(s.id));
            }, [shops, userData]);

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <Card className="lg:col-span-2 space-y-6">
                            <h2 className="text-xl font-bold text-gray-800">New Cash Drop Form</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                                <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleChange} options={availableShops.map(s => ({value: s.name, label: s.name}))}/>
                                <FormInput label="Staff" name="staff" value={formData.staff} disabled className="bg-gray-100"/>
                                <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                            </div>
                            <div className="space-y-4 pt-4 border-t">
                                <div>
                                    <h3 className="text-md font-semibold text-slate-600">By Cash</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                        <LiveFormatInput label="KHR (៛)" name="cashKhr" value={formData.cashKhr} onChange={handleChange} />
                                        <LiveFormatInput label="USD ($)" name="cashUsd" value={formData.cashUsd} onChange={handleChange} />
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-md font-semibold text-slate-600">By Bank</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                        <LiveFormatInput label="KHR (៛)" name="bankKhr" value={formData.bankKhr} onChange={handleChange} />
                                        <LiveFormatInput label="USD ($)" name="bankUsd" value={formData.bankUsd} onChange={handleChange} />
                                    </div>
                                </div>
                            </div>
                            <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} placeholder="Add an optional note..." />
                        </Card>
                        <Card className="lg:col-span-1 space-y-4 sticky top-24">
                            <h3 className="text-xl font-bold text-slate-800">Summary</h3>
                            <div className="space-y-3 text-md">
                                <div className="flex justify-between items-center"><span className="text-slate-600">Cash KHR:</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.cashKhr, 'KHR')}</span></div>
                                <div className="flex justify-between items-center"><span className="text-slate-600">Cash USD:</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.cashUsd, 'USD')}</span></div>
                                <div className="flex justify-between items-center"><span className="text-slate-600">Bank KHR:</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.bankKhr, 'KHR')}</span></div>
                                <div className="flex justify-between items-center"><span className="text-slate-600">Bank USD:</span><span className="font-mono font-semibold text-slate-800">{formatCurrency(formData.bankUsd, 'USD')}</span></div>
                            </div>
                            <div className="border-t border-slate-200 !my-4"></div>
                            <div className="flex justify-between items-center">
                                <span className="font-bold text-slate-800 text-lg">Grand Total: </span>
                                <span className="font-extrabold text-red-600 text-2xl">{formatCurrency(grandTotal, 'KHR')}</span>
                            </div>
                            <Button type="submit" disabled={isSubmitting} className="w-full !mt-6" icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Submitting...' : 'Submit Report'}
                            </Button>
                        </Card>
                    </form>
                    {isConfirming && <ConfirmationModal 
                        title="Confirm Report Submission"
                        message="សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន។ តើគ្រប់យ៉ាងត្រឹមត្រូវទេ?"
                        onConfirm={handleConfirmSubmit} 
                        onClose={() => setIsConfirming(false)} 
                        isSubmitting={isSubmitting}
                        confirmText="បាទ/ចាស៎​ !"
                    />}
                </>
            );
        };

        const ReportsDashboard = () => {
            const { reports, shops, userData } = useData();
            const { showNotification } = useNotification();
            const { deleteDoc, doc } = window.Firebase;
            const [filters, setFilters] = useState({ shop: '', shift: '', startDate: '', endDate: '' });
            const [deletingReport, setDeletingReport] = useState(null);
            const [editingReport, setEditingReport] = useState(null);
            const [viewingNote, setViewingNote] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage, setRowsPerPage] = useState(30);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);
            
            const filteredReports = useMemo(() => reports.filter(r => {
                if (!r.createdAt) return false;
                return (filters.shop ? r.shop === filters.shop : true) && 
                (filters.shift ? r.shift === filters.shift : true) &&
                (filters.startDate ? r.createdAt.toDate() >= new Date(filters.startDate) : true) &&
                (filters.endDate ? r.createdAt.toDate() <= new Date(new Date(filters.endDate).setHours(23,59,59,999)) : true)
            }).sort((a, b) => (b.createdAt?.toDate()?.getTime() || 0) - (a.createdAt?.toDate()?.getTime() || 0)), [reports, filters]);
            
            const paginatedReports = useMemo(() => {
                if (rowsPerPage === 'All') return filteredReports;
                const startIndex = (currentPage - 1) * rowsPerPage;
                return filteredReports.slice(startIndex, startIndex + rowsPerPage);
            }, [filteredReports, currentPage, rowsPerPage]);

            const totalPages = useMemo(() => {
                if (rowsPerPage === 'All') return 1;
                return Math.ceil(filteredReports.length / rowsPerPage);
            }, [filteredReports, rowsPerPage]);

            const handleDelete = useCallback(async () => {
                if(!deletingReport) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "cashDrops", deletingReport.id));
                    showNotification("Report deleted.", "success");
                    if (isMounted.current) setDeletingReport(null);
                } catch(e) {
                    showNotification("Failed to delete report.", "error");
                } finally {
                    if (isMounted.current) setIsDeleting(false);
                }
            }, [deletingReport, showNotification]);

            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error"); return;
                }
                const dataToExport = filteredReports.map(r => ({
                    "Date & Time": formatInCambodiaTime(r.createdAt), Shop: r.shop, Staff: r.staff,
                    Shift: r.shift, "Cash KHR": r.cashKhr || 0, "Cash USD": r.cashUsd || 0,
                    "Bank KHR": r.bankKhr || 0, "Bank USD": r.bankUsd || 0,
                    "Net Sale (KHR)": r.grandTotalKhr || 0, Note: r.note || ''
                }));
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Reports");
                window.XLSX.writeFile(wb, "CashDrop_Report.xlsx");
            }, [showNotification, filteredReports]);
            
            const totals = useMemo(() => filteredReports.reduce((acc, r) => { 
                acc.cashUsd += r.cashUsd || 0; acc.cashKhr += r.cashKhr || 0; 
                acc.bankUsd += r.bankUsd || 0; acc.bankKhr += r.bankKhr || 0; 
                acc.netSale += r.grandTotalKhr || 0; 
                return acc; 
            }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, netSale: 0 }), [filteredReports]);
            
            const canEditDelete = userData?.role === 'Admin' || userData?.role === 'Management';

            const shopColors = ['bg-blue-50', 'bg-green-50', 'bg-yellow-50', 'bg-red-50', 'bg-purple-50', 'bg-pink-50', 'bg-indigo-50', 'bg-teal-50'];
            const getShopColor = (shopName) => {
                const index = shops.findIndex(s => s.name === shopName);
                return shopColors[index % shopColors.length] || 'bg-gray-50';
            };

            return (
                <Card className="mt-8">
                    <div className="flex flex-wrap justify-between items-center mb-4 gap-y-4">
                        <h2 className="text-xl font-bold text-gray-800">Daily Cash Drop History</h2>
                        <Button onClick={handleExport} variant="secondary" icon="Download">Export</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                        <FormSelect label="Shop" name="shop" value={filters.shop} onChange={e => setFilters(f=>({...f, shop: e.target.value}))} options={[{value:'',label:'All Shops'}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                        <FormSelect label="Shift" name="shift" value={filters.shift} onChange={e => setFilters(f=>({...f, shift: e.target.value}))} options={[{value:'',label:'All Shifts'}, {value:'Morning',label:'Morning'}, {value:'Afternoon',label:'Afternoon'}, {value:'Night',label:'Night'}]} />
                        <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={e => setFilters(f=>({...f, startDate: e.target.value, dateRange: 'custom'}))}/>
                        <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={e => setFilters(f=>({...f, endDate: e.target.value, dateRange: 'custom'}))}/>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th className="p-3">Date & Time</th><th className="p-3">Shop</th><th className="p-3">Staff</th>
                                    <th className="p-3 text-right">Cash USD</th><th className="p-3 text-right">Cash KHR</th>
                                    <th className="p-3 text-right">Bank USD</th><th className="p-3 text-right">Bank KHR</th>
                                    <th className="p-3 text-right">Net Sale (៛)</th><th className="p-3 text-center">Note</th><th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedReports.map(r => (
                                    <tr key={r.id} className={`border-b hover:bg-gray-100 ${getShopColor(r.shop)}`}>
                                        <td className="p-3">{formatInCambodiaTime(r.createdAt)}</td>
                                        <td className="p-3">{r.shop}</td><td className="p-3">{r.staff}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.cashUsd, 'USD')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.bankUsd, 'USD')}</td>
                                        <td className="p-3 text-right font-mono">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-bold text-indigo-600">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        <td className="p-3 text-center">
                                            <Button variant="ghost" size="sm" onClick={() => setViewingNote(r.note)} disabled={!r.note}><Icon name="FileText" size={16}/></Button>
                                        </td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            <Button variant="ghost" size="sm" onClick={() => setEditingReport(r)} disabled={!canEditDelete}><Icon name="PenSquare" size={16}/></Button>
                                            <Button variant="ghost" size="sm" onClick={() => setDeletingReport(r)} disabled={!canEditDelete} className="text-red-600 hover:bg-red-100"><Icon name="Trash2" size={16}/></Button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-slate-200 font-bold">
                                <tr>
                                    <td colSpan={10} className="p-3">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Rows per page:</span>
                                                <select value={rowsPerPage} onChange={e => setRowsPerPage(e.target.value === 'All' ? 'All' : Number(e.target.value))} className="p-1 border rounded-md">
                                                    <option value={30}>30</option>
                                                    <option value={50}>50</option>
                                                    <option value={100}>100</option>
                                                    <option value={200}>200</option>
                                                    <option value="All">All</option>
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Page {currentPage} of {totalPages}</span>
                                                <Button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1}>&lt;</Button>
                                                <Button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages}>&gt;</Button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colSpan={3} className="p-3 text-right">Totals</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankUsd, 'USD')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono">{formatCurrency(totals.netSale, 'KHR')}</td>
                                    <td colSpan={2}></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {editingReport && <EditCashDropModal report={editingReport} onClose={() => setEditingReport(null)} />}
                    {deletingReport && <ConfirmationModal title="Delete Report" message="Are you sure? This cannot be undone." onConfirm={handleDelete} onClose={() => setDeletingReport(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {viewingNote !== null && <NoteModal note={viewingNote} onClose={() => setViewingNote(null)} />}
                </Card>
            );
        };
        
        const EditCashDropModal = ({ report, onClose }) => {
            const { shops, appSettings, staffList } = useData();
            const { showNotification } = useNotification();
            const { updateDoc, doc } = window.Firebase;
            const isMounted = useRef(true);
            
            const [formData, setFormData] = useState({
                ...report,
                date: formatInCambodiaDateOnly(report.createdAt),
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const grandTotal = useMemo(() => {
                const { cashUsd, cashKhr, bankUsd, bankKhr } = formData;
                const exchangeRate = appSettings.exchangeRate || 4100;
                return (parseFormattedNumber(cashUsd) + parseFormattedNumber(bankUsd)) * exchangeRate + parseFormattedNumber(cashKhr) + parseFormattedNumber(bankKhr);
            }, [formData, appSettings.exchangeRate]);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isMounted.current) return;
                setIsSubmitting(true);
                try {
                    const updatedData = {
                        shop: formData.shop,
                        staff: formData.staff,
                        shift: formData.shift,
                        cashUsd: parseFormattedNumber(formData.cashUsd),
                        cashKhr: parseFormattedNumber(formData.cashKhr),
                        bankUsd: parseFormattedNumber(formData.bankUsd),
                        bankKhr: parseFormattedNumber(formData.bankKhr),
                        grandTotalKhr: grandTotal,
                        note: formData.note,
                        createdAt: createTimestampFromDateAndCurrentTime(formData.date),
                    };
                    await updateDoc(doc(window.db, "cashDrops", report.id), updatedData);
                    showNotification("Report updated successfully!", "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to update report.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            return (
                <Modal title="Edit Cash Drop Report" onClose={onClose} size="2xl">
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                            <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleChange} options={shops.map(s => ({value: s.name, label: s.name}))}/>
                            <FormSelect label="Staff" name="staff" value={formData.staff} onChange={handleChange} options={staffList.map(s => ({value: s.name, label: s.name}))} />
                            <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                        </div>
                        <div className="space-y-4 pt-4 border-t">
                            <div>
                                <h3 className="text-md font-semibold text-slate-600">By Cash</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                    <LiveFormatInput label="KHR (៛)" name="cashKhr" value={formData.cashKhr} onChange={handleChange} />
                                    <LiveFormatInput label="USD ($)" name="cashUsd" value={formData.cashUsd} onChange={handleChange} />
                                </div>
                            </div>
                            <div>
                                <h3 className="text-md font-semibold text-slate-600">By Bank</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                    <LiveFormatInput label="KHR (៛)" name="bankKhr" value={formData.bankKhr} onChange={handleChange} />
                                    <LiveFormatInput label="USD ($)" name="bankUsd" value={formData.bankUsd} onChange={handleChange} />
                                </div>
                            </div>
                        </div>
                        <div className="border-t pt-4 flex justify-between items-center">
                            <span className="font-bold text-slate-800 text-lg">Sub-Total</span>
                            <span className="font-extrabold text-indigo-600 text-2xl">{formatCurrency(grandTotal, 'KHR')}</span>
                        </div>
                        <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} />
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : 'Save Changes'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const CashDropPage = () => {
            const { userData } = useData();
            return (
                <div className="space-y-6">
                    <PageHeader title="Cash Drop Report" subtitle="Submit end-of-shift reports and view historical data." />
                    <NewCashDropForm />
                    {userData?.role !== 'Cashier' && <ReportsDashboard />}
                </div>
            );
        };
        // --- END: Cash Drop Report Page ---

        // --- START: Sale Report Page ---
        const SaleReportPage = () => {
            const { reports, shops } = useData();
            const { showNotification } = useNotification();
            const [filters, setFilters] = useState({
                shop: 'all',
                reportType: 'today',
                startDate: getCambodiaISODate(),
                endDate: getCambodiaISODate(),
                month: new Date().toISOString().slice(0, 7),
                week: '1'
            });

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const dateRange = useMemo(() => {
                const now = new Date();
                let start = new Date(now);
                let end = new Date(now);

                switch (filters.reportType) {
                    case 'today':
                        start.setHours(0, 0, 0, 0);
                        end.setHours(23, 59, 59, 999);
                        break;
                    case 'yesterday':
                        start.setDate(start.getDate() - 1); start.setHours(0, 0, 0, 0);
                        end.setDate(end.getDate() - 1); end.setHours(23, 59, 59, 999);
                        break;
                    case 'weekly':
                        const [year, month] = filters.month.split('-').map(Number);
                        const monthIndex = month - 1;
                        if (filters.week === '1') {
                            start = new Date(year, monthIndex, 1);
                            end = new Date(year, monthIndex, 7);
                        } else if (filters.week === '2') {
                            start = new Date(year, monthIndex, 8);
                            end = new Date(year, monthIndex, 14);
                        } else if (filters.week === '3') {
                            start = new Date(year, monthIndex, 15);
                            end = new Date(year, monthIndex, 21);
                        } else if (filters.week === '4') {
                            start = new Date(year, monthIndex, 22);
                            end = new Date(year, monthIndex + 1, 0);
                        }
                        end.setHours(23, 59, 59, 999);
                        break;
                    case 'this_month':
                        start = new Date(now.getFullYear(), now.getMonth(), 1);
                        end = new Date(now.getFullYear(), now.getMonth() + 1, 0); end.setHours(23, 59, 59, 999);
                        break;
                    case 'this_year':
                        start = new Date(now.getFullYear(), 0, 1);
                        end = new Date(now.getFullYear(), 11, 31); end.setHours(23, 59, 59, 999);
                        break;
                    case 'custom':
                        start = new Date(filters.startDate); start.setHours(0, 0, 0, 0);
                        end = new Date(filters.endDate); end.setHours(23, 59, 59, 999);
                        break;
                }
                return { start, end };
            }, [filters]);

            const aggregatedData = useMemo(() => {
                const filtered = reports.filter(report => {
                    if (!report.createdAt) return false;
                    const reportDate = report.createdAt.toDate();
                    const shopMatch = filters.shop === 'all' || report.shop === filters.shop;
                    const dateMatch = reportDate >= dateRange.start && reportDate <= dateRange.end;
                    return shopMatch && dateMatch;
                });

                const isGroupedByDay = ['today', 'yesterday', 'custom'].includes(filters.reportType);
                
                const totals = filtered.reduce((acc, report) => {
                    const reportDate = report.createdAt.toDate().toLocaleDateString('en-CA');
                    const key = isGroupedByDay ? `${reportDate}-${report.shop}` : report.shop;
                    
                    if (!acc[key]) {
                        acc[key] = { key, shop: report.shop, date: reportDate, cashKhr: 0, cashUsd: 0, bankKhr: 0, bankUsd: 0, grandTotalKhr: 0 };
                    }
                    acc[key].cashKhr += report.cashKhr || 0;
                    acc[key].cashUsd += report.cashUsd || 0;
                    acc[key].bankKhr += report.bankKhr || 0;
                    acc[key].bankUsd += report.bankUsd || 0;
                    acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                    return acc;
                }, {});

                const result = Object.values(totals);

                if (isGroupedByDay) {
                    result.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                return result;
            }, [reports, filters.shop, dateRange, filters.reportType]);

            const footerTotals = useMemo(() => {
                return aggregatedData.reduce((acc, report) => {
                    acc.cashKhr += report.cashKhr || 0;
                    acc.cashUsd += report.cashUsd || 0;
                    acc.bankKhr += report.bankKhr || 0;
                    acc.bankUsd += report.bankUsd || 0;
                    acc.grandTotalKhr += report.grandTotalKhr || 0;
                    return acc;
                }, { cashKhr: 0, cashUsd: 0, bankKhr: 0, bankUsd: 0, grandTotalKhr: 0 });
            }, [aggregatedData]);

            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error");
                    return;
                }
                const isGroupedByDay = ['today', 'yesterday', 'custom'].includes(filters.reportType);
                const dataToExport = aggregatedData.map((item, index) => ({
                    [isGroupedByDay ? 'Date' : 'No.']: isGroupedByDay ? new Date(item.date).toLocaleDateString('en-GB') : index + 1,
                    'Shop': item.shop,
                    'Cash KHR': item.cashKhr,
                    'Cash USD': item.cashUsd,
                    'Bank KHR': item.bankKhr,
                    'Bank USD': item.bankUsd,
                    'Net Sale (៛)': item.grandTotalKhr,
                }));

                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Sale Report");
                window.XLSX.writeFile(wb, `Sale_Report_${filters.reportType}.xlsx`);
                showNotification("Exported successfully!", "success");
            }, [aggregatedData, filters.reportType, showNotification]);

            const isDailyView = ['today', 'yesterday', 'custom'].includes(filters.reportType);

            return (
                <div className="space-y-6">
                    <PageHeader title="Sale Report" subtitle="Aggregated sales data." />
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-700">Sale Report Filters</h2>
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{ value: 'all', label: 'All Shops' }, ...shops.map(s => ({ value: s.name, label: s.name }))]} />
                            <FormSelect label="Report Type" name="reportType" value={filters.reportType} onChange={handleFilterChange} options={[ { value: 'today', label: 'Today' }, { value: 'yesterday', label: 'Yesterday' }, { value: 'weekly', label: 'Weekly' }, { value: 'this_month', label: 'This Month' }, { value: 'this_year', label: 'This Year' }, { value: 'custom', label: 'Custom' } ]} />
                            {filters.reportType === 'custom' && (
                                <>
                                    <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} />
                                    <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} />
                                </>
                            )}
                             {filters.reportType === 'weekly' && (
                                <>
                                    <FormInput label="Month" type="month" name="month" value={filters.month} onChange={handleFilterChange} />
                                    <FormSelect label="WCDR" name="week" value={filters.week} onChange={handleFilterChange} options={[ { value: '1', label: '1st Week' }, { value: '2', label: '2nd Week' }, { value: '3', label: '3rd Week' }, { value: '4', label: '4th Week' } ]} />
                                </>
                            )}
                        </div>
                    </Card>

                    <Card>
                        <h2 className="text-xl font-bold mb-4 text-gray-700">Report Details</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3">{isDailyView ? 'Date' : 'No.'}</th>
                                        <th className="p-3">Shop</th>
                                        <th className="p-3 text-right">Cash KHR</th>
                                        <th className="p-3 text-right">Cash USD</th>
                                        <th className="p-3 text-right">Bank KHR</th>
                                        <th className="p-3 text-right">Bank USD</th>
                                        <th className="p-3 text-right">Net Sale (៛)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {aggregatedData.length > 0 ? aggregatedData.map((item, index) => (
                                        <tr key={item.key} className="border-b hover:bg-gray-50">
                                            <td className="p-3">{isDailyView ? new Date(item.date).toLocaleDateString('en-GB') : index + 1}</td>
                                            <td className="p-3 font-semibold text-gray-800">{item.shop}</td>
                                            <td className="p-3 text-right font-mono">{item.cashKhr.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{item.cashUsd.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{item.bankKhr.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{item.bankUsd.toLocaleString()}</td>
                                            <td className="p-3 text-right font-bold text-indigo-600">{item.grandTotalKhr.toLocaleString()}</td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan="7" className="text-center p-8 text-gray-500">No sales data for the selected period.</td></tr>
                                    )}
                                </tbody>
                                {aggregatedData.length > 0 && (
                                    <tfoot className="bg-gray-200 font-bold">
                                        <tr>
                                            <td colSpan="2" className="p-3 text-right">Sub Total</td>
                                            <td className="p-3 text-right font-mono">{footerTotals.cashKhr.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{footerTotals.cashUsd.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{footerTotals.bankKhr.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{footerTotals.bankUsd.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono text-indigo-700">{footerTotals.grandTotalKhr.toLocaleString()}</td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };
        // --- END: Sale Report Page ---

        // --- START: Purchase Order Page ---
        const PurchaseOrderPage = () => {
             const [activeTab, setActiveTab] = useState('pos');

            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`px-4 py-2 text-sm font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                    {label}
                </button>
            );

            return (
                 <div className="space-y-6">
                    <PageHeader title="Purchase Orders" subtitle="Manage purchase orders, internal transfers, and vendor tracking." />
                    <div className="border-b border-gray-200 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="pos" label="Purchase Orders" isActive={activeTab === 'pos'} onClick={setActiveTab} />
                        <TabButton tabName="internal_transfer" label="Internal Transfer" isActive={activeTab === 'internal_transfer'} onClick={setActiveTab} />
                        <TabButton tabName="vendor_tracking" label="Vendor Tracking" isActive={activeTab === 'vendor_tracking'} onClick={setActiveTab} />
                        <TabButton tabName="vendors" label="Vendors" isActive={activeTab === 'vendors'} onClick={setActiveTab} />
                    </div>
                    <div className="mt-6">
                        <div className={activeTab === 'pos' ? '' : 'hidden'}><PurchaseOrdersTab /></div>
                        <div className={activeTab === 'internal_transfer' ? '' : 'hidden'}><InternalTransferTab /></div>
                        <div className={activeTab === 'vendor_tracking' ? '' : 'hidden'}><VendorTrackingTab /></div>
                        <div className={activeTab === 'vendors' ? '' : 'hidden'}><ManageVendorsSection /></div>
                    </div>
                </div>
            )
        }
        
        const PurchaseOrdersTab = () => {
            const { userData, shops, vendors, purchaseOrders, cashDrops, internalTransfers, appSettings, staffList } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, doc, updateDoc, Timestamp } = window.Firebase;
            const isMounted = useRef(true);

            const [filters, setFilters] = useState({ shop: '', vendor: '', status: '', startDate: '', endDate: '' });

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const getInitialFormState = useCallback((shopName) => ({
                poDate: getCambodiaISODate(),
                shop: shopName,
                vendor: '',
                status: 'Unpaid',
                amountKhr: '',
                amountUsd: '',
                note: '',
                orderBy: userData?.name || ''
            }), [userData]);

            const userPrimaryShop = useMemo(() => {
                if (!userData || !availableShops.length) return '';
                return availableShops[0]?.name || '';
            }, [userData, availableShops]);

            const [formState, setFormState] = useState(() => getInitialFormState(userPrimaryShop));
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [editingPO, setEditingPO] = useState(null);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            useEffect(() => {
                if (userPrimaryShop && !editingPO) {
                    setFormState(getInitialFormState(userPrimaryShop));
                }
            }, [userPrimaryShop, editingPO, getInitialFormState]);

            const currentGCA = useMemo(() => {
                const activeShop = editingPO ? editingPO.shop : formState.shop;
                if (!activeShop) return 0;

                const selectedShopData = shops.find(s => s.name === activeShop);
                const openingGCA = selectedShopData?.gca || 0;
                const saleMargin = selectedShopData?.saleMargin || 0;
                const exchangeRate = appSettings.exchangeRate || 4100;

                const netSale = cashDrops
                    .filter(cd => cd.shop === activeShop)
                    .reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                
                const salesContribution = netSale * (1 - (saleMargin / 100));

                const totalPO = purchaseOrders
                    .filter(po => po.shop === activeShop)
                    .reduce((sum, po) => {
                         const subTotal = (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate);
                         return sum + subTotal;
                    }, 0);
                
                const totalTransIn = internalTransfers
                    .filter(it => it.toShop === activeShop)
                    .reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * exchangeRate), 0);

                const totalTransOut = internalTransfers
                    .filter(it => it.fromShop === activeShop)
                    .reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * exchangeRate), 0);

                return openingGCA + salesContribution - totalPO - totalTransIn + totalTransOut;
            }, [editingPO, formState.shop, shops, cashDrops, purchaseOrders, internalTransfers, appSettings]);

            const subTotalPOs = useMemo(() => {
                const activeData = editingPO || formState;
                const khr = parseFormattedNumber(activeData.amountKhr);
                const usd = parseFormattedNumber(activeData.amountUsd);
                return (usd * (appSettings.exchangeRate || 4100)) + khr;
            }, [editingPO, formState, appSettings.exchangeRate]);
            
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                const setter = editingPO ? setEditingPO : setFormState;
                setter(prev => ({...prev, [name]: value}));
            };
            
            const handleVendorSelect = (vendorName) => {
                const setter = editingPO ? setEditingPO : setFormState;
                setter(prev => ({...prev, vendor: vendorName}));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const currentFormData = editingPO || formState;

                const isVendorValid = vendors.some(v => v.name === currentFormData.vendor);
                if (!currentFormData.vendor || !isVendorValid) {
                    showNotification("Please select a valid vendor from the list.", "error");
                    return;
                }

                if(!isMounted.current) return;
                setIsSubmitting(true);

                const dataToSave = {
                    date: createTimestampFromDateAndCurrentTime(currentFormData.poDate),
                    shop: currentFormData.shop,
                    vendor: currentFormData.vendor,
                    status: currentFormData.status,
                    amountKhr: parseFormattedNumber(currentFormData.amountKhr),
                    amountUsd: parseFormattedNumber(currentFormData.amountUsd),
                    note: currentFormData.note,
                    orderBy: currentFormData.orderBy,
                    createdBy: editingPO ? editingPO.createdBy : userData.uid,
                    lastModifiedBy: userData.uid,
                    paidAt: currentFormData.status === 'Paid' && (!editingPO || !editingPO.paidAt) ? Timestamp.now() : (editingPO?.paidAt || null),
                };

                try {
                    if (editingPO) {
                        await updateDoc(doc(db, "purchaseOrders", editingPO.id), dataToSave);
                        showNotification("Purchase Order updated!", "success");
                        if(isMounted.current) setEditingPO(null);
                    } else {
                        await addDoc(collection(db, "purchaseOrders"), dataToSave);
                        showNotification("Purchase Order created!", "success");
                    }
                    if(isMounted.current) setFormState(getInitialFormState(userPrimaryShop));
                } catch (error) {
                    showNotification("Failed to save Purchase Order.", "error");
                } finally {
                    if(isMounted.current) setIsSubmitting(false);
                }
            };
            
            const handleEdit = (po) => {
                setEditingPO({
                    ...po,
                    poDate: formatInCambodiaDateOnly(po.date),
                    amountKhr: po.amountKhr || '',
                    amountUsd: po.amountUsd || '',
                    orderBy: po.orderBy || ''
                });
                window.scrollTo(0, 0);
            };

            const handleCancelEdit = () => {
                setEditingPO(null);
                setFormState(getInitialFormState(userPrimaryShop));
            };
            
            const activeFormData = editingPO || formState;

            return (
                <div className="space-y-6">
                    <Card>
                        <h2 className="text-xl font-bold mb-4">{editingPO ? 'Edit Purchase Order' : 'Create Purchase Order'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <FormInput label="PO Date" type="date" name="poDate" value={activeFormData.poDate} onChange={handleFormChange} />
                                <FormSelect label="Shop" name="shop" value={activeFormData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormSelect label="Order By" name="orderBy" value={activeFormData.orderBy} onChange={handleFormChange} options={staffList.map(s => ({value: s.name, label: s.name}))} disabled={userData.role !== 'Admin'}/>
                                <FormInput label="Current GCA (៛)" value={currentGCA.toLocaleString()} disabled readOnly />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <SearchableSelect 
                                    label="Vendor" 
                                    options={vendors} 
                                    value={activeFormData.vendor} 
                                    onSelect={handleVendorSelect} 
                                />
                                <LiveFormatInput label="Amount KHR" name="amountKhr" value={activeFormData.amountKhr} onChange={handleFormChange} />
                                <LiveFormatInput label="Amount USD" name="amountUsd" value={activeFormData.amountUsd} onChange={handleFormChange} />
                                <FormSelect label="Status" name="status" value={activeFormData.status} onChange={handleFormChange} options={[{value:'Unpaid', label:'Unpaid'}, {value:'Paid', label:'Paid'}]} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormTextarea label="Note" name="note" value={activeFormData.note} onChange={handleFormChange} />
                                <p className="font-bold text-lg text-red-600 bg-red-50"> <FormInput label="Sub-Total POs (៛)" value={subTotalPOs.toLocaleString()} disabled readOnly />
                            </div>
                            <div className="flex justify-end gap-2">
                                {editingPO && <Button type="button" variant="secondary" onClick={handleCancelEdit}>Cancel</Button>}
                                <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                    {isSubmitting ? 'Saving...' : (editingPO ? 'Update PO' : 'Create PO')}
                                </Button>
                            </div>
                        </form>
                    </Card>
                    <PurchaseOrderHistory onEdit={handleEdit} filters={filters} setFilters={setFilters} />
                </div>
            );
        };

        const SearchableSelect = ({ label, options, value, onSelect }) => {
            const [searchTerm, setSearchTerm] = useState(value || '');
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                if (value !== searchTerm) {
                    setSearchTerm(value || '');
                }
            }, [value]);

            const filteredOptions = useMemo(() => {
                if (!searchTerm) return options;
                return options.filter(option => 
                    option.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, options]);

            const handleSelect = (optionName) => {
                onSelect(optionName);
                setSearchTerm(optionName);
                setIsOpen(false);
            };
            
            const handleChange = (e) => {
                const newSearchTerm = e.target.value;
                setSearchTerm(newSearchTerm);
                onSelect(newSearchTerm); // Immediately update parent state
                setIsOpen(true);
            };

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);
            
            return (
                <div className="relative" ref={wrapperRef}>
                    <FormInput 
                        label={label} 
                        value={searchTerm}
                        onChange={handleChange}
                        onFocus={() => setIsOpen(true)}
                        autoComplete="off"
                        name="vendor-search"
                    />
                    {isOpen && (
                        <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <li 
                                        key={option.id} 
                                        className="px-3 py-2 cursor-pointer hover:bg-indigo-100"
                                        onClick={() => handleSelect(option.name)}
                                    >
                                        {option.name}
                                    </li>
                                ))
                            ) : (
                                <li className="px-3 py-2 text-gray-500">No results found</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };
        
        const PurchaseOrderHistory = ({ onEdit, filters, setFilters }) => {
            const { purchaseOrders, shops, vendors, userData, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc, updateDoc, Timestamp } = window.Firebase;
            const isMounted = useRef(true);

            const [deletingPO, setDeletingPO] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage, setRowsPerPage] = useState(15);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleFilterChange = (e) => setFilters(prev => ({...prev, [e.target.name]: e.target.value}));

            const filteredPOs = useMemo(() => {
                return purchaseOrders
                    .filter(po => {
                        if(!po.date) return false;
                        return (filters.shop ? po.shop === filters.shop : true) &&
                        (filters.vendor ? po.vendor === filters.vendor : true) &&
                        (filters.status ? po.status === filters.status : true) &&
                        (filters.startDate ? po.date.toDate() >= new Date(filters.startDate) : true) &&
                        (filters.endDate ? po.date.toDate() <= new Date(new Date(filters.endDate).setHours(23,59,59,999)) : true)
                    })
                    .sort((a,b) => {
                        if (a.status === 'Unpaid' && b.status !== 'Unpaid') return -1;
                        if (a.status !== 'Unpaid' && b.status === 'Unpaid') return 1;
                        return (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0);
                    });
            }, [purchaseOrders, filters]);
            
            const totalPages = useMemo(() => Math.ceil(filteredPOs.length / rowsPerPage), [filteredPOs, rowsPerPage]);

            const paginatedPOs = useMemo(() => {
                const startIndex = (currentPage - 1) * rowsPerPage;
                return filteredPOs.slice(startIndex, startIndex + rowsPerPage);
            }, [filteredPOs, currentPage, rowsPerPage]);

            const footerTotals = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;
                return filteredPOs.reduce((acc, po) => {
                    const khr = po.amountKhr || 0;
                    const usd = po.amountUsd || 0;
                    acc.khr += khr;
                    acc.usd += usd;
                    acc.subTotal += khr + (usd * exchangeRate);
                    return acc;
                }, { khr: 0, usd: 0, subTotal: 0 });
            }, [filteredPOs, appSettings.exchangeRate]);

            const handleDelete = async () => {
                if (!deletingPO) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "purchaseOrders", deletingPO.id));
                    showNotification("PO deleted.", "success");
                    if(isMounted.current) setDeletingPO(null);
                } catch (error) {
                    showNotification("Failed to delete PO.", "error");
                } finally {
                    if(isMounted.current) setIsDeleting(false);
                }
            };
            
            const handleMarkPaid = async (poId) => {
                try {
                    await updateDoc(doc(window.db, "purchaseOrders", poId), {
                        status: 'Paid',
                        paidAt: Timestamp.now()
                    });
                    showNotification("PO marked as Paid.", "success");
                } catch (error) {
                    showNotification("Failed to update PO status.", "error");
                }
            };

            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error"); return;
                }
                const exchangeRate = appSettings.exchangeRate || 4100;
                const dataToExport = filteredPOs.map(po => {
                    const subTotal = (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate);
                    return {
                        "PO Date": formatInCambodiaDateOnly(po.date),
                        "Shop": po.shop,
                        "Vendor": po.vendor,
                        "Order By": po.orderBy,
                        "Amount KHR": po.amountKhr || 0,
                        "Amount USD": po.amountUsd || 0,
                        "Sub-Total (៛)": subTotal,
                        "Status": po.status,
                        "Paid At": po.paidAt ? formatInCambodiaTime(po.paidAt) : 'N/A',
                        "Note": po.note || ''
                    }
                });
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "PurchaseOrders");
                window.XLSX.writeFile(wb, "PurchaseOrder_History.xlsx");
            }, [showNotification, filteredPOs, appSettings.exchangeRate]);
            
            return (
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Purchase Order History</h2>
                        <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                        <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'', label:'All Shops'}, ...shops.map(s => ({value: s.name, label: s.name}))]} />
                        <FormSelect label="Vendor" name="vendor" value={filters.vendor} onChange={handleFilterChange} options={[{value: '', label:'All Vendors'}, ...vendors.map(v => ({value: v.name, label: v.name}))]} />
                        <FormSelect label="Status" name="status" value={filters.status} onChange={handleFilterChange} options={[{value:'', label:'All Status'}, {value:'Paid', label:'Paid'}, {value:'Unpaid', label:'Unpaid'}]} />
                        <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} />
                        <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th className="p-3">PO Date</th><th className="p-3">Shop</th><th className="p-3">Vendor</th>
                                    <th className="p-3">Order By</th>
                                    <th className="p-3 text-right">Amount KHR</th><th className="p-3 text-right">Amount USD</th>
                                    <th className="p-3 text-right">Sub-Total (៛)</th><th className="p-3">Status</th>
                                    <th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedPOs.map(po => {
                                    const subTotal = (po.amountKhr || 0) + ((po.amountUsd || 0) * (appSettings.exchangeRate || 4100));
                                    return (
                                    <tr key={po.id} className="border-b hover:bg-gray-50" style={po.status === 'Unpaid' ? { backgroundColor: '#E66386' } : {}}>
                                        <td className="p-3">{formatInCambodiaDateOnly(po.date)}</td>
                                        <td className="p-3">{po.shop}</td>
                                        <td className="p-3 font-semibold">{po.vendor}</td>
                                        <td className="p-3">{po.orderBy}</td>
                                        <td className="p-3 text-right font-mono">{(po.amountKhr || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{(po.amountUsd || 0).toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono font-bold">{subTotal.toLocaleString()}</td>
                                        <td className="p-3">{po.status}{po.status === 'Paid' && po.paidAt ? ` (${formatInCambodiaTime(po.paidAt)})` : ''}</td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            {(userData.role === 'Admin' || userData.role === 'Management') && po.status === 'Unpaid' && <Button variant="ghost" size="sm" onClick={() => handleMarkPaid(po.id)} className="text-red-600 font-bold">Mark Paid</Button>}
                                            {(userData.role === 'Admin' || userData.role === 'Management') && <Button variant="ghost" size="sm" onClick={() => onEdit(po)}><Icon name="PenSquare"/></Button>}
                                            {userData.role === 'Admin' && <Button variant="ghost" size="sm" onClick={() => setDeletingPO(po)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>}
                                        </td>
                                    </tr>
                                )})}
                            </tbody>
                             <tfoot className="bg-gray-200 font-bold">
                                <tr>
                                    <td colSpan="9" className="p-3">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Rows per page:</span>
                                                <select value={rowsPerPage} onChange={e => {setRowsPerPage(Number(e.target.value)); setCurrentPage(1);}} className="p-1 border rounded-md bg-white">
                                                    <option value={15}>15</option>
                                                    <option value={30}>30</option>
                                                    <option value={45}>45</option>
                                                    <option value={100}>100</option>
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Page {currentPage} of {totalPages}</span>
                                                <Button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1}>&lt;</Button>
                                                <Button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages}>&gt;</Button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colSpan="4" className="p-3 text-right">Filtered Totals</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.khr.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.usd.toLocaleString()}</td>
                                    <td className="p-3 text-right font-mono">{footerTotals.subTotal.toLocaleString()}</td>
                                    <td colSpan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {deletingPO && <ConfirmationModal title="Delete Purchase Order" message="Are you sure?" onConfirm={handleDelete} onClose={() => setDeletingPO(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                </Card>
            );
        };
        
        const InternalTransferTab = () => {
            const { shops, internalTransfers, userData, appSettings } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection, deleteDoc, doc, updateDoc, Timestamp } = window.Firebase;
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [deletingTransfer, setDeletingTransfer] = useState(null);
            const [editingTransfer, setEditingTransfer] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [filters, setFilters] = useState({ fromShop: '', startDate: '', endDate: '' });
            const isMounted = useRef(true);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                if (userData.role === 'Admin' || userData.role === 'Management') return shops;
                return shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);
            
            const getInitialState = useCallback(() => ({
                date: getCambodiaISODate(), fromShop: availableShops[0]?.name || '', toShop: '',
                amountUsd: '', amountKhr: '', note: '', poNo: '', status: 'Unpaid'
            }), [availableShops]);

            const [formData, setFormData] = useState(getInitialState());

            const totalAmount = useMemo(() => {
                const khr = parseFormattedNumber(formData.amountKhr);
                const usd = parseFormattedNumber(formData.amountUsd);
                return (usd * (appSettings.exchangeRate || 4100)) + khr;
            }, [formData.amountKhr, formData.amountUsd, appSettings.exchangeRate]);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = (e) => setFormData(p => ({...p, [e.target.name]: e.target.value}));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (formData.fromShop === formData.toShop) {
                    showNotification("Cannot transfer to the same shop.", "error");
                    return;
                }
                if(!isMounted.current) return;
                setIsSubmitting(true);
                try {
                    await addDoc(collection(window.db, "internalTransfers"), {
                        ...formData,
                        date: createTimestampFromDateAndCurrentTime(formData.date),
                        amountUsd: parseFormattedNumber(formData.amountUsd),
                        amountKhr: parseFormattedNumber(formData.amountKhr),
                        totalAmount: totalAmount,
                        createdBy: userData.uid,
                        paidAt: formData.status === 'Paid' ? Timestamp.now() : null
                    });
                    showNotification("Transfer recorded successfully!", "success");
                    if(isMounted.current) setFormData(getInitialState());
                } catch (error) {
                    showNotification("Failed to record transfer.", "error");
                } finally {
                    if(isMounted.current) setIsSubmitting(false);
                }
            };
            
            const handleDelete = async () => {
                if (!deletingTransfer) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "internalTransfers", deletingTransfer.id));
                    showNotification("Transfer deleted.", "success");
                    if(isMounted.current) setDeletingTransfer(null);
                } catch (error) {
                    showNotification("Failed to delete transfer.", "error");
                } finally {
                    if(isMounted.current) setIsDeleting(false);
                }
            };

            const handleMarkPaid = async (id) => {
                try {
                    await updateDoc(doc(window.db, "internalTransfers", id), {
                        status: 'Paid',
                        paidAt: Timestamp.now()
                    });
                    showNotification("Transfer marked as Paid.", "success");
                } catch (error) {
                    showNotification("Failed to update status.", "error");
                }
            };

            const filteredTransfers = useMemo(() => {
                return internalTransfers.filter(t => {
                    if (!t.date) return false;
                    return (filters.fromShop ? t.fromShop === filters.fromShop : true) &&
                    (filters.startDate ? t.date.toDate() >= new Date(filters.startDate) : true) &&
                    (filters.endDate ? t.date.toDate() <= new Date(new Date(filters.endDate).setHours(23,59,59,999)) : true)
                }).sort((a,b) => (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0));
            }, [internalTransfers, filters]);

            const historyFooterTotals = useMemo(() => {
                return filteredTransfers.reduce((acc, t) => {
                    acc.usd += t.amountUsd || 0;
                    acc.khr += t.amountKhr || 0;
                    acc.total += t.totalAmount || 0;
                    return acc;
                }, { usd: 0, khr: 0, total: 0 });
            }, [filteredTransfers]);
            
            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error"); return;
                }
                const dataToExport = filteredTransfers.map(t => ({
                    "Date": formatInCambodiaDateOnly(t.date),
                    "PO No.": t.poNo,
                    "From Shop": t.fromShop,
                    "To Shop": t.toShop,
                    "Amount USD": t.amountUsd || 0,
                    "Amount KHR": t.amountKhr || 0,
                    "Total Amount (៛)": t.totalAmount || 0,
                    "Status": t.status,
                    "Paid At": t.paidAt ? formatInCambodiaTime(t.paidAt) : 'N/A',
                    "Note": t.note || ''
                }));
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "InternalTransfers");
                window.XLSX.writeFile(wb, "InternalTransfer_History.xlsx");
            }, [showNotification, filteredTransfers]);

            return (
                <div className="space-y-6">
                    <Card>
                        <h2 className="text-xl font-bold mb-4">New Internal Transfer</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                                <FormSelect label="From Shop" name="fromShop" value={formData.fromShop} onChange={handleChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormSelect label="To Shop" name="toShop" value={formData.toShop} onChange={handleChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormInput label="PO No." name="poNo" value={formData.poNo} onChange={handleChange} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <LiveFormatInput label="Amount (USD)" name="amountUsd" value={formData.amountUsd} onChange={handleChange} />
                                <LiveFormatInput label="Amount (KHR)" name="amountKhr" value={formData.amountKhr} onChange={handleChange} />
                                <FormInput label="Total Amount (៛)" value={totalAmount.toLocaleString()} disabled readOnly />
                            </div>
                            <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} />
                            <div className="flex justify-end">
                                <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                    {isSubmitting ? 'Submitting...' : 'Submit Transfer'}
                                </Button>
                            </div>
                        </form>
                    </Card>
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Transfer History</h2>
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                            <FormSelect label="From Shop" name="fromShop" value={filters.fromShop} onChange={(e) => setFilters(p => ({...p, fromShop: e.target.value}))} options={[{value: '', label: 'All Shops'}, ...shops.map(s => ({value: s.name, label: s.name}))]} />
                            <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={(e) => setFilters(p => ({...p, startDate: e.target.value}))} />
                            <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={(e) => setFilters(p => ({...p, endDate: e.target.value}))} />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3">Date</th><th className="p-3">PO No.</th><th className="p-3">From</th><th className="p-3">To</th>
                                        <th className="p-3 text-right">Amount USD</th><th className="p-3 text-right">Amount KHR</th>
                                        <th className="p-3 text-right">Total Amount (៛)</th><th className="p-3">Status</th>
                                        <th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredTransfers.map(t => (
                                        <tr key={t.id} className="border-b hover:bg-gray-50">
                                            <td className="p-3">{formatInCambodiaDateOnly(t.date)}</td>
                                            <td className="p-3">{t.poNo}</td>
                                            <td className="p-3">{t.fromShop}</td>
                                            <td className="p-3">{t.toShop}</td>
                                            <td className="p-3 text-right font-mono">{(t.amountUsd || 0).toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{(t.amountKhr || 0).toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono font-bold">{(t.totalAmount || 0).toLocaleString()}</td>
                                            <td className="p-3">{t.status}{t.status === 'Paid' && t.paidAt ? ` (${formatInCambodiaTime(t.paidAt)})` : ''}</td>
                                            <td className="p-3 flex gap-1 justify-center">
                                                {(userData.role === 'Admin' || userData.role === 'Management') && t.status !== 'Paid' && <Button variant="ghost" size="sm" onClick={() => handleMarkPaid(t.id)}><Icon name="CheckCircle"/></Button>}
                                                {(userData.role === 'Admin' || userData.role === 'Management') && <Button variant="ghost" size="sm" onClick={() => setEditingTransfer(t)}><Icon name="PenSquare"/></Button>}
                                                {(userData.role === 'Admin' || (userData.role === 'Management' && t.status !== 'Paid')) && <Button variant="ghost" onClick={() => setDeletingTransfer(t)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-200 font-bold">
                                    <tr>
                                        <td colSpan={4} className="p-3 text-right">Totals</td>
                                        <td className="p-3 text-right font-mono">{historyFooterTotals.usd.toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{historyFooterTotals.khr.toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{historyFooterTotals.total.toLocaleString()}</td>
                                        <td colSpan={2}></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                    {deletingTransfer && <ConfirmationModal title="Delete Transfer" message="Are you sure?" onConfirm={handleDelete} onClose={() => setDeletingTransfer(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {editingTransfer && <InternalTransferEditModal transfer={editingTransfer} onClose={() => setEditingTransfer(null)} />}
                </div>
            );
        };

        const InternalTransferEditModal = ({ transfer, onClose }) => {
            const { shops, appSettings, userData } = useData();
            const { showNotification } = useNotification();
            const { updateDoc, doc } = window.Firebase;
            const isMounted = useRef(true);
            
            const [formData, setFormData] = useState({
                ...transfer,
                date: formatInCambodiaDateOnly(transfer.date),
            });
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const totalAmount = useMemo(() => {
                const khr = parseFormattedNumber(formData.amountKhr);
                const usd = parseFormattedNumber(formData.amountUsd);
                return (usd * (appSettings.exchangeRate || 4100)) + khr;
            }, [formData.amountKhr, formData.amountUsd, appSettings.exchangeRate]);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (formData.fromShop === formData.toShop) {
                    showNotification("Cannot transfer to the same shop.", "error");
                    return;
                }
                if (!isMounted.current) return;
                setIsSubmitting(true);
                try {
                    const updatedData = {
                        fromShop: formData.fromShop,
                        toShop: formData.toShop,
                        poNo: formData.poNo,
                        status: formData.status,
                        amountUsd: parseFormattedNumber(formData.amountUsd),
                        amountKhr: parseFormattedNumber(formData.amountKhr),
                        totalAmount: totalAmount,
                        note: formData.note,
                        date: createTimestampFromDateAndCurrentTime(formData.date),
                    };
                    await updateDoc(doc(window.db, "internalTransfers", transfer.id), updatedData);
                    showNotification("Transfer updated successfully!", "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to update transfer.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            return (
                <Modal title="Edit Internal Transfer" onClose={onClose} size="2xl">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                            <FormSelect label="From Shop" name="fromShop" value={formData.fromShop} onChange={handleChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormSelect label="To Shop" name="toShop" value={formData.toShop} onChange={handleChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                            <FormInput label="PO No." name="poNo" value={formData.poNo} onChange={handleChange} />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <LiveFormatInput label="Amount (USD)" name="amountUsd" value={formData.amountUsd} onChange={handleChange} />
                            <LiveFormatInput label="Amount (KHR)" name="amountKhr" value={formData.amountKhr} onChange={handleChange} />
                            <FormInput label="Total Amount (៛)" value={totalAmount.toLocaleString()} disabled readOnly />
                        </div>
                        <FormTextarea label="Note" name="note" value={formData.note} onChange={handleChange} />
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                {isSubmitting ? 'Saving...' : 'Save Changes'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const VendorTrackingTab = () => {
            const { shops, vendors, purchaseOrders, appSettings } = useData();
            const { showNotification } = useNotification();
            const [filters, setFilters] = useState({ 
                shop: '', 
                vendor: '', 
                startDate: '', 
                endDate: '' 
            });

            const handleFilterChange = (e) => setFilters(p => ({...p, [e.target.name]: e.target.value}));

            const filteredPOs = useMemo(() => {
                 return purchaseOrders.filter(po => {
                    if(!po.date) return false;
                    const poDate = po.date.toDate();
                    const startDate = filters.startDate ? new Date(filters.startDate) : null;
                    const endDate = filters.endDate ? new Date(new Date(filters.endDate).setHours(23,59,59,999)) : null;

                    return (filters.shop ? po.shop === filters.shop : true) &&
                           (filters.vendor ? po.vendor === filters.vendor : true) &&
                           (!startDate || poDate >= startDate) &&
                           (!endDate || poDate <= endDate);
                });
            }, [purchaseOrders, filters]);

            const vendorAnalysis = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;

                const vendorSummary = vendors.map(vendor => {
                    const vendorPOs = filteredPOs.filter(po => po.vendor === vendor.name);
                    const totalValue = vendorPOs.reduce((sum, po) => sum + (po.amountKhr || 0) + ((po.amountUsd || 0) * exchangeRate), 0);
                    return {
                        id: vendor.id,
                        name: vendor.name,
                        purchaseCount: vendorPOs.length,
                        totalValue,
                    };
                });
                
                const top10 = [...vendorSummary].sort((a, b) => b.totalValue - a.totalValue).slice(0, 10);
                
                const rarelyPurchased = [...vendorSummary]
                    .filter(v => v.purchaseCount <= 1)
                    .sort((a,b) => a.purchaseCount - b.purchaseCount || a.name.localeCompare(b.name))
                    .slice(0, 20);

                return { top10, rarelyPurchased };
            }, [filteredPOs, vendors, appSettings.exchangeRate]);
            
            const groupedData = useMemo(() => {
                const grouped = filteredPOs.reduce((acc, po) => {
                    const month = po.date.toDate().toLocaleDateString('en-GB', { month: '2-digit', year: '2-digit' });
                    const key = `${month}-${po.shop}-${po.vendor}`;
                    
                    if (!acc[key]) {
                        acc[key] = {
                            key,
                            month,
                            shop: po.shop,
                            vendor: po.vendor,
                            count: 0,
                            totalKhr: 0,
                            totalUsd: 0,
                        };
                    }
                    
                    acc[key].count += 1;
                    acc[key].totalKhr += po.amountKhr || 0;
                    acc[key].totalUsd += po.amountUsd || 0;
                    
                    return acc;
                }, {});

                return Object.values(grouped).sort((a,b) => new Date(b.month.split('/')[1], b.month.split('/')[0]-1) - new Date(a.month.split('/')[1], a.month.split('/')[0]-1));
            }, [filteredPOs]);

            const footerTotals = useMemo(() => {
                const exchangeRate = appSettings.exchangeRate || 4100;
                return groupedData.reduce((acc, group) => {
                    acc.khr += group.totalKhr;
                    acc.usd += group.totalUsd;
                    acc.total += group.totalKhr + (group.totalUsd * exchangeRate);
                    return acc;
                }, { khr: 0, usd: 0, total: 0 });
            }, [groupedData, appSettings.exchangeRate]);

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-center mb-4">
                             <h2 className="text-xl font-bold">Vendor Report Filters</h2>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value: '', label: 'All Shops'}, ...shops.map(s => ({value: s.name, label: s.name}))]} />
                            <FormSelect label="Vendor" name="vendor" value={filters.vendor} onChange={handleFilterChange} options={[{value: '', label: 'All Vendors'}, ...vendors.map(v => ({value: v.name, label: v.name}))]} />
                            <FormInput label="Start Date" type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} />
                            <FormInput label="End Date" type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} />
                        </div>
                    </Card>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card>
                            <h3 className="text-lg font-bold mb-4">Top 10 Purchased Vendors</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-2 text-left">Rank</th>
                                            <th className="p-2 text-left">Vendor</th>
                                            <th className="p-2 text-right">Total Purchase (៛)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {vendorAnalysis.top10.map((v, i) => (
                                            <tr key={v.id} className="border-b">
                                                <td className="p-2 font-semibold">{i + 1}</td>
                                                <td className="p-2">{v.name}</td>
                                                <td className="p-2 text-right font-mono">{v.totalValue.toLocaleString(undefined, {minimumFractionDigits: 0})}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                        <Card>
                            <h3 className="text-lg font-bold mb-4">Rarely / Never Purchased Vendors</h3>
                             <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-2 text-left">Vendor</th>
                                            <th className="p-2 text-center">No. of Purchases</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {vendorAnalysis.rarelyPurchased.map(v => (
                                            <tr key={v.id} className="border-b">
                                                <td className="p-2">{v.name}</td>
                                                <td className="p-2 text-center font-mono">{v.purchaseCount}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>

                    <Card>
                        <h2 className="text-xl font-bold mb-4">Purchase History Summary</h2>
                        <div className="overflow-x-auto">
                             <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3">Month (MM-YY)</th>
                                        <th className="p-3">Shop Name</th>
                                        <th className="p-3">Vendor</th>
                                        <th className="p-3 text-center">No. of Purchases</th>
                                        <th className="p-3 text-right">KHR</th>
                                        <th className="p-3 text-right">USD</th>
                                        <th className="p-3 text-right">Total (KHR)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {groupedData.map((group) => {
                                        const total = group.totalKhr + (group.totalUsd * (appSettings.exchangeRate || 4100));
                                        return (
                                        <tr key={group.key} className="border-b hover:bg-gray-50">
                                            <td className="p-3">{group.month}</td>
                                            <td className="p-3">{group.shop}</td>
                                            <td className="p-3 font-semibold">{group.vendor}</td>
                                            <td className="p-3 text-center">{group.count}</td>
                                            <td className="p-3 text-right font-mono">{group.totalKhr.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{group.totalUsd.toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono font-bold">{total.toLocaleString()}</td>
                                        </tr>
                                    )})}
                                </tbody>
                                <tfoot className="bg-gray-200 font-bold">
                                    <tr>
                                        <td colSpan="4" className="p-3 text-right">Sub-Totals</td>
                                        <td className="p-3 text-right font-mono">{footerTotals.khr.toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{footerTotals.usd.toLocaleString()}</td>
                                        <td className="p-3 text-right font-mono">{footerTotals.total.toLocaleString()}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };
        
        const ManageVendorsSection = () => {
            const { vendors } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc } = window.Firebase;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingVendor, setEditingVendor] = useState(null);
            const [deletingVendor, setDeletingVendor] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const openModal = (vendor = null) => {
                setEditingVendor(vendor || { name: '', contactPerson: '', phone: '', bankName: '', accountKhr: '', accountUsd: '' });
                setIsModalOpen(true);
            };

            const handleDelete = async () => {
                if (!deletingVendor) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "vendors", deletingVendor.id));
                    showNotification("Vendor deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete vendor.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingVendor(null);
                        setIsDeleting(false);
                    }
                }
            };

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-slate-700">Vendor Management</h2>
                        <Button onClick={() => openModal()} icon="Plus">New Vendor</Button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th className="p-3">Vendor Name</th>
                                    <th className="p-3">Contact Person</th>
                                    <th className="p-3">Phone</th>
                                    <th className="p-3">Bank Name</th>
                                    <th className="p-3">Acc KHR</th>
                                    <th className="p-3">Acc USD</th>
                                    <th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="text-sm text-gray-600">
                                {vendors.map(vendor => (
                                    <tr key={vendor.id} className="border-b hover:bg-slate-100">
                                        <td className="p-3 font-semibold">{vendor.name}</td>
                                        <td className="p-3">{vendor.contactPerson}</td>
                                        <td className="p-3">{vendor.phone}</td>
                                        <td className="p-3">{vendor.bankName}</td>
                                        <td className="p-3">{vendor.accountKhr}</td>
                                        <td className="p-3">{vendor.accountUsd}</td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            <Button variant="ghost" onClick={() => openModal(vendor)}><Icon name="PenSquare"/></Button>
                                            <Button variant="ghost" onClick={() => setDeletingVendor(vendor)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && <VendorEditModal vendor={editingVendor} onClose={() => setIsModalOpen(false)} />}
                    {deletingVendor && <ConfirmationModal title="Delete Vendor" message={`Delete ${deletingVendor.name}?`} onConfirm={handleDelete} onClose={() => setDeletingVendor(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                </Card>
            );
        };

        const VendorEditModal = ({ vendor, onClose }) => {
            const { showNotification } = useNotification();
            const { doc, updateDoc, addDoc, collection } = window.Firebase;
            const [formData, setFormData] = useState({ name: '', contactPerson: '', phone: '', bankName: '', accountKhr: '', accountUsd: '', ...vendor });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const dataToSave = { 
                        name: formData.name, 
                        contactPerson: formData.contactPerson, 
                        phone: formData.phone,
                        bankName: formData.bankName,
                        accountKhr: formData.accountKhr,
                        accountUsd: formData.accountUsd
                    };
                    if (formData.id) {
                        await updateDoc(doc(window.db, "vendors", formData.id), dataToSave);
                    } else {
                        await addDoc(collection(window.db, "vendors"), dataToSave);
                    }
                    showNotification(`Vendor ${formData.id ? 'updated' : 'added'}.`, "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to save vendor.", "error");
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };

            return (
                <Modal title={vendor.id ? 'Edit Vendor' : 'Add Vendor'} onClose={onClose} size="lg">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <FormInput label="Vendor Name" name="name" value={formData.name} onChange={handleChange} required />
                        <FormInput label="Contact Person" name="contactPerson" value={formData.contactPerson} onChange={handleChange} />
                        <FormInput label="Phone Number" name="phone" value={formData.phone} onChange={handleChange} />
                        <FormInput label="Bank Name" name="bankName" value={formData.bankName} onChange={handleChange} />
                        <FormInput label="Account KHR" name="accountKhr" value={formData.accountKhr} onChange={handleChange} />
                        <FormInput label="Account USD" name="accountUsd" value={formData.accountUsd} onChange={handleChange} />
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} className="w-24" icon={isSubmitting ? "LoaderCircle" : null}>{isSubmitting ? '' : "Save"}</Button>
                        </div>
                    </form>
                </Modal>
            );
        };
        // --- END: Purchase Order Page ---

        // --- START: Expense Report Page ---
        const ExpenseReportPage = () => {
            const { userData, businessExpenses, familyExpenses, shops, businessCategories, familyCategories, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc, updateDoc, addDoc, collection } = window.Firebase;

            const [editingExpense, setEditingExpense] = useState(null);
            const [deletingExpense, setDeletingExpense] = useState(null);
            const [viewingExpense, setViewingExpense] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [filters, setFilters] = useState({ shop: 'all', month: '' });
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filteredExpenses = useMemo(() => {
                let combinedList = [
                    ...businessExpenses.map(e => ({ ...e, type: 'Business' })),
                    ...(userData?.role === 'Admin' ? familyExpenses.map(e => ({ ...e, type: 'Family' })) : [])
                ];

                return combinedList.filter(exp => {
                    const shopMatch = filters.shop === 'all' || exp.type !== 'Business' || exp.shop === filters.shop;
                    if (!filters.month) return shopMatch;
                    
                    if (!exp.date) return false;
                    const [year, month] = filters.month.split('-');
                    const expDate = exp.date.toDate();
                    const monthMatch = expDate.getFullYear() === parseInt(year) && (expDate.getMonth() + 1) === parseInt(month);
                    
                    return shopMatch && monthMatch;
                }).sort((a, b) => (b.date?.toDate()?.getTime() || 0) - (a.date?.toDate()?.getTime() || 0));
            }, [businessExpenses, familyExpenses, userData, filters]);

            const handleDelete = async () => {
                if (!deletingExpense || !isMounted.current) return;
                setIsDeleting(true);
                const collectionName = deletingExpense.type === 'Business' ? 'businessExpenses' : 'familyExpenses';
                try {
                    await deleteDoc(doc(db, collectionName, deletingExpense.id));
                    showNotification("Expense deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete expense.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingExpense(null);
                        setIsDeleting(false);
                    }
                }
            };
            
            const handleExport = useCallback(() => {
                if (!window.XLSX) {
                    showNotification("Excel library not loaded yet.", "error");
                    return;
                }
                const dataToExport = filteredExpenses.map(exp => ({
                    "Date": formatInCambodiaDateOnly(exp.date),
                    "Type": exp.type,
                    "Shop/Paid By": exp.shop || exp.paidBy || 'N/A',
                    "Category": exp.category,
                    "Amount KHR": exp.amountKhr || 0,
                    "Amount USD": exp.amountUsd || 0,
                    "Total Amount (KHR)": exp.totalAmountKhr,
                    "Note": exp.note || ''
                }));
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Expense Report");
                window.XLSX.writeFile(wb, "Expense_Report.xlsx");
                showNotification("Exported successfully!", "success");
            }, [filteredExpenses, showNotification]);

            const ExpenseViewModal = ({ expense, onClose, onEdit }) => {
                if (!expense) return null;
                const details = [
                    { label: "Date", value: formatInCambodiaDateOnly(expense.date) },
                    { label: "Type", value: expense.type },
                    { label: expense.type === 'Business' ? "Shop" : "Paid By", value: expense.shop || expense.paidBy || 'N/A' },
                    { label: "Category", value: expense.category },
                    { label: "Amount (KHR)", value: formatCurrency(expense.amountKhr || 0, 'KHR'), isAmount: true },
                    { label: "Amount (USD)", value: formatCurrency(expense.amountUsd || 0, 'USD'), isAmount: true },
                    { label: "Total Amount", value: formatCurrency(expense.totalAmountKhr || 0, 'KHR'), isAmount: true, isTotal: true },
                    { label: "Note", value: expense.note || 'No note provided.', isNote: true },
                ];

                return (
                    <Modal title="Expense Details" onClose={onClose} size="lg">
                        <div className="space-y-4">
                            {details.map(detail => (
                                <div key={detail.label} className={`flex flex-col sm:flex-row sm:items-center ${detail.isNote ? 'items-start' : ''}`}>
                                    <p className="w-full sm:w-1/3 text-sm font-semibold text-gray-600">{detail.label}</p>
                                    <p className={`w-full sm:w-2/3 text-gray-800 ${detail.isAmount ? 'font-mono' : ''} ${detail.isTotal ? 'font-bold text-lg text-red-600' : ''} ${detail.isNote ? 'whitespace-pre-wrap bg-gray-100 p-2 rounded-md mt-1 sm:mt-0' : ''}`}>
                                        {detail.value}
                                    </p>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end gap-4 pt-6 mt-6 border-t">
                            <Button type="button" onClick={onClose} variant="secondary">Close</Button>
                            <Button type="button" onClick={onEdit} icon="PenSquare">Edit</Button>
                        </div>
                    </Modal>
                );
            };

            const ExpenseForm = ({ expense, onClear }) => {
                const [isSubmitting, setIsSubmitting] = useState(false);
                const shareholders = useMemo(() => [...new Set(shops.flatMap(s => (s.shareholders || []).map(sh => sh.name)))], [shops]);

                const getInitialState = useCallback(() => ({
                    expenseType: 'Business', date: getCambodiaISODate(), shop: shops[0]?.name || '',
                    category: '', amountKhr: '', amountUsd: '', note: '', paidBy: shareholders[0] || ''
                }), [shops, shareholders]);
                
                const [formData, setFormData] = useState(getInitialState);

                useEffect(() => {
                    if (expense) {
                        setFormData({
                            id: expense.id, expenseType: expense.type, date: getCambodiaISODate(expense.date.toDate()),
                            shop: expense.shop || '', category: expense.category, amountKhr: String(expense.amountKhr || ''),
                            amountUsd: String(expense.amountUsd || ''), note: expense.note || '',
                            paidBy: expense.paidBy || (shareholders[0] || '')
                        });
                    } else {
                        setFormData(getInitialState());
                    }
                }, [expense, getInitialState, shareholders]);

                const subTotalKhr = useMemo(() => {
                    const khr = parseFormattedNumber(formData.amountKhr);
                    const usd = parseFormattedNumber(formData.amountUsd);
                    return (usd * (appSettings.exchangeRate || 4100)) + khr;
                }, [formData.amountKhr, formData.amountUsd, appSettings.exchangeRate]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!isMounted.current) return;
                    setIsSubmitting(true);
                    const collectionName = formData.expenseType === 'Business' ? 'businessExpenses' : 'familyExpenses';
                    const dataToSave = {
                        date: createTimestampFromDate(formData.date), category: formData.category,
                        amountKhr: parseFormattedNumber(formData.amountKhr), amountUsd: parseFormattedNumber(formData.amountUsd),
                        totalAmountKhr: subTotalKhr, note: formData.note, submittedBy: userData.uid,
                        ...(formData.expenseType === 'Business' ? { shop: formData.shop } : { paidBy: formData.paidBy })
                    };

                    try {
                        if (expense?.id) {
                            await updateDoc(doc(db, collectionName, expense.id), dataToSave);
                            showNotification("Expense updated successfully!", "success");
                        } else {
                            await addDoc(collection(db, collectionName), dataToSave);
                            showNotification("Expense added successfully!", "success");
                        }
                        if (isMounted.current) { onClear(); }
                    } catch (error) {
                        showNotification("Failed to save expense.", "error");
                    } finally {
                        if (isMounted.current) { setIsSubmitting(false); }
                    }
                };

                const expenseTypeOptions = useMemo(() => [
                    { value: 'Business', label: 'Business Expense' },
                    ...(userData?.role === 'Admin' ? [{ value: 'Family', label: 'Family Expense' }] : [])
                ], [userData]);

                const categoryOptions = formData.expenseType === 'Business' ? businessCategories : familyCategories;

                return (
                    <Card>
                        <h2 className="text-xl font-bold mb-4">{expense ? 'Edit' : 'Add New'} Expense</h2>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <FormSelect label="Expense Type" name="expenseType" value={formData.expenseType} onChange={handleChange} options={expenseTypeOptions} />
                            <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleChange} />
                            
                            {formData.expenseType === 'Business' ? (
                                <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleChange} options={shops.map(s => ({value: s.name, label: s.name}))} />
                            ) : (
                                <FormSelect label="Paid By Shareholder" name="paidBy" value={formData.paidBy} onChange={handleChange} options={shareholders.map(s => ({value: s, label: s}))} />
                            )}

                            <FormSelect label="Category" name="category" value={formData.category} onChange={handleChange} options={[{value: '', label: 'Select Category'}, ...categoryOptions.map(c => ({value: c.name, label: c.name}))]} />
                            
                            <LiveFormatInput label="Amount (KHR)" name="amountKhr" value={formData.amountKhr} onChange={handleChange} />
                            <LiveFormatInput label="Amount (USD)" name="amountUsd" value={formData.amountUsd} onChange={handleChange} />
                            
                            <div className="p-2 bg-slate-100 rounded-md">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Sub-Total (KHR)</label>
                                <p className="font-bold text-lg text-red-600">{formatCurrency(subTotalKhr, 'KHR')}</p>
                            </div>
                            
                            <div className="lg:col-span-4">
                                <FormInput label="Note" name="note" value={formData.note} onChange={handleChange} />
                            </div>
                            <div className="lg:col-span-4 flex justify-end gap-4">
                                {expense && <Button type="button" onClick={onClear} variant="secondary">Cancel Edit</Button>}
                                <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                    {isSubmitting ? 'Saving...' : (expense ? 'Update Expense' : 'Save Expense')}
                                </Button>
                            </div>
                        </form>
                    </Card>
                );
            };

            return (
                <div className="space-y-6">
                    <PageHeader title="Expense Report" subtitle="Log and manage all business and family expenses."/>
                    <ExpenseForm expense={editingExpense} onClear={() => setEditingExpense(null)} />
                    
                    <Card className="mt-8">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-700">Expense History</h2>
                            <Button onClick={handleExport} variant="secondary" icon="Download">Export to Excel</Button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-slate-50 rounded-lg">
                            <FormSelect label="Filter by Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{ value: 'all', label: 'All Shops' }, ...shops.map(s => ({ value: s.name, label: s.name }))]} />
                            <FormInput label="Filter by Month" type="month" name="month" value={filters.month} onChange={handleFilterChange} />
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3">Date</th><th className="p-3">Type</th><th className="p-3">Shop/Paid By</th>
                                        <th className="p-3">Category</th><th className="p-3 text-right">Total (KHR)</th>
                                        <th className="p-3">Note</th><th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm text-gray-600">
                                    {filteredExpenses.map(exp => (
                                        <tr key={exp.id} className="border-b hover:bg-gray-50">
                                            <td className="p-3">{formatInCambodiaDateOnly(exp.date)}</td>
                                            <td className="p-3"><span className={`px-2 py-1 text-xs rounded-full ${exp.type === 'Business' ? 'bg-sky-100 text-sky-800' : 'bg-purple-100 text-purple-800'}`}>{exp.type}</span></td>
                                            <td className="p-3">{exp.shop || exp.paidBy || 'N/A'}</td>
                                            <td className="p-3">{exp.category}</td>
                                            <td className="p-3 text-right font-mono">{exp.totalAmountKhr?.toLocaleString()}</td>
                                            <td className="p-3 truncate max-w-xs">{exp.note}</td>
                                            <td className="p-3 flex gap-1 justify-center">
                                                <Button variant="ghost" onClick={() => setViewingExpense(exp)}><Icon name="Eye"/></Button>
                                                <Button variant="ghost" onClick={() => setEditingExpense(exp)}><Icon name="PenSquare"/></Button>
                                                <Button variant="ghost" onClick={() => setDeletingExpense(exp)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                    {deletingExpense && <ConfirmationModal title="Delete Expense" message="Are you sure you want to delete this expense record?" onConfirm={handleDelete} onClose={() => setDeletingExpense(null)} isSubmitting={isDeleting} confirmVariant="danger" confirmText="Delete" />}
                    {viewingExpense && <ExpenseViewModal expense={viewingExpense} onClose={() => setViewingExpense(null)} onEdit={() => { setEditingExpense(viewingExpense); setViewingExpense(null); }} />}
                </div>
            );
        };
        // --- END: Expense Report Page ---

        // --- START: CashFlow Report Page ---
        const CashFlowReportPage = () => {
            const [activeTab, setActiveTab] = useState('shareholderNet');
            const [filters, setFilters] = useState({ month: new Date().toISOString().slice(0, 7) });
            const printRef = useRef();
            const { showNotification } = useNotification();
            const [isCapturing, setIsCapturing] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleDownloadImage = useCallback(async () => {
                if (!printRef.current || !isMounted.current) return;
                setIsCapturing(true);
                try {
                    const canvas = await html2canvas(printRef.current, { useCORS: true, scale: 2 });
                    const image = canvas.toDataURL("image/png", 1.0);
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `cashflow-report-${filters.month}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification("Image downloaded successfully!", "success");
                } catch (error) {
                    showNotification("Failed to download image.", "error");
                } finally {
                    if(isMounted.current) setIsCapturing(false);
                }
            }, [filters.month, showNotification]);

            const TabButton = ({ tabName, label, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`px-4 py-2 text-sm font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                    {label}
                </button>
            );

            return (
                <div>
                    <PageHeader title="CashFlow Report" subtitle="Monthly financial overview.">
                         <Button onClick={handleDownloadImage} disabled={isCapturing} variant="secondary" icon={isCapturing ? 'LoaderCircle' : 'Download'}>
                            {isCapturing ? 'Capturing...' : 'Download as Image'}
                        </Button>
                    </PageHeader>
                    <div className="border-b border-gray-200 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="shareholderNet" label="Shareholder NET" isActive={activeTab === 'shareholderNet'} onClick={setActiveTab} />
                        <TabButton tabName="cashflowHistory" label="CashFlow History" isActive={activeTab === 'cashflowHistory'} onClick={setActiveTab} />
                        <TabButton tabName="iitPayment" label="IIT Payment Report" isActive={activeTab === 'iitPayment'} onClick={setActiveTab} />
                        <TabButton tabName="personalCashflow" label="Personal CashFlow" isActive={activeTab === 'personalCashflow'} onClick={setActiveTab} />
                    </div>
                    <Card className="mt-6">
                        <FormInput label="Select Month" type="month" name="month" value={filters.month} onChange={(e) => setFilters({ month: e.target.value })} />
                    </Card>
                    
                    <div ref={printRef} className="bg-white p-4 rounded-lg space-y-8">
                        {activeTab === 'shareholderNet' && <ShareholderNetTab filters={filters} />}
                        {activeTab === 'cashflowHistory' && <CashflowHistoryTab filters={filters} />}
                        {activeTab === 'iitPayment' && <IitPaymentTab filters={filters} />}
                        {activeTab === 'personalCashflow' && <PersonalCashFlowManagement />}
                    </div>
                </div>
            );
        };

        const useMonthlyData = (filters) => {
            const { reports, businessExpenses, familyExpenses, shops, purchaseOrders, internalTransfers, appSettings } = useData();
            
            return useMemo(() => {
                const [year, month] = filters.month.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                const exchangeRate = appSettings.exchangeRate || 4100;

                const filterByDate = (item) => {
                    const itemDate = item.createdAt?.toDate() || item.date?.toDate();
                    return itemDate && itemDate >= startDate && itemDate <= endDate;
                };
                
                const filteredReports = reports.filter(filterByDate);
                const filteredBusinessExpenses = businessExpenses.filter(filterByDate);
                const filteredFamilyExpenses = familyExpenses.filter(filterByDate);
                const filteredInternalTransfers = internalTransfers.filter(filterByDate);
                const filteredPurchaseOrders = purchaseOrders.filter(filterByDate);

                return { exchangeRate, shops, filteredReports, filteredBusinessExpenses, filteredFamilyExpenses, filteredInternalTransfers, filteredPurchaseOrders, allPOs: purchaseOrders, allReports: reports, allTransfers: internalTransfers };
            }, [filters.month, reports, businessExpenses, familyExpenses, shops, purchaseOrders, internalTransfers, appSettings]);
        };

        const ShareholderNetTab = ({ filters }) => {
            const data = useMonthlyData(filters);

            const { shareholderData, totals } = useMemo(() => {
                const shareholderData = {};
                const allShareholders = [...new Set(data.shops.flatMap(s => (s.shareholders || []).map(sh => sh.name)))];
                allShareholders.forEach(name => {
                    shareholderData[name] = { totalGCA: 0, totalNetIncome: 0, familyExpense: 0, finalNetIncome: 0, totalCOH: 0 };
                });

                data.shops.forEach(shop => {
                    const openingGCA = shop.gca || 0;
                    const saleMargin = shop.saleMargin || 0;
                    
                    const netSaleAllTime = data.allReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const salesContributionAllTime = netSaleAllTime * (1 - (saleMargin / 100));
                    const totalPOsAllTime = data.allPOs.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersInAllTime = data.allTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersOutAllTime = data.allTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const currentGCA = openingGCA + salesContributionAllTime - totalPOsAllTime - transfersInAllTime + transfersOutAllTime;

                    const netSaleForMonth = data.filteredReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const netProfitForMonth = netSaleForMonth * (saleMargin / 100);
                    
                    (shop.shareholders || []).forEach(sh => {
                        if(shareholderData[sh.name]) {
                            shareholderData[sh.name].totalGCA += currentGCA * (sh.percentage / 100);
                            shareholderData[sh.name].totalNetIncome += netProfitForMonth * (sh.percentage / 100);
                        }
                    });
                });

                data.filteredFamilyExpenses.forEach(expense => {
                    if (shareholderData[expense.paidBy]) {
                        shareholderData[expense.paidBy].familyExpense += (expense.totalAmountKhr || 0);
                    }
                });

                Object.keys(shareholderData).forEach(name => {
                    const d = shareholderData[name];
                    d.finalNetIncome = d.totalNetIncome - d.familyExpense;
                    d.totalCOH = d.finalNetIncome + d.totalGCA;
                });
                
                const totals = Object.values(shareholderData).reduce((acc, d) => {
                    acc.totalGCA += d.totalGCA;
                    acc.totalNetIncome += d.totalNetIncome;
                    acc.familyExpense += d.familyExpense;
                    acc.finalNetIncome += d.finalNetIncome;
                    acc.totalCOH += d.totalCOH;
                    return acc;
                }, { totalGCA: 0, totalNetIncome: 0, familyExpense: 0, finalNetIncome: 0, totalCOH: 0 });

                return { shareholderData, totals };
            }, [data]);

            return (
                <Card>
                    <h3 className="text-lg font-bold mb-4">Shareholder NET</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shareholder</th>
                                    <th className="p-2 text-right">Total GCA</th><th className="p-2 text-right">Total Net-Income</th>
                                    <th className="p-2 text-right">Family Expense</th><th className="p-2 text-right">Final Net-Income</th>
                                    <th className="p-2 text-right">Total COH</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.entries(shareholderData).map(([name, d], index) => (
                                    <tr key={name} className="border-b">
                                        <td className="p-2">{index + 1}</td><td className="p-2 font-semibold">{name}</td>
                                        <td className="p-2 text-right font-mono">{d.totalGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{d.totalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono text-red-600">{d.familyExpense.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono font-bold">{d.finalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono font-bold text-indigo-600">{d.totalCOH.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-gray-200 font-bold">
                                <tr>
                                    <td colSpan="2" className="p-2 text-right">Sub-Total (KHR)</td>
                                    <td className="p-2 text-right font-mono">{totals.totalGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td className="p-2 text-right font-mono">{totals.familyExpense.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.finalNetIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalCOH.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </Card>
            );
        };

        const CashflowHistoryTab = ({ filters }) => {
            const data = useMonthlyData(filters);

            const { shopCalculations, totals } = useMemo(() => {
                const shopCalculations = data.shops.map(shop => {
                    const openingGCA = shop.gca || 0;
                    const saleMargin = shop.saleMargin || 0;
                    
                    const netSaleAllTime = data.allReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const salesContributionAllTime = netSaleAllTime * (1 - (saleMargin / 100));
                    const totalPOsAllTime = data.allPOs.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersInAllTime = data.allTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const transfersOutAllTime = data.allTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const currentGCA = openingGCA + salesContributionAllTime - totalPOsAllTime - transfersInAllTime + transfersOutAllTime;

                    const netSaleForMonth = data.filteredReports.filter(cd => cd.shop === shop.name).reduce((sum, cd) => sum + (cd.grandTotalKhr || 0), 0);
                    const bizExpenseForMonth = data.filteredBusinessExpenses.filter(e => e.shop === shop.name).reduce((sum, e) => sum + (e.totalAmountKhr || 0), 0);
                    const netProfitForMonth = netSaleForMonth * (saleMargin / 100);
                    const totalNetIncomeForMonth = netProfitForMonth - bizExpenseForMonth;
                    const totalPOForMonth = data.filteredPurchaseOrders.filter(po => po.shop === shop.name).reduce((sum, po) => sum + ((po.amountKhr || 0) + (po.amountUsd || 0) * data.exchangeRate), 0);
                    const totalTransInForMonth = data.filteredInternalTransfers.filter(it => it.toShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);
                    const totalTransOutForMonth = data.filteredInternalTransfers.filter(it => it.fromShop === shop.name).reduce((sum, it) => sum + (it.amountKhr || 0) + ((it.amountUsd || 0) * data.exchangeRate), 0);

                    return { name: shop.name, currentGCA, netSale: netSaleForMonth, netProfit: netProfitForMonth, totalPO: totalPOForMonth, totalTransIn: totalTransInForMonth, totalTransOut: totalTransOutForMonth, totalBizExpense: bizExpenseForMonth, totalNetIncome: totalNetIncomeForMonth };
                });

                const totals = shopCalculations.reduce((acc, shop) => {
                    Object.keys(shop).forEach(key => {
                        if (key !== 'name') acc[key] = (acc[key] || 0) + shop[key];
                    });
                    return acc;
                }, {});

                return { shopCalculations, totals };
            }, [data]);

            return (
                <Card>
                    <h3 className="text-lg font-bold mb-4">CashFlow History</h3>
                    <div className="overflow-x-auto">
                       <table className="w-full text-sm">
                             <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shop</th>
                                    <th className="p-2 text-right">Current GCA (៛)</th><th className="p-2 text-right">Net Sale</th>
                                    <th className="p-2 text-right">Net Profit</th><th className="p-2 text-right">Total PO</th>
                                    <th className="p-2 text-right">Total Tran-IN</th><th className="p-2 text-right">Total-Trans-OUT</th>
                                    <th className="p-2 text-right">Total Biz Expense</th><th className="p-2 text-right">Total Net Income</th>
                                </tr>
                             </thead>
                             <tbody>
                                {shopCalculations.map((shop, index) => (
                                    <tr key={shop.name} className="border-b">
                                        <td className="p-2">{index+1}</td><td className="p-2 font-semibold">{shop.name}</td>
                                        <td className="p-2 text-right font-mono">{shop.currentGCA.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{shop.netSale.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{shop.netProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                        <td className="p-2 text-right font-mono">{shop.totalPO.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{shop.totalTransIn.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{shop.totalTransOut.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono">{shop.totalBizExpense.toLocaleString()}</td>
                                        <td className="p-2 text-right font-mono font-bold">{shop.totalNetIncome.toLocaleString()}</td>
                                    </tr>
                                ))}
                             </tbody>
                             <tfoot className="bg-gray-200 font-bold">
                                <tr>
                                    <td colSpan="2" className="p-2 text-right">Sub-Totals</td>
                                    <td className="p-2 text-right font-mono">{totals.currentGCA?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td className="p-2 text-right font-mono">{totals.netSale?.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.netProfit?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalPO?.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalTransIn?.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalTransOut?.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalBizExpense?.toLocaleString()}</td>
                                    <td className="p-2 text-right font-mono">{totals.totalNetIncome?.toLocaleString()}</td>
                                </tr>
                             </tfoot>
                        </table>
                    </div>
                </Card>
            );
        };

        const IitPaymentTab = ({ filters }) => {
            const data = useMonthlyData(filters);

            const iitPaymentData = useMemo(() => {
                return Object.values(data.filteredInternalTransfers.reduce((acc, transfer) => {
                    const key = `${transfer.toShop}-${transfer.fromShop}`;
                    if (!acc[key]) {
                        acc[key] = { payee: transfer.toShop, receiver: transfer.fromShop, totalAmount: 0 };
                    }
                    acc[key].totalAmount += transfer.totalAmount || 0;
                    return acc;
                }, {}));
            }, [data]);

            return (
                <Card>
                    <h3 className="text-lg font-bold mb-4">IIT Payment Report</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 text-left">No.</th><th className="p-2 text-left">Shop Payee</th>
                                    <th className="p-2 text-left">Shop Receiver</th><th className="p-2 text-right">Total Amount (៛)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {iitPaymentData.map((t, index) => (
                                    <tr key={index} className="border-b">
                                        <td className="p-2">{index + 1}</td><td className="p-2">{t.payee}</td>
                                        <td className="p-2">{t.receiver}</td><td className="p-2 text-right font-mono">{(t.totalAmount || 0).toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };
        // --- END: CashFlow Report Page ---

        // --- START: Personal CashFlow Management ---
        const PersonalCashFlowManagement = () => {
            const { personalCashflowStatements, appSettings } = useData();
            const { showNotification } = useNotification();
            const { addDoc, collection } = window.Firebase;
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const getInitialState = useCallback(() => ({
                date: getCambodiaISODate(),
                statementType: 'Deposit',
                currency: 'KHR',
                amount: '',
                purpose: '',
                note: ''
            }), []);

            const [formState, setFormState] = useState(getInitialState());

            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setFormState(prev => ({
                    ...prev,
                    [name]: value,
                    ...(name === 'statementType' && { flowType: value === 'Deposit' ? 'Inflow' : 'Outflow' })
                }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isMounted.current) return;
                setIsSubmitting(true);
                try {
                    await addDoc(collection(db, 'personalCashflowStatements'), {
                        ...formState,
                        amount: parseFormattedNumber(formState.amount),
                        createdAt: createTimestampFromDateAndCurrentTime(formState.date)
                    });
                    showNotification('Statement added successfully!', 'success');
                    if (isMounted.current) {
                        setFormState(getInitialState());
                    }
                } catch (error) {
                    showNotification('Failed to add statement.', 'error');
                } finally {
                    if (isMounted.current) {
                        setIsSubmitting(false);
                    }
                }
            };
            
            const historyWithBalance = useMemo(() => {
                let balanceKhr = 0;
                let balanceUsd = 0;
                const sorted = [...personalCashflowStatements].sort((a,b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                
                return sorted.map(statement => {
                    const amount = statement.amount || 0;
                    if(statement.statementType === 'Deposit'){
                        if(statement.currency === 'KHR') balanceKhr += amount;
                        else balanceUsd += amount;
                    } else { // Withdrawal
                        if(statement.currency === 'KHR') balanceKhr -= amount;
                        else balanceUsd -= amount;
                    }
                    const totalBalance = balanceKhr + (balanceUsd * (appSettings.exchangeRate || 4100));
                    return {...statement, balanceKhr, balanceUsd, totalBalance};
                });
            }, [personalCashflowStatements, appSettings.exchangeRate]);


            return (
                <div className="space-y-6">
                    <Card>
                        <h2 className="text-xl font-bold mb-4">New Statement</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <FormInput label="Date" type="date" name="date" value={formState.date} onChange={handleFormChange} />
                                <FormSelect label="Statement Type" name="statementType" value={formState.statementType} onChange={handleFormChange} options={[{value: 'Deposit', label: 'Deposit'}, {value: 'Withdrawal', label: 'Withdrawal'}]} />
                                <FormInput label="Flow Type" name="flowType" value={formState.statementType === 'Deposit' ? 'Inflow' : 'Outflow'} disabled />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <FormSelect label="Currency" name="currency" value={formState.currency} onChange={handleFormChange} options={[{value: 'KHR', label: 'KHR'}, {value: 'USD', label: 'USD'}]} />
                                <LiveFormatInput label="Amount" name="amount" value={formState.amount} onChange={handleFormChange} />
                                <FormInput label="Purpose" name="purpose" value={formState.purpose} onChange={handleFormChange} />
                            </div>
                            <FormTextarea label="Note" name="note" value={formState.note} onChange={handleFormChange} />
                            <div className="flex justify-end">
                                <Button type="submit" disabled={isSubmitting} icon={isSubmitting ? "LoaderCircle" : null}>
                                    {isSubmitting ? 'Adding...' : 'Add Statement'}
                                </Button>
                            </div>
                        </form>
                    </Card>
                    <Card>
                        <h2 className="text-xl font-bold mb-4">Cashflow Statement History</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-2 text-left">Date</th>
                                        <th className="p-2 text-left">Purpose</th>
                                        <th className="p-2 text-left">Statement Type</th>
                                        <th className="p-2 text-left">Flow Type</th>
                                        <th className="p-2 text-right">Balance KHR</th>
                                        <th className="p-2 text-right">Balance USD</th>
                                        <th className="p-2 text-right">Balance (៛)</th>
                                        <th className="p-2 text-left">Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {historyWithBalance.map(item => (
                                        <tr key={item.id} className="border-b">
                                            <td className="p-2">{formatInCambodiaDateOnly(item.createdAt)}</td>
                                            <td className="p-2">{item.purpose}</td>
                                            <td className="p-2">{item.statementType}</td>
                                            <td className="p-2">{item.flowType}</td>
                                            <td className="p-2 text-right font-mono">{item.balanceKhr.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono">{item.balanceUsd.toLocaleString()}</td>
                                            <td className="p-2 text-right font-mono font-bold">{item.totalBalance.toLocaleString()}</td>
                                            <td className="p-2">{item.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            )
        }
        // --- END: Personal CashFlow Management ---
        // --- START: Settings Page ---
        const SettingsPage = () => {
            const [activeTab, setActiveTab] = useState('shops');

            const TabButton = ({ tabName, label, icon, isActive, onClick }) => (
                <button onClick={() => onClick(tabName)} className={`flex items-center gap-2 px-3 py-2 text-sm sm:px-4 sm:py-2 font-semibold rounded-t-lg ${isActive ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );

            return (
                <div className="space-y-6">
                    <PageHeader title="Settings" subtitle="Configure application settings and manage data." />
                    <div className="border-b border-gray-200 flex space-x-1 sm:space-x-2 flex-wrap">
                        <TabButton tabName="shops" label="Shops" icon="Landmark" isActive={activeTab === 'shops'} onClick={setActiveTab} />
                        <TabButton tabName="employees" label="Employees" icon="Users" isActive={activeTab === 'employees'} onClick={setActiveTab} />
                        <TabButton tabName="expenses" label="Categories" icon="List" isActive={activeTab === 'expenses'} onClick={setActiveTab} />
                    </div>
                    <div className="mt-6">
                        <div className={activeTab === 'shops' ? '' : 'hidden'}><ManageShopsSection /></div>
                        <div className={activeTab === 'employees' ? '' : 'hidden'}><ManageEmployeesSection /></div>
                        <div className={activeTab === 'expenses' ? '' : 'hidden'}><ManageExpenseCategoriesSection /></div>
                    </div>
                </div>
            );
        };
        
        const SettingsSection = ({ children }) => (
            <Card className="mb-8">
                {children}
            </Card>
        );

        const ManageShopsSection = () => {
            const { shops, appSettings } = useData();
            const { showNotification } = useNotification();
            const { doc, updateDoc, deleteDoc } = window.Firebase;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingShop, setEditingShop] = useState(null);
            const [deletingShop, setDeletingShop] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [exchangeRate, setExchangeRate] = useState(appSettings.exchangeRate);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                setExchangeRate(appSettings.exchangeRate);
                return () => { isMounted.current = false; };
            }, [appSettings.exchangeRate]);

            const openModal = (shop = null) => {
                setEditingShop(shop || { name: '', address: '', phone: '', gca: 0, saleMargin: 0, shareholders: [{id: crypto.randomUUID(), name: '', percentage: 100}] });
                setIsModalOpen(true);
            };

            const handleDeleteShop = async () => {
                if (!deletingShop) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "shops", deletingShop.id));
                    showNotification("Shop deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete shop.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingShop(null);
                        setIsDeleting(false);
                    }
                }
            };
            
            const handleSaveExchangeRate = async () => {
                try {
                    await updateDoc(doc(window.db, "settings", "app"), { exchangeRate: parseFloat(exchangeRate) });
                    showNotification("Exchange rate saved!", "success");
                } catch (error) {
                    showNotification("Failed to save exchange rate.", "error");
                }
            };
            
            return (
                <div>
                    <SettingsSection>
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Exchange Rate</h2>
                        <div className="flex items-end gap-4">
                            <div className="flex-grow">
                                <FormInput label="USD to KHR Exchange Rate" type="number" value={exchangeRate || ''} onChange={(e) => setExchangeRate(e.target.value)} />
                            </div>
                            <Button onClick={handleSaveExchangeRate}>Save</Button>
                        </div>
                    </SettingsSection>
                    
                    <SettingsSection>
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-xl font-bold text-slate-800">Shops & Ownership</h2>
                             <Button onClick={() => openModal()} icon="Plus">Add Shop</Button>
                         </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-100 text-xs text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3">Name</th>
                                        <th className="p-3">Shareholders</th>
                                        <th className="p-3 text-right">GCA (៛)</th>
                                        <th className="p-3 text-right">Sale Margin (%)</th>
                                        <th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm text-gray-600">
                                    {shops.map(shop => (
                                        <tr key={shop.id} className="border-b hover:bg-slate-100">
                                            <td className="p-3 font-semibold">{shop.name}</td>
                                            <td className="p-3">{(shop.shareholders || []).map(s => `${s.name} (${s.percentage}%)`).join(', ') || 'N/A'}</td>
                                            <td className="p-3 text-right font-mono">{(shop.gca || 0).toLocaleString()}</td>
                                            <td className="p-3 text-right font-mono">{shop.saleMargin || 0}%</td>
                                            <td className="p-3 flex gap-1 justify-center">
                                                <Button variant="ghost" onClick={() => openModal(shop)}><Icon name="PenSquare"/></Button>
                                                <Button variant="ghost" onClick={() => setDeletingShop(shop)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </SettingsSection>
                    
                    {isModalOpen && <ShopEditModal shop={editingShop} onClose={() => setIsModalOpen(false)} />}
                    {deletingShop && <DeleteConfirmationModal title="Delete Shop" message={`Delete ${deletingShop.name}?`} onConfirm={handleDeleteShop} onClose={() => setDeletingShop(null)} isDeleting={isDeleting} />}
                </div>
            );
        };

        const ShopEditModal = ({ shop, onClose }) => {
            const { showNotification } = useNotification();
            const { doc, updateDoc, addDoc, collection } = window.Firebase;
            const [formData, setFormData] = useState({
                name: '', address: '', phone: '', gca: 0, saleMargin: 0, shareholders: [],
                ...shop
            });
            const [isUpdating, setIsUpdating] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);
            
            const shareholderTotal = useMemo(() => (formData.shareholders || []).reduce((sum, s) => sum + (parseFloat(String(s.percentage)) || 0), 0), [formData.shareholders]);
            const isTotalValid = shareholderTotal === 100;

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleShareholderChange = (id, field, value) => setFormData(prev => ({ ...prev, shareholders: (prev.shareholders || []).map(s => s.id === id ? { ...s, [field]: value } : s) }));
            const addShareholder = () => setFormData(prev => ({ ...prev, shareholders: [...(prev.shareholders || []), {id: crypto.randomUUID(), name: '', percentage: 0}] }));
            const removeShareholder = (id) => setFormData(prev => ({ ...prev, shareholders: (prev.shareholders || []).filter(s => s.id !== id) }));

            const handleUpdate = async (e) => {
                e.preventDefault();
                if(!isTotalValid) {
                    showNotification("Shareholder percentages must total 100%.", "error");
                    return;
                }
                setIsUpdating(true);
                const dataToSave = {
                    ...formData,
                    gca: parseFloat(String(formData.gca)) || 0,
                    saleMargin: parseFloat(String(formData.saleMargin)) || 0,
                    shareholders: (formData.shareholders || []).map(s => ({...s, percentage: parseFloat(String(s.percentage)) || 0}))
                };
                delete dataToSave.id;

                try {
                    if (shop.id) {
                        await updateDoc(doc(window.db, "shops", shop.id), dataToSave);
                    } else {
                        await addDoc(collection(window.db, "shops"), dataToSave);
                    }
                    showNotification(`Shop ${shop.id ? 'updated' : 'added'}.`, "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    showNotification("Failed to save shop.", "error");
                } finally {
                    if (isMounted.current) setIsUpdating(false);
                }
            };

            return (
                <Modal title={shop.id ? 'Edit Shop' : 'Add Shop'} onClose={onClose} size="2xl">
                    <form onSubmit={handleUpdate} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormInput label="Shop Name" name="name" value={formData.name || ''} onChange={handleChange} required />
                            <FormInput label="Sale Margin (%)" name="saleMargin" type="number" value={formData.saleMargin || ''} onChange={handleChange} />
                            <FormInput label="GCA (៛)" name="gca" type="number" value={formData.gca || ''} onChange={handleChange} />
                        </div>
                        <div className="pt-4 border-t">
                            <div className="flex justify-between items-center mb-2"><h4 className="text-lg font-semibold">Shareholders</h4><Button type="button" onClick={addShareholder} variant="secondary" icon="Plus">Add</Button></div>
                             {(formData.shareholders || []).map((s, i) => (
                                <div key={s.id} className="grid grid-cols-12 gap-2 items-center mb-2">
                                    <div className="col-span-6"><FormInput label={i === 0 ? "Owner Name" : ""} name={`name-${s.id}`} value={s.name || ''} onChange={e => handleShareholderChange(s.id, 'name', e.target.value)} /></div>
                                    <div className="col-span-4"><FormInput label={i === 0 ? "%" : ""} name={`p-${s.id}`} type="number" value={s.percentage || ''} onChange={e => handleShareholderChange(s.id, 'percentage', e.target.value)} /></div>
                                    <div className="col-span-2 pt-5"><Button type="button" variant="ghost" onClick={() => removeShareholder(s.id)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button></div>
                                </div>
                             ))}
                             <div className={`mt-2 p-2 text-center rounded-md font-bold ${isTotalValid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>Total: {shareholderTotal}%</div>
                        </div>
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isUpdating || !isTotalValid} className="w-24" icon={isUpdating ? "LoaderCircle" : null}>
                                {isUpdating ? '' : "Save"}
                            </Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const ManageEmployeesSection = () => {
            const { staffList } = useData();
            const { showNotification } = useNotification();
            const { doc, deleteDoc } = window.Firebase;
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [deletingEmployee, setDeletingEmployee] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const openForm = (employee = null) => {
                setEditingEmployee(employee);
                setIsFormOpen(true);
            };

            const handleDelete = async () => {
                if (!deletingEmployee) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, "employees", deletingEmployee.id));
                    showNotification("Employee deleted.", "success");
                } catch(e) {
                     showNotification("Failed to delete employee.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingEmployee(null);
                        setIsDeleting(false);
                    }
                }
            };

            return (
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-slate-700">Employee Management</h2>
                         <Button onClick={() => openForm()} icon="Plus">New Employee</Button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th className="p-3">Name</th><th className="p-3">Position</th><th className="p-3">Email</th><th className="p-3">Role</th><th className="p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="text-sm text-gray-600">
                                {staffList.map(staff => (
                                    <tr key={staff.id} className="border-b hover:bg-slate-100">
                                        <td className="p-3 font-semibold">{staff.name}</td>
                                        <td className="p-3">{staff.position}</td>
                                        <td className="p-3">{staff.email}</td>
                                        <td className="p-3"><span className={`px-2 py-1 text-xs rounded-full ${staff.role === 'Admin' ? 'bg-red-100 text-red-800' : staff.role === 'Management' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>{staff.role}</span></td>
                                        <td className="p-3 flex gap-1 justify-center">
                                            <Button variant="ghost" onClick={() => openForm(staff)}><Icon name="PenSquare"/></Button>
                                            <Button variant="ghost" onClick={() => setDeletingEmployee(staff)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                     </div>
                     {isFormOpen && <EmployeeFormModal employee={editingEmployee} onClose={() => setIsFormOpen(false)} />}
                     {deletingEmployee && <DeleteConfirmationModal title="Delete Employee" message={`Delete ${deletingEmployee.name}?`} onConfirm={handleDelete} onClose={() => setDeletingEmployee(null)} isDeleting={isDeleting} />}
                </Card>
            );
        };

        const EmployeeFormModal = ({ employee, onClose }) => {
            const { shops } = useData();
            const { showNotification } = useNotification();
            const { setDoc, doc } = window.Firebase;
            const [formData, setFormData] = useState({
                name: '', phone: '', position: '', shopIds: [], accessiblePages: [], role: 'Cashier', email: '', uid: '',
                ...employee
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleShopIdChange = (shopId, isChecked) => setFormData(prev => ({ ...prev, shopIds: isChecked ? [...(prev.shopIds || []), shopId] : (prev.shopIds || []).filter(id => id !== shopId) }));
            const handleAllShopsChange = (isChecked) => setFormData(prev => ({...prev, shopIds: isChecked ? shops.map(s => s.id) : [] }));
            const handlePageAccessChange = (pageId, isChecked) => setFormData(prev => ({ ...prev, accessiblePages: isChecked ? [...(prev.accessiblePages || []), pageId] : (prev.accessiblePages || []).filter(id => id !== pageId) }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const { id, ...employeeData } = formData;
                try {
                    if (!employeeData.uid) {
                        showNotification("Firebase UID is required to create or update an employee.", "error");
                        setIsSubmitting(false);
                        return;
                    }
                    await setDoc(doc(window.db, "employees", employeeData.uid), employeeData);
                    showNotification(`Employee ${employee ? 'updated' : 'created'}.`, "success");
                    if (isMounted.current) onClose();
                } catch (error) {
                    console.error("Error saving employee:", error);
                    showNotification('Failed to save employee', 'error');
                } finally {
                    if (isMounted.current) setIsSubmitting(false);
                }
            };
            
            const allShopsSelected = formData.shopIds?.length === shops.length && shops.length > 0;

            return (
                 <Modal title={employee ? 'Edit Employee' : 'New Employee'} onClose={onClose} size="4xl">
                    <form onSubmit={handleSubmit} className="space-y-6">
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="space-y-4 md:col-span-1">
                                <FormInput label="Full Name" name="name" value={formData.name || ''} onChange={handleChange} required />
                                <FormInput label="Position" name="position" value={formData.position || ''} onChange={handleChange} />
                                <FormInput label="Email" name="email" type="email" value={formData.email || ''} onChange={handleChange} />
                                <FormInput label="Firebase UID" name="uid" value={formData.uid || ''} onChange={handleChange} required disabled={!!employee} />
                                <FormSelect label="Role" name="role" value={formData.role || 'Cashier'} onChange={handleChange} options={[{value: 'Admin', label: 'Admin'}, {value: 'Management', label: 'Management'}, {value: 'Cashier', label: 'Cashier'}]} />
                            </div>
                             <div className="space-y-4 md:col-span-1">
                                 <label className="block text-sm font-medium text-gray-700">Assigned Shops</label>
                                 <div className="bg-white p-3 rounded-lg max-h-60 overflow-y-auto border">
                                    <div className="flex items-center border-b pb-2 mb-2"><input type="checkbox" id="all-shops" checked={allShopsSelected} onChange={e => handleAllShopsChange(e.target.checked)} className="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500" /><label htmlFor="all-shops" className="ml-3 font-bold">All Shops</label></div>
                                    {shops.map(shop => (<div key={shop.id} className="flex items-center mt-1"><input id={`s-${shop.id}`} type="checkbox" checked={formData.shopIds?.includes(shop.id)} onChange={e => handleShopIdChange(shop.id, e.target.checked)} className="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500" /><label htmlFor={`s-${shop.id}`} className="ml-3">{shop.name}</label></div>))}
                                 </div>
                             </div>
                             <div className="space-y-4 md:col-span-1">
                                <label className="block text-sm font-medium text-gray-700">Page Permissions</label>
                                <div className="bg-white p-3 rounded-lg max-h-60 overflow-y-auto border">
                                    {CONSTANTS.ALL_PAGES.map(page => (<div key={page.id} className="flex items-center mt-1"><input id={`p-${page.id}`} type="checkbox" checked={formData.accessiblePages?.includes(page.id)} onChange={e => handlePageAccessChange(page.id, e.target.checked)} className="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500" /><label htmlFor={`p-${page.id}`} className="ml-3">{page.label}</label></div>))}
                                </div>
                             </div>
                         </div>
                         <div className="flex justify-end gap-4 pt-4 border-t">
                            <Button type="button" onClick={onClose} variant="secondary">Cancel</Button>
                            <Button type="submit" disabled={isSubmitting} className="w-24" icon={isSubmitting ? "LoaderCircle" : null}>{isSubmitting ? '' : "Save"}</Button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const ManageExpenseCategoriesSection = () => {
            const { businessCategories, familyCategories } = useData();
            return(
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <CategoryManager title="Business Expenses" icon="CreditCard" categories={businessCategories} collectionPath="businessExpenseCategories" />
                    <CategoryManager title="Family Expenses" icon="Users" categories={familyCategories} collectionPath="familyExpenseCategories" />
                </div>
            )
        };

        const CategoryManager = ({ title, icon, categories, collectionPath }) => {
            const { showNotification } = useNotification();
            const { doc, addDoc, deleteDoc, collection } = window.Firebase;
            const [newCategoryName, setNewCategoryName] = useState('');
            const [deletingCategory, setDeletingCategory] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleAddCategory = async (e) => {
                e.preventDefault();
                if (!newCategoryName.trim()) return;
                try {
                    await addDoc(collection(window.db, collectionPath), { name: newCategoryName.trim() });
                    if(isMounted.current) setNewCategoryName('');
                    showNotification("Category added.", "success");
                } catch (error) {
                    showNotification("Failed to add category.", "error");
                }
            };

            const handleDeleteCategory = async () => {
                if (!deletingCategory) return;
                setIsDeleting(true);
                try {
                    await deleteDoc(doc(window.db, collectionPath, deletingCategory.id));
                    showNotification("Category deleted.", "success");
                } catch (error) {
                    showNotification("Failed to delete category.", "error");
                } finally {
                    if (isMounted.current) {
                        setDeletingCategory(null);
                        setIsDeleting(false);
                    }
                }
            };

            return (
                <Card>
                    <h2 className="flex gap-2 items-center mb-4 text-xl font-bold text-slate-700"><Icon name={icon}/>{title}</h2>
                    <form onSubmit={handleAddCategory} className="flex gap-4 mb-4">
                        <FormInput value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="New category name..." />
                        <Button type="submit" icon="Plus">Add</Button>
                    </form>
                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {categories.map(cat => (
                            <div key={cat.id} className="flex justify-between items-center p-2 rounded-md hover:bg-slate-50">
                                <span>{cat.name}</span>
                                <Button variant="ghost" onClick={() => setDeletingCategory(cat)} className="text-red-500 hover:bg-red-100"><Icon name="Trash2"/></Button>
                            </div>
                        ))}
                    </div>
                     {deletingCategory && <DeleteConfirmationModal title="Delete Category" message={`Delete "${deletingCategory.name}"?`} onConfirm={handleDeleteCategory} onClose={() => setDeletingCategory(null)} isDeleting={isDeleting} />}
                </Card>
            );
        };
        // --- END: Settings Page ---
        
        // #endregion

        // =================================================================================
        // #region 5. MAIN APP & AUTHENTICATION (Refactored)
        // =================================================================================
        const PageContent = ({ activePage, getDefaultPage }) => {
            const pages = {
                cashDrop: CashDropPage,
                saleReport: SaleReportPage,
                purchaseOrder: PurchaseOrderPage,
                expenseReport: ExpenseReportPage,
                cashflowReport: CashFlowReportPage,
                settings: SettingsPage,
            };
            const Component = pages[activePage] || pages[getDefaultPage()];
            return <Component />;
        };

         const LoginPage = () => {
            const { signInWithEmailAndPassword } = window.Firebase;
            const { showNotification } = useNotification();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    await signInWithEmailAndPassword(window.auth, email, password);
                } catch (err) {
                    showNotification('Login failed. Please check your credentials.', 'error');
                } finally {
                    if (isMounted.current) setIsLoading(false);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-full bg-gray-100 px-4 py-12 sm:px-6 lg:px-8">
                    <div className="w-full max-w-md space-y-8">
                        <div>
                            <Icon name="Landmark" className="mx-auto h-12 w-auto text-indigo-600" />
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your Account</h2>
                            <p className="mt-2 text-center text-sm text-red-600 font-semibold">
                                This application is used for Internal Management ONLY!
                            </p>
                        </div>
                        <form onSubmit={handleLogin} className="mt-8 space-y-6">
                            <div className="rounded-md shadow-sm space-y-4">
                                <FormInput label="Email address" name="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required placeholder="Email address" />
                                <div>
                                    <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1.5">Password</label>
                                    <div className="relative">
                                        <input
                                            id="password"
                                            name="password"
                                            type={showPassword ? 'text' : 'password'}
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                            className="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm"
                                            placeholder="Password"
                                        />
                                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                                            <Icon name={showPassword ? 'EyeOff' : 'Eye'} />
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between">
                                <div className="flex items-center">
                                    <input id="remember-me" name="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                                    <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">Remember me</label>
                                </div>
                            </div>

                            <div>
                                <Button type="submit" disabled={isLoading} className="w-full" icon={isLoading ? "LoaderCircle" : null}>
                                    {isLoading ? 'Signing in...' : 'Sign in'}
                                </Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AppLayout = () => {
            const { userData } = useData();
            const { signOut } = window.Firebase;
            const { showNotification } = useNotification();
            
            const getDefaultPage = useCallback(() => {
                return (userData?.accessiblePages && userData.accessiblePages.length > 0) ? userData.accessiblePages[0] : 'cashflowReport';
            }, [userData]);

            const [activePage, setActivePage] = useState(getDefaultPage());
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isProfileMenuOpen, setProfileMenuOpen] = useState(false);
            const profileMenuRef = useRef(null);

            useEffect(() => {
                if (userData?.accessiblePages && !userData.accessiblePages.includes(activePage)) {
                    setActivePage(getDefaultPage());
                }
            }, [userData, activePage, getDefaultPage]);
            
            // Close profile menu on outside click
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (profileMenuRef.current && !profileMenuRef.current.contains(event.target)) {
                        setProfileMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleLogout = async () => {
                await signOut(window.auth);
                showNotification("You have been logged out.", "info");
            };

            const NavLink = ({ item, isActive }) => {
                 if (!userData?.accessiblePages?.includes(item.id)) return null;
                return (
                    <a href="#" onClick={(e) => { e.preventDefault(); setActivePage(item.id); setIsSidebarOpen(false); }}
                        className={`flex items-center w-full px-3 py-2.5 text-sm font-medium rounded-lg transition-colors group ${ isActive ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900' }`}>
                        <Icon name={item.icon} className={`mr-3 h-5 w-5 ${isActive ? 'text-white' : 'text-gray-400 group-hover:text-gray-500'}`} />
                        <span>{item.label}</span>
                    </a>
                );
            }

            return (
                <div className="flex h-full">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-300 ease-in-out`}>
                        <div className="flex items-center justify-center p-4 h-16 border-b">
                             <Icon name="Landmark" className="mx-auto h-12 w-auto text-indigo-600" />
                             <h2 className="ml-2 text-xl font-bold text-gray-800">Cash Flow Mgr</h2>
                        </div>
                        <nav className="flex-grow p-4 space-y-1">
                            {CONSTANTS.NAV_ITEMS.map(item => <NavLink key={item.id} item={item} isActive={activePage === item.id} />)}
                        </nav>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        {/* Topbar */}
                        <header className="relative z-10 flex-shrink-0 flex h-16 bg-white shadow-sm border-b border-gray-200">
                             <button onClick={() => setIsSidebarOpen(true)} className="px-4 border-r border-gray-200 text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 md:hidden">
                                <Icon name="Menu" className="h-6 w-6" />
                            </button>
                            <div className="flex-1 px-4 flex justify-end">
                                <div className="ml-4 flex items-center md:ml-6">
                                    <div className="ml-3 relative" ref={profileMenuRef}>
                                        <div>
                                            <button onClick={() => setProfileMenuOpen(o => !o)} className="max-w-xs bg-white flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                <img className="h-8 w-8 rounded-full" src={userData?.avatarUrl || `https://ui-avatars.com/api/?name=${userData?.name}&background=4f46e5&color=fff`} alt="" />
                                            </button>
                                        </div>
                                        {isProfileMenuOpen && (
                                            <div className="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                                                <div className="px-4 py-2 border-b">
                                                    <p className="text-sm font-semibold text-gray-800">{userData?.name}</p>
                                                    <p className="text-xs text-gray-500 truncate">{userData?.email}</p>
                                                </div>
                                                <a href="#" onClick={handleLogout} className="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Sign out</a>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 overflow-y-auto bg-gray-100">
                            <div className="py-6">
                                <div className="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                                    <PageContent activePage={activePage} getDefaultPage={getDefaultPage} />
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        };
        // #endregion

        // =================================================================================
        // #region 6. APP ENTRY POINT
        // =================================================================================
        const App = () => {
            const { user, isLoading, userData } = useData();

            if (isLoading) {
                return <div className="flex items-center justify-center h-screen bg-gray-100"><Icon name="LoaderCircle" size={48} className="animate-spin text-indigo-600" /></div>;
            }

            if (!user || !userData) {
                return <LoginPage />;
            }
            
            return <AppLayout />;
        }

        ReactDOM.render(
            <NotificationProvider>
                <DataProvider>
                    <App />
                </DataProvider>
            </NotificationProvider>, 
            document.getElementById('root')
        );
        // #endregion
    </script>

</body>
</html>
